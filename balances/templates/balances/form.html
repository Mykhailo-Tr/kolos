{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h3 class="mb-3">
    {% if view.object %}
      ‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∑–∞–ª–∏—à–∫—É: {{ view.object }}
    {% else %}
      ‚ûï –ù–æ–≤–∏–π –∑–∞–ø–∏—Å –∑–∞–ª–∏—à–∫—É
    {% endif %}
  </h3>
  <form method="post" novalidate>
    {% csrf_token %}

    {% if form.non_field_errors %}
      {% endif %}

    <div class="row g-3">
      {% for field in form.visible_fields %}
        {% if field.name != 'quantity' and field.name != 'unit' %}
          <div class="col-md-6">
            <div class="mb-3">
              <label for="{{ field.id_for_label }}" class="form-label fw-semibold">
                {{ field.label }}
              </label>
              {{ field }}
              {% if field.help_text %}
                <div class="form-text">{{ field.help_text }}</div>
              {% endif %}
              {% for error in field.errors %}
                <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            </div>
          </div>
        {% endif %}
      {% endfor %}

      {% with quantity_field=form.quantity unit_field=form.unit %}
        {% if quantity_field and unit_field %}
          <div class="col-md-6">
            <div class="mb-3">
              <label for="{{ quantity_field.id_for_label }}" class="form-label fw-semibold">
                {{ quantity_field.label }} ({{ unit_field.value }})
                <span id="quantity_unit_label"></span> </label>
              <div class="input-group">
                {{ quantity_field }}
                <span class="input-group-text p-0">
                  {{ unit_field }}
                </span>
              </div>
              
              <div id="converted_value" class="form-text mt-1"></div>
              
              {% if quantity_field.help_text %}
                <div class="form-text">{{ quantity_field.help_text }}</div>
              {% endif %}
              {% for error in quantity_field.errors %}
                <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            </div>
          </div>
        {% endif %}
      {% endwith %}
      
      </div>

    <div class="mt-4 d-flex gap-2">
      <button type="submit" class="btn btn-primary">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
      <a href="{% url 'balance_list' %}" class="btn btn-secondary">‚¨Ö –ù–∞–∑–∞–¥</a>
    </div>
  </form>
</div>

<script>
    // JS –¥–ª—è –º–∏—Ç—Ç—î–≤–æ–≥–æ –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –æ–¥–∏–Ω–∏—Ü—å —Ç–∞ –≤—ñ–∑—É–∞–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è (UX)
    document.addEventListener('DOMContentLoaded', function() {
        // –ó–º—ñ–Ω–µ–Ω–æ —Å–µ–ª–µ–∫—Ç–æ—Ä–∏ –¥–ª—è —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ –∑ –≤–∞—à–∏–º–∏ —Ñ–æ—Ä–º–∞–º–∏, –¥–µ –º–æ–∂–µ –±—É—Ç–∏ –∫—ñ–ª—å–∫–∞ –ø–æ–ª—ñ–≤
        // –ü—Ä–∏–ø—É—Å–∫–∞—î–º–æ, —â–æ —Ü–µ –¥–ª—è —Ñ–æ—Ä–º–∏ –∑ –æ–¥–Ω–∏–º –ø–æ–ª–µ–º 'quantity' —Ç–∞ –ø–µ—Ä–µ–º–∏–∫–∞—á–µ–º
        const quantityInput = document.querySelector('.quantity-input');
        const unitSwitcher = document.querySelector('.unit-switcher');
        const convertedValueDisplay = document.getElementById('converted_value');
        const quantityLabel = document.querySelector('label[for="' + quantityInput.id + '"]');

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è —á–∏—Å–ª–∞:
        // - –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î 'uk-UA' –¥–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–∏—Ö —Ä–æ–∑–¥—ñ–ª—å–Ω–∏–∫—ñ–≤.
        // - –Ø–∫—â–æ —á–∏—Å–ª–æ —Ü—ñ–ª–µ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 500.000), –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î –±–µ–∑ –¥—Ä–æ–±–æ–≤–æ—ó —á–∞—Å—Ç–∏–Ω–∏ (500).
        // - –Ø–∫—â–æ —á–∏—Å–ª–æ –¥—Ä–æ–±–æ–≤–µ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 500.123), –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î –∑ —Ç—Ä—å–æ–º–∞ –∑–Ω–∞–∫–∞–º–∏ (500,123).
        const formatNumber = (num) => {
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —î —á–∏—Å–ª–æ —Ü—ñ–ª–∏–º
            if (num === Math.floor(num)) {
                // –Ø–∫—â–æ —Ü—ñ–ª–µ: –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ 0 –¥—Ä–æ–±—ñ–≤, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ 0 –¥—Ä–æ–±—ñ–≤
                return num.toLocaleString('uk-UA', { 
                    minimumFractionDigits: 0, 
                    maximumFractionDigits: 0 
                });
            } else {
                // –Ø–∫—â–æ –¥—Ä–æ–±–æ–≤–µ: –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ 3 –¥—Ä–æ–±–∏, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ 3 –¥—Ä–æ–±–∏
                return num.toLocaleString('uk-UA', { 
                    minimumFractionDigits: 3, 
                    maximumFractionDigits: 3 
                });
            }
        };

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
        const updateDisplay = () => {
            // –ó–∞–º—ñ–Ω—é—î–º–æ –∫–æ–º—É –Ω–∞ –∫—Ä–∞–ø–∫—É –¥–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥—É
            const rawValue = quantityInput.value.replace(/,/g, '.');
            const value = parseFloat(rawValue) || 0;
            const unit = unitSwitcher.value;
            let displayHTML = '';

            // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–ø–∏—Å—É –ø–æ–ª—è
            // (–ó–∞–ª–∏—à–∞—î–º–æ —Ü—é –ª–æ–≥—ñ–∫—É, —Ö–æ—á–∞ –≤–æ–Ω–∞ –º–æ–∂–µ –±—É—Ç–∏ –±—ñ–ª—å—à —Å—Ç—ñ–π–∫–æ—é, —è–∫—â–æ –º—ñ—Ç–∫–∞ –º—ñ—Å—Ç–∏—Ç—å 
            // –ª–∏—à–µ —Ç–µ–∫—Å—Ç, –∞ –æ–¥–∏–Ω–∏—Ü—è - –æ–∫—Ä–µ–º–∏–π <span>)
            let currentLabelText = quantityLabel.textContent;
            if (unit === 't') {
                 // –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä—É –æ–¥–∏–Ω–∏—Ü—é —ñ –¥–æ–¥–∞—î–º–æ –Ω–æ–≤—É, –Ω–µ —á—ñ–ø–∞—é—á–∏ —Ä–µ—à—Ç—É —Ç–µ–∫—Å—Ç—É
                 quantityLabel.innerHTML = currentLabelText.replace(/\(.*\)/, '(—Ç)');
            } else if (unit === 'kg') {
                 quantityLabel.innerHTML = currentLabelText.replace(/\(.*\)/, '(–∫–≥)');
            }

            if (!isNaN(value) && value > 0) {
                if (unit === 't') {
                    // –Ø–∫—â–æ –≤–≤–µ–¥–µ–Ω–æ —Ç–æ–Ω–Ω–∏, –ø–æ–∫–∞–∑—É—î–º–æ —Å–∫—ñ–ª—å–∫–∏ —Ü–µ –∫—ñ–ª–æ–≥—Ä–∞–º—ñ–≤ (kg - —Ü—ñ–ª–µ —á–∏—Å–ª–æ)
                    const kgValue = value * 1000;
                    displayHTML = `–¶–µ –ø—Ä–∏–±–ª–∏–∑–Ω–æ <strong>${formatNumber(kgValue)} –∫–≥</strong>.`;
                } else if (unit === 'kg') {
                    // –Ø–∫—â–æ –≤–≤–µ–¥–µ–Ω–æ –∫—ñ–ª–æ–≥—Ä–∞–º–∏, –ø–æ–∫–∞–∑—É—î–º–æ —Å–∫—ñ–ª—å–∫–∏ —Ü–µ —Ç–æ–Ω–Ω (t - –º–æ–∂–µ –±—É—Ç–∏ –¥—Ä–æ–±–æ–≤–µ)
                    const tValue = value / 1000;
                    // –î–ª—è —Ç–æ–Ω–Ω –∑–∞–≤–∂–¥–∏ –±–∞–∂–∞–Ω–æ –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ 3 –∑–Ω–∞–∫–∏, —â–æ–± –Ω–µ –≤—Ç—Ä–∞—Ç–∏—Ç–∏ —Ç–æ—á–Ω—ñ—Å—Ç—å,
                    // –∞–ª–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—î–º–æ —É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π formatNumber –¥–ª—è —á–∏—Å—Ç–æ—Ç–∏.
                    displayHTML = `–¶–µ –ø—Ä–∏–±–ª–∏–∑–Ω–æ <strong>${formatNumber(tValue)} —Ç</strong>.`; 
                }
            } else {
                // –Ø–∫—â–æ –∑–Ω–∞—á–µ–Ω–Ω—è 0 –∞–±–æ –Ω–µ —á–∏—Å–ª–æ
                displayHTML = '–í–≤–µ–¥—ñ—Ç—å —á–∏—Å–ª–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è.';
            }

            convertedValueDisplay.innerHTML = displayHTML;
        };

        // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø–æ—á–∞—Ç–∫–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è –º—ñ—Ç–∫–∏
        updateDisplay(); 

        // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π
        if (quantityInput) {
            // –¢–∞–∫–æ–∂ –¥–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–∫—É –∑–∞–º—ñ–Ω–∏ –∫–æ–º–∏ –Ω–∞ –∫—Ä–∞–ø–∫—É, —â–æ–± –ø–∞—Ä—Å–∏–Ω–≥ –±—É–≤ –∫–æ—Ä–µ–∫—Ç–Ω–∏–º
            quantityInput.addEventListener('input', updateDisplay);
        }
        if (unitSwitcher) {
            unitSwitcher.addEventListener('change', updateDisplay);
        }
    });
</script>
{% endblock %}