{% extends "base.html" %}
{% load humanize %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/balance_list.css' %}">

<div class="container mt-4">
  {# –í–ò–ü–†–ê–í–õ–ï–ù–û: –†–æ–∑–¥—ñ–ª–µ–Ω–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞ –¥—ñ—ó —É –¥–≤–∞ –±–ª–æ–∫–∏, –≤–∏—Ä—ñ–≤–Ω—è–Ω—ñ –ø–æ –∫—Ä–∞—è—Ö #}
  <div class="d-flex justify-content-between align-items-center mb-3">
    
    {# –ë–õ–û–ö –ó–ê–ì–û–õ–û–í–ö–ê (–õ–Ü–í–û–†–£–ß) #}
    <div class="page-header">
      <h2 class="page-title">
        <span class="page-title-icon">üì¶</span>
        {{ model_name|default:"–ó–∞–ª–∏—à–∫–∏" }}
      </h2>
    </div>

    {# –ë–õ–û–ö –î–Ü–ô –¢–ê –ü–ï–†–ï–ú–ò–ö–ê–ß–ê (–ü–†–ê–í–û–†–£–ß) #}
    <div class="header-actions d-flex align-items-center">
        <a href="{% url 'balance_create' %}" class="btn-add-new me-3">
          <span>‚ûï</span>
          <span>–î–æ–¥–∞—Ç–∏ –∑–∞–ø–∏—Å</span>
        </a>

        {# –°–ï–ì–ú–ï–ù–¢–û–í–ê–ù–ò–ô –ü–ï–†–ï–ú–ò–ö–ê–ß –û–î–ò–ù–ò–¶–¨ #}
        <div class="unit-switch" id="unitSwitchContainer">
            <div class="segmented-control">
                <input type="checkbox" id="unitToggleBalance" class="toggle-input">
                
                <label for="unitToggleBalance" class="control-item active" data-unit="t" id="labelTBalance">—Ç</label>
                <label for="unitToggleBalance" class="control-item" data-unit="kg" id="labelKGBalance">–∫–≥</label>

                <span class="toggle-slider"></span>
            </div>
        </div>
        {# –ö–Ü–ù–ï–¶–¨ –ü–ï–†–ï–ú–ò–ö–ê–ß–ê #}
    </div>
  </div>

  <div class="stats-mini-bar">
    <div class="mini-stat-item">
      <div class="mini-stat-label">–ó–∞–≥–∞–ª—å–Ω–∞ –≤–∞–≥–∞</div>
      <div class="mini-stat-value" id="grandTotal" data-t="0">-<span class="mini-stat-suffix">—Ç</span></div>
    </div>
    <div class="mini-stat-item">
      <div class="mini-stat-label" style="color: #10b981;">–ó–µ—Ä–Ω–æ–≤–∞ –≥—Ä—É–ø–∞</div>
      <div class="mini-stat-value" id="totalGrain" data-t="0">-<span class="mini-stat-suffix">—Ç</span></div>
    </div>
    <div class="mini-stat-item">
      <div class="mini-stat-label" style="color: #f59e0b;">–í—ñ–¥—Ö–æ–¥–∏</div>
      <div class="mini-stat-value" id="totalWaste" data-t="0">-<span class="mini-stat-suffix">—Ç</span></div>
    </div>
  </div>

  {% if balances %}
    <div class="table-container">
      <div class="table-responsive">
        <table class="table professional-table table-hover table-striped">
          <thead class="text-center">
            <tr>
              {% with request.GET.order as current_order %}
              <th class="row-number">#</th>
              <th class="text-start">
                <a href="?order={% if current_order == 'place__name' %}-place__name{% else %}place__name{% endif %}" class="sort-link">
                  <span>–ú—ñ—Å—Ü–µ</span>
                  <span class="sort-icon">
                    {% if current_order == 'place__name' %}‚ñ≤{% elif current_order == '-place__name' %}‚ñº{% else %}‚áÖ{% endif %}
                  </span>
                </a>
              </th>
              <th class="text-start">
                <a href="?order={% if current_order == 'culture__name' %}-culture__name{% else %}culture__name{% endif %}" class="sort-link">
                  <span>–ö—É–ª—å—Ç—É—Ä–∞</span>
                  <span class="sort-icon">
                    {% if current_order == 'culture__name' %}‚ñ≤{% elif current_order == '-culture__name' %}‚ñº{% else %}‚áÖ{% endif %}
                  </span>
                </a>
              </th>
              <th>
                <a href="?order={% if current_order == 'balance_type' %}-balance_type{% else %}balance_type{% endif %}" class="sort-link">
                  <span>–¢–∏–ø</span>
                  <span class="sort-icon">
                    {% if current_order == 'balance_type' %}‚ñ≤{% elif current_order == '-balance_type' %}‚ñº{% else %}‚áÖ{% endif %}
                  </span>
                </a>
              </th>
              <th class="text-end" id="header-quantity-balance">
                <a href="?order={% if current_order == 'quantity' %}-quantity{% else %}quantity{% endif %}" class="sort-link">
                  <span>–ö—ñ–ª—å–∫—ñ—Å—Ç—å (—Ç)</span>
                  <span class="sort-icon">
                    {% if current_order == 'quantity' %}‚ñ≤{% elif current_order == '-quantity' %}‚ñº{% else %}‚áÖ{% endif %}
                  </span>
                </a>
              </th>
              <th>–î—ñ—ó</th>
              {% endwith %}
            </tr>
          </thead>
          <tbody>
            {% for b in balances %}
            <tr>
              <td class="text-center row-number">{{ forloop.counter0|add:page_obj.start_index }}</td>
              <td>{{ b.place.name }}</td>
              <td>{{ b.culture.name }}</td>
              <td class="text-center">
                <span class="balance-type-badge {% if '–∑–µ—Ä–Ω–æ' in b.get_balance_type_display|lower or 'grain' in b.get_balance_type_display|lower %}badge-grain{% elif '–≤—ñ–¥—Ö–æ–¥' in b.get_balance_type_display|lower or 'waste' in b.get_balance_type_display|lower %}badge-waste{% endif %}">
                  {{ b.get_balance_type_display }}
                </span>
              </td>
              <td class="text-end">
                <span class="quantity-value-balance" data-t="{{ b.quantity|stringformat:'f' }}">{{ b.quantity|floatformat:3 }}</span>
              </td>
              <td>
                <div class="action-buttons">
                  <a href="{% url 'balance_update' b.pk %}" class="btn-action btn-edit" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">‚úèÔ∏è</a>
                  <a href="{% url 'balance_delete' b.pk %}" class="btn-action btn-delete" title="–í–∏–¥–∞–ª–∏—Ç–∏">üóëÔ∏è</a>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    {% if is_paginated %}
    <nav aria-label="Page navigation" class="mt-3">
      <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.order %}&order={{ request.GET.order }}{% endif %}">‚Äπ</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">‚Äπ</span></li>
        {% endif %}

        {% for num in paginator.page_range %}
          {% if num == page_obj.number %}
            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
          {% else %}
            <li class="page-item"><a class="page-link" href="?page={{ num }}{% if request.GET.order %}&order={{ request.GET.order }}{% endif %}">{{ num }}</a></li>
          {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.order %}&order={{ request.GET.order }}{% endif %}">‚Ä∫</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">‚Ä∫</span></li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}

  {% else %}
    <div class="empty-state">
      <div class="empty-state-icon">üì¶</div>
      <h3 class="empty-state-title">–ó–∞–ø–∏—Å—ñ–≤ –ø–æ–∫–∏ —â–æ –Ω–µ–º–∞—î</h3>
      <p class="empty-state-text">–î–æ–¥–∞–π—Ç–µ –ø–µ—Ä—à–∏–π –∑–∞–ø–∏—Å —É –∂—É—Ä–Ω–∞–ª –∑–∞–ª–∏—à–∫—ñ–≤, —â–æ–± –ø–æ—á–∞—Ç–∏ —Ä–æ–±–æ—Ç—É</p>
    </div>
  {% endif %}

  </br>

  {% include "balances/dashboard.html" %}
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
  // –§–æ—Ä–º—É—î–º–æ –æ–±'—î–∫—Ç –¥–∞–Ω–∏—Ö —Ç—É—Ç, –±–æ –≤ –∑–æ–≤–Ω—ñ—à–Ω—å–æ–º—É JS —Ñ–∞–π–ª—ñ Django —Ç–µ–≥–∏ –Ω–µ –ø—Ä–∞—Ü—é—é—Ç—å
  const balancesData = [
    {% for b in balances %}
    {
      place: "{{ b.place.name|escapejs }}",
      culture: "{{ b.culture.name|escapejs }}",
      balanceType: "{{ b.balance_type|escapejs }}",
      quantity: {{ b.quantity|stringformat:"f" }} 
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];
  
  // –û–±—á–∏—Å–ª–µ–Ω–Ω—è –∑–∞–≥–∞–ª—å–Ω–∏—Ö —Å—É–º —Ç—É—Ç, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ —ó—Ö –¥–æ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó JS
  let grandTotalValue = 0;
  let totalGrainValue = 0;
  let totalWasteValue = 0;

  {% for b in balances %}
    grandTotalValue += {{ b.quantity|default:0 }};
    {% if '–∑–µ—Ä–Ω–æ' in b.get_balance_type_display|lower or 'grain' in b.get_balance_type_display|lower %}
      totalGrainValue += {{ b.quantity|default:0 }};
    {% elif '–≤—ñ–¥—Ö–æ–¥' in b.get_balance_type_display|lower or 'waste' in b.get_balance_type_display|lower %}
      totalWasteValue += {{ b.quantity|default:0 }};
    {% endif %}
  {% endfor %}
  
</script>

<style>
/* --- –°–¢–ò–õ–Ü –°–ï–ì–ú–ï–ù–¢–û–í–ê–ù–û–ì–û –ü–ï–†–ï–ú–ò–ö–ê–ß–ê –û–î–ò–ù–ò–¶–¨ --- */

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Ç–∞ –ø–µ—Ä–µ–º–∏–∫–∞—á–∞ */
.header-actions {
    gap: 15px; /* –î–æ–¥–∞—î–º–æ –Ω–µ–≤–µ–ª–∏–∫–∏–π –ø—Ä–æ–º—ñ–∂–æ–∫ –º—ñ–∂ –∫–Ω–æ–ø–∫–æ—é —Ç–∞ –ø–µ—Ä–µ–º–∏–∫–∞—á–µ–º */
}

.unit-switch {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    font-family: "Inter", sans-serif;
    user-select: none;
}

.segmented-control {
    display: flex;
    background-color: #e2e8f0;
    border-radius: 10px;
    padding: 3px;
    position: relative;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
}

.control-item {
    padding: 7px 16px; 
    font-size: 0.95rem;
    font-weight: 700;
    color: #475569;
    cursor: pointer;
    z-index: 1;
    transition: color 0.3s ease;
    min-width: 45px;
    text-align: center;
    line-height: 1.2;
}

.control-item.active {
    color: #1e293b;
}

/* –ü—Ä–∏—Ö–æ–≤–∞–Ω–∏–π —á–µ–∫–±–æ–∫—Å */
.toggle-input {
    display: none;
}

/* –ü–æ–≤–∑—É–Ω–æ–∫ (—ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å—Ç–∞–Ω—É) */
.toggle-slider {
    position: absolute;
    top: 3px;
    left: 3px;
    height: calc(100% - 6px);
    width: calc(50% - 3px);
    background: #ffffff;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08); 
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 0;
}

/* –ü–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è –ø–æ–≤–∑—É–Ω–∫–∞ –Ω–∞ "–∫–≥" (–ø—Ä–∏ checked=true) */
.toggle-input:checked ~ .toggle-slider {
    transform: translateX(100%);
}

/* –î–æ–¥–∞—Ç–∫–æ–≤–∏–π –µ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ –Ω–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏–π –µ–ª–µ–º–µ–Ω—Ç */
.control-item:hover {
    color: #0f172a; 
}
.control-item.active:hover {
    color: #1e293b;
}

/* –°—Ç–∏–ª—ñ –¥–ª—è –º—ñ–Ω—ñ-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
.mini-stat-value {
    display: flex;
    align-items: baseline;
}
.mini-stat-suffix {
    font-size: 0.8em;
    font-weight: 500;
    margin-left: 5px;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // –ï–ª–µ–º–µ–Ω—Ç–∏ –ø–µ—Ä–µ–º–∏–∫–∞—á–∞
    const toggle = document.getElementById("unitToggleBalance");
    const tLabel = document.getElementById('labelTBalance');
    const kgLabel = document.getElementById('labelKGBalance');
    
    // –ï–ª–µ–º–µ–Ω—Ç–∏ —Ç–∞–±–ª–∏—Ü—ñ
    const values = document.querySelectorAll(".quantity-value-balance");
    // –û–Ω–æ–≤–ª–µ–Ω–æ: —Ç–µ–ø–µ—Ä header-quantity-balance –º—ñ—Å—Ç–∏—Ç—å <a>, —Ç–æ–º—É —à—É–∫–∞—î–º–æ <span> –≤ –Ω—å–æ–º—É
    const quantityHeader = document.getElementById("header-quantity-balance").querySelector("a span:first-child"); 
    
    // –ï–ª–µ–º–µ–Ω—Ç–∏ –º—ñ–Ω—ñ-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    const grandTotalElement = document.getElementById("grandTotal");
    const totalGrainElement = document.getElementById("totalGrain");
    const totalWasteElement = document.getElementById("totalWaste");

    const storageKey = 'balanceListUnit'; 
    
    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ data-t –∞—Ç—Ä–∏–±—É—Ç–∏ –º—ñ–Ω—ñ-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–Ω–∞—á–µ–Ω–Ω—è–º–∏ –∑ Django
    grandTotalElement.dataset.t = grandTotalValue;
    totalGrainElement.dataset.t = totalGrainValue;
    totalWasteElement.dataset.t = totalWasteValue;


    /**
     * –§–æ—Ä–º–∞—Ç—É—î —á–∏—Å–ª–æ. –î–ª—è –∫–≥ –æ–∫—Ä—É–≥–ª—é—î –¥–æ —Ü—ñ–ª–æ–≥–æ —Ç–∞ –¥–æ–¥–∞—î —Ä–æ–∑–¥—ñ–ª—å–Ω–∏–∫ —Ç–∏—Å—è—á.
     */
    function formatValue(value, isTons) {
        if (value === null || value === undefined || isNaN(value)) return '‚Äî';

        if (isTons) {
            // –î–ª—è —Ç–æ–Ω–Ω: 3 –∑–Ω–∞–∫–∏ –ø—ñ—Å–ª—è –∫–æ–º–∏
            return parseFloat(value).toFixed(3);
        } else {
            // –î–ª—è –∫–≥: –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è –¥–æ —Ü—ñ–ª–æ–≥–æ, —Ä–æ–∑–¥—ñ–ª—å–Ω–∏–∫ —Ç–∏—Å—è—á (–Ω–µ—Ä–æ–∑—Ä–∏–≤–Ω–∏–π –ø—Ä–æ–±—ñ–ª)
            const kgValue = Math.round(parseFloat(value) * 1000); 
            return kgValue.toLocaleString('uk-UA', { 
                maximumFractionDigits: 0,
                minimumFractionDigits: 0
            }).replace(/\s/g, '\u00A0'); 
        }
    }

    function updateUnits() {
        const modeKG = toggle.checked; 
        const unitText = modeKG ? " (–∫–≥)" : " (—Ç)";
        const suffixText = modeKG ? "–∫–≥" : "—Ç";

        // 1. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Å—Ç–æ–≤–ø—Ü—è —Ç–∞–±–ª–∏—Ü—ñ
        // –ó–º—ñ–Ω—é—î–º–æ —Ç–µ–∫—Å—Ç —Å–ø–∞–Ω—É, —â–æ –º—ñ—Å—Ç–∏—Ç—å "–ö—ñ–ª—å–∫—ñ—Å—Ç—å (—Ç)"
        quantityHeader.textContent = `–ö—ñ–ª—å–∫—ñ—Å—Ç—å ${unitText}`;

        // 2. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–Ω–∞—á–µ–Ω—å —É —Ç–∞–±–ª–∏—Ü—ñ
        values.forEach(v => {
            let tons = parseFloat(v.dataset.t);
            if (isNaN(tons)) tons = 0;

            v.textContent = formatValue(tons, !modeKG);
        });

        // 3. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –º—ñ–Ω—ñ-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        const updateMiniStat = (element) => {
            let tons = parseFloat(element.dataset.t);
            if (isNaN(tons)) tons = 0;

            // –û–Ω–æ–≤–ª—é—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è —Ç–∞ —Å—É—Ñ—ñ–∫—Å
            // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ element.firstChild, –æ—Å–∫—ñ–ª—å–∫–∏ —Å—É—Ñ—ñ–∫—Å –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è —É <span>
            element.firstChild.textContent = formatValue(tons, !modeKG);
            element.querySelector(".mini-stat-suffix").textContent = suffixText;
        };

        updateMiniStat(grandTotalElement);
        updateMiniStat(totalGrainElement);
        updateMiniStat(totalWasteElement);


        // 4. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–æ—ó –æ–¥–∏–Ω–∏—Ü—ñ (–≤—ñ–∑—É–∞–ª)
        if (modeKG) {
            tLabel.classList.remove('active');
            kgLabel.classList.add('active');
        } else {
            tLabel.classList.add('active');
            kgLabel.classList.remove('active');
        }

        // 5. –ó–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Å—Ç–∞–Ω—É
        localStorage.setItem(storageKey, modeKG ? 'kg' : 't');
    }

    // –°–ª—É—Ö–∞—î–º–æ –ø–æ–¥—ñ—é 'change' –Ω–∞ –ø—Ä–∏—Ö–æ–≤–∞–Ω–æ–º—É —á–µ–∫–±–æ–∫—Å—ñ.
    // –¶–µ –∑–∞–±–µ–∑–ø–µ—á—É—î –∫–æ—Ä–µ–∫—Ç–Ω—É —Ä–æ–±–æ—Ç—É –ø—Ä–∏ –∫–ª—ñ–∫—É –Ω–∞ –±—É–¥—å-—è–∫—É –º—ñ—Ç–∫—É.
    toggle.addEventListener('change', updateUnits);

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∑ Local Storage
    const savedUnit = localStorage.getItem(storageKey);
    const initialModeKG = savedUnit === 'kg';
    
    toggle.checked = initialModeKG;
    // –û–Ω–æ–≤–ª—é—î–º–æ –æ–¥–∏–Ω–∏—Ü—ñ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ, —â–æ–± –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π —Å—Ç–∞–Ω
    updateUnits();
});
</script>

<script src="{% static 'js/balance_charts.js' %}"></script>

{% endblock %}
