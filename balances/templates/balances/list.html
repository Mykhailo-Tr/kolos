{% extends "base.html" %}
{% load humanize %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/balance_list.css' %}">

<div class="container mt-4">
  <div class="page-header">
    <h2 class="page-title">
      <span class="page-title-icon">üì¶</span>
      {{ model_name|default:"–ó–∞–ª–∏—à–∫–∏" }}
    </h2>
    <a href="{% url 'balance_create' %}" class="btn-add-new">
      <span>‚ûï</span>
      <span>–î–æ–¥–∞—Ç–∏ –∑–∞–ø–∏—Å</span>
    </a>
  </div>

  {% if balances %}
    <div class="table-container">
      <div class="table-responsive">
        <table class="table professional-table table-hover table-striped">
          <thead class="text-center">
            <tr>
              {% with request.GET.order as current_order %}
              <th class="row-number">#</th>
              <th class="text-start">
                <a href="?order={% if current_order == 'place__name' %}-place__name{% else %}place__name{% endif %}" class="sort-link">
                  <span>–ú—ñ—Å—Ü–µ</span>
                  <span class="sort-icon">
                    {% if current_order == 'place__name' %}‚ñ≤{% elif current_order == '-place__name' %}‚ñº{% else %}‚áÖ{% endif %}
                  </span>
                </a>
              </th>
              <th class="text-start">
                <a href="?order={% if current_order == 'culture__name' %}-culture__name{% else %}culture__name{% endif %}" class="sort-link">
                  <span>–ö—É–ª—å—Ç—É—Ä–∞</span>
                  <span class="sort-icon">
                    {% if current_order == 'culture__name' %}‚ñ≤{% elif current_order == '-culture__name' %}‚ñº{% else %}‚áÖ{% endif %}
                  </span>
                </a>
              </th>
              <th>
                <a href="?order={% if current_order == 'balance_type' %}-balance_type{% else %}balance_type{% endif %}" class="sort-link">
                  <span>–¢–∏–ø</span>
                  <span class="sort-icon">
                    {% if current_order == 'balance_type' %}‚ñ≤{% elif current_order == '-balance_type' %}‚ñº{% else %}‚áÖ{% endif %}
                  </span>
                </a>
              </th>
              <th class="text-end">
                <a href="?order={% if current_order == 'quantity' %}-quantity{% else %}quantity{% endif %}" class="sort-link">
                  <span>–ö—ñ–ª—å–∫—ñ—Å—Ç—å (—Ç)</span>
                  <span class="sort-icon">
                    {% if current_order == 'quantity' %}‚ñ≤{% elif current_order == '-quantity' %}‚ñº{% else %}‚áÖ{% endif %}
                  </span>
                </a>
              </th>
              <th>–î—ñ—ó</th>
              {% endwith %}
            </tr>
          </thead>
          <tbody>
            {% for b in balances %}
            <tr>
              <td class="text-center row-number">{{ forloop.counter0|add:page_obj.start_index }}</td>
              <td>{{ b.place.name }}</td>
              <td>{{ b.culture.name }}</td>
              <td class="text-center">
                <span class="balance-type-badge {% if '–∑–µ—Ä–Ω–æ' in b.get_balance_type_display|lower or 'grain' in b.get_balance_type_display|lower %}badge-grain{% elif '–≤—ñ–¥—Ö–æ–¥' in b.get_balance_type_display|lower or 'waste' in b.get_balance_type_display|lower %}badge-waste{% endif %}">
                  {{ b.get_balance_type_display }}
                </span>
              </td>
              <td class="text-end">
                <span class="quantity-value">{{ b.quantity|floatformat:3 }}</span>
              </td>
              <td>
                <div class="action-buttons">
                  <a href="{% url 'balance_update' b.pk %}" class="btn-action btn-edit" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">‚úèÔ∏è</a>
                  <a href="{% url 'balance_delete' b.pk %}" class="btn-action btn-delete" title="–í–∏–¥–∞–ª–∏—Ç–∏">üóëÔ∏è</a>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    {% if is_paginated %}
    <nav aria-label="Page navigation" class="mt-3">
      <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.order %}&order={{ request.GET.order }}{% endif %}">‚Äπ</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">‚Äπ</span></li>
        {% endif %}

        {% for num in paginator.page_range %}
          {% if num == page_obj.number %}
            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
          {% else %}
            <li class="page-item"><a class="page-link" href="?page={{ num }}{% if request.GET.order %}&order={{ request.GET.order }}{% endif %}">{{ num }}</a></li>
          {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.order %}&order={{ request.GET.order }}{% endif %}">‚Ä∫</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">‚Ä∫</span></li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}

  {% else %}
    <div class="empty-state">
      <div class="empty-state-icon">üì¶</div>
      <h3 class="empty-state-title">–ó–∞–ø–∏—Å—ñ–≤ –ø–æ–∫–∏ —â–æ –Ω–µ–º–∞—î</h3>
      <p class="empty-state-text">–î–æ–¥–∞–π—Ç–µ –ø–µ—Ä—à–∏–π –∑–∞–ø–∏—Å —É –∂—É—Ä–Ω–∞–ª –∑–∞–ª–∏—à–∫—ñ–≤, —â–æ–± –ø–æ—á–∞—Ç–∏ —Ä–æ–±–æ—Ç—É</p>
    </div>
  {% endif %}

  {% include "balances/dashboard.html" %}
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
  // –§–æ—Ä–º—É—î–º–æ –æ–±'—î–∫—Ç –¥–∞–Ω–∏—Ö —Ç—É—Ç, –±–æ –≤ –∑–æ–≤–Ω—ñ—à–Ω—å–æ–º—É JS —Ñ–∞–π–ª—ñ Django —Ç–µ–≥–∏ –Ω–µ –ø—Ä–∞—Ü—é—é—Ç—å
  const balancesData = [
    {% for b in balances %}
    {
      place: "{{ b.place.name|escapejs }}",
      culture: "{{ b.culture.name|escapejs }}",
      balanceType: "{{ b.balance_type|escapejs }}",
      quantity: {{ b.quantity|stringformat:"f" }} // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ stringformat, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –ø–æ–º–∏–ª–æ–∫ –∑ –∫–æ–º–∞–º–∏
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];
</script>

<script src="{% static 'js/balance_charts.js' %}"></script>

{% endblock %}