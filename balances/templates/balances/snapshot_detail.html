{% extends "base.html" %}
{% load humanize %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/journal.css' %}">

<style>
/* ===== –ù–æ–≤—ñ —Å—Ç–∏–ª—ñ –¥–ª—è snapshot_detail.html ===== */

/* –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–µ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è –±—Ä–∞—É–∑–µ—Ä–∞ –ø—Ä–∏ –∫–ª—ñ–∫—É */
.sort-link:focus {
    outline: none;
    box-shadow: none;
}

/* –ö–æ–ª—ñ—Ä —Ç–∞ –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ */
.sort-link {
    color: inherit;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-weight: 500;
    transition: all 0.1s ease;
}

.sort-link:hover {
    color: #2563eb; /* –∫–æ–ª—ñ—Ä –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ */
}

.sort-icon {
    font-size: 0.8rem;
}

/* –ë–µ–π–¥–∂—ñ –¥–ª—è —Ç–∏–ø—É –±–∞–ª–∞–Ω—Å—É */
.badge-grain {
  display: inline-block;
  padding: 0.25rem 0.6rem;
  font-size: 0.8rem;
  font-weight: 600;
  color: #047857;
  background: #ecfdf5;
  border: 1px solid #10b981;
  border-radius: 0.35rem;
  text-align: center;
}

.badge-waste {
  display: inline-block;
  padding: 0.25rem 0.6rem;
  font-size: 0.8rem;
  font-weight: 600;
  color: #b45309;
  background: #fef3c7;
  border: 1px solid #f59e0b;
  border-radius: 0.35rem;
  text-align: center;
}

/* –¶–µ–Ω—Ç—Ä—É—î–º–æ —Ç–∏–ø –±–∞–ª–∞–Ω—Å—É */
.journal-table tbody td.balance-type {
  text-align: center;
  vertical-align: middle;
}

/* –ü–æ–∫—Ä–∞—â–µ–Ω–∞ —à–∞–ø–∫–∞ –∑ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é */
.snapshot-info {
  display: flex;
  flex-wrap: wrap;
  gap: 1.5rem;
  font-size: 0.95rem;
  color: #4b5563;
}

.snapshot-info div {
  display: flex;
  gap: 0.25rem;
}

.snapshot-info strong {
  color: #1f2937;
}

/* –ü–æ–∫—Ä–∞—â–µ–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
.stats-row {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.stats-card {
  flex: 1;
  min-width: 180px;
  background: white;
  border-radius: 0.45rem;
  border: 1px solid #d1d5db;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  text-align: center;
  padding: 1rem;
}

.stats-card h5 {
  font-size: 0.85rem;
  font-weight: 600;
  color: #374151;
  margin-bottom: 0.5rem;
}

.stats-card h2 {
  font-size: 1.5rem;
  margin: 0;
}

/* –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —à–∏—Ä–∏–Ω–∏ –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ñ –¥–µ—Ç–∞–ª–µ–π */
.journal-table th:nth-child(1), .journal-table td:nth-child(1) { width: 5%; text-align: center; }  /* # */
.journal-table th:nth-child(2), .journal-table td:nth-child(2) { width: 25%; text-align: center; }  /* –ú—ñ—Å—Ü–µ */
.journal-table th:nth-child(3), .journal-table td:nth-child(3) { width: 25%; text-align: center; }  /* –ö—É–ª—å—Ç—É—Ä–∞ */
.journal-table th:nth-child(4), .journal-table td:nth-child(4) { width: 15%; text-align: center; }  /* –¢–∏–ø –±–∞–ª–∞–Ω—Å—É */
.journal-table th:nth-child(5), .journal-table td:nth-child(5) { width: 15%; text-align: right; }  /* –ö—ñ–ª—å–∫—ñ—Å—Ç—å */

/* –°—Ç–∏–ª—ñ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.page-header-left {
    flex: 1;
}

.page-header-right {
    display: flex;
    align-items: center; /* –í–∏—Ä—ñ–≤–Ω—é—î–º–æ –ø–µ—Ä–µ–º–∏–∫–∞—á —Ç–∞ –∫–Ω–æ–ø–∫–∏ */
    gap: 0.75rem;
}

.page-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #1f2937;
    margin: 0 0 0.5rem 0;
}

.btn-add {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    border: none;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-add:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
    color: white;
}

/* --- –°–¢–ò–õ–Ü –°–ï–ì–ú–ï–ù–¢–û–í–ê–ù–û–ì–û –ü–ï–†–ï–ú–ò–ö–ê–ß–ê –û–î–ò–ù–ò–¶–¨ (—Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ) --- */
.unit-switch {
    display: flex;
    font-family: "Inter", sans-serif;
    user-select: none;
}

.segmented-control {
    display: flex;
    background-color: #e2e8f0;
    border-radius: 10px;
    padding: 3px;
    position: relative;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
}

.control-item {
    padding: 7px 16px; 
    font-size: 0.95rem;
    font-weight: 700;
    color: #475569;
    cursor: pointer;
    z-index: 1;
    transition: color 0.3s ease;
    min-width: 45px;
    text-align: center;
    line-height: 1.2;
}

.control-item.active {
    color: #1e293b;
}

/* –ü—Ä–∏—Ö–æ–≤–∞–Ω–∏–π —á–µ–∫–±–æ–∫—Å */
.toggle-input {
    display: none;
}

/* –ü–æ–≤–∑—É–Ω–æ–∫ (—ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å—Ç–∞–Ω—É) */
.toggle-slider {
    position: absolute;
    top: 3px;
    left: 3px;
    height: calc(100% - 6px);
    width: calc(50% - 3px);
    background: #ffffff;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08); 
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 0;
}

/* –ü–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è –ø–æ–≤–∑—É–Ω–∫–∞ –Ω–∞ "–∫–≥" (–ø—Ä–∏ checked=true) */
.toggle-input:checked ~ .toggle-slider {
    transform: translateX(100%);
}

.control-item:hover {
    color: #0f172a; 
}
.control-item.active:hover {
    color: #1e293b;
}

</style>

<div class="journal-container">

  <div class="page-header">
    <div class="page-header-left">
      <h1 class="page-title">üìä –î–µ—Ç–∞–ª—å–Ω–∏–π –ø–µ—Ä–µ–≥–ª—è–¥ –∑–ª—ñ–ø–∫–∞</h1>
      <div class="snapshot-info">
        <div><strong>–î–∞—Ç–∞ –∑–ª—ñ–ø–∫—É:</strong> {{ snapshot.snapshot_date|date:"d.m.Y H:i" }}</div>
        <div><strong>–û–ø–∏—Å:</strong> {{ snapshot.description|default:"‚Äî" }}</div>
        <div><strong>–°—Ç–≤–æ—Ä–µ–Ω–æ:</strong> {{ snapshot.created_by|default:"‚Äî" }}</div>
      </div>
    </div>

    <div class="page-header-right">
      
      {# –°–ï–ì–ú–ï–ù–¢–û–í–ê–ù–ò–ô –ü–ï–†–ï–ú–ò–ö–ê–ß –û–î–ò–ù–ò–¶–¨ #}
      <div class="unit-switch" id="unitSwitchContainerDetail">
          <div class="segmented-control">
              <input type="checkbox" id="unitToggleDetail" class="toggle-input">
              
              <label for="unitToggleDetail" class="control-item active" data-unit="t" id="labelTDetail">—Ç</label>
              <label for="unitToggleDetail" class="control-item" data-unit="kg" id="labelKGDetail">–∫–≥</label>

              <span class="toggle-slider"></span>
          </div>
      </div>
      {# –ö–Ü–ù–ï–¶–¨ –ü–ï–†–ï–ú–ò–ö–ê–ß–ê #}

      <a href="{% url 'balance_snapshot_update' snapshot.pk %}" class="btn-add"
         style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
        ‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏
      </a>

      <a href="{% url 'balance_snapshot_list' %}" class="btn-add"
         style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);">
        ‚Ü©Ô∏è –î–æ —ñ—Å—Ç–æ—Ä—ñ—ó
      </a>
    </div>
  </div>

  <div class="stats-row">
    <div class="stats-card">
      <h5>üì¶ –í—Å—å–æ–≥–æ –∑–∞–ø–∏—Å—ñ–≤</h5>
      <h2>{{ total_records_count }}</h2>
    </div>
    <div class="stats-card">
      <h5>‚öñÔ∏è –ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å</h5>
      {# –î–æ–¥–∞—î–º–æ ID —Ç–∞ data-t –¥–ª—è JS #}
      <h2 id="totalQuantityStat" data-t="{{ total_quantity|stringformat:'f' }}">
        {{ total_quantity|floatformat:3 }} <span id="totalQuantityUnit">—Ç</span>
      </h2>
    </div>
    <div class="stats-card">
      <h5>üïí –î–∞—Ç–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è</h5>
      <h2 style="font-size: 1.3rem;">{{ snapshot.snapshot_date|date:"d.m.Y" }}</h2>
      <small class="text-muted">{{ snapshot.snapshot_date|date:"H:i" }}</small>
    </div>
  </div>

  {% if history_records %}
  <div class="table-wrapper">
    <table class="journal-table">
      <thead>
        <tr>
          <th>#</th>
          <th>
            <a href="?order={% if current_order == 'place__name' %}-place__name{% else %}place__name{% endif %}" class="sort-link">
              –ú—ñ—Å—Ü–µ
              <span class="sort-icon">
                {% if current_order == 'place__name' %}
                  ‚ñ≤
                {% elif current_order == '-place__name' %}
                  ‚ñº
                {% else %}
                  ‚áÖ
                {% endif %}
              </span>
            </a>
          </th>
          <th>
            <a href="?order={% if current_order == 'culture__name' %}-culture__name{% else %}culture__name{% endif %}" class="sort-link">
              –ö—É–ª—å—Ç—É—Ä–∞
              <span class="sort-icon">
                {% if current_order == 'culture__name' %}
                  ‚ñ≤
                {% elif current_order == '-culture__name' %}
                  ‚ñº
                {% else %}
                  ‚áÖ
                {% endif %}
              </span>
            </a>
          </th>
          <th>
            <a href="?order={% if current_order == 'balance_type' %}-balance_type{% else %}balance_type{% endif %}" class="sort-link">
              –¢–∏–ø –±–∞–ª–∞–Ω—Å—É
              <span class="sort-icon">
                {% if current_order == 'balance_type' %}
                  ‚ñ≤
                {% elif current_order == '-balance_type' %}
                  ‚ñº
                {% else %}
                  ‚áÖ
                {% endif %}
              </span>
            </a>
          </th>
          <th id="header-quantity-detail">
            <a href="?order={% if current_order == 'quantity' %}-quantity{% else %}quantity{% endif %}" class="sort-link">
              {# –†–æ–∑–¥—ñ–ª—è—î–º–æ –Ω–∞ –¥–≤–∞ span –¥–ª—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –æ–¥–∏–Ω–∏—Ü—ñ #}
              <span id="quantity-text-detail">–ö—ñ–ª—å–∫—ñ—Å—Ç—å</span> <span id="unit-label-detail">(—Ç)</span>
              <span class="sort-icon">
                {% if current_order == 'quantity' %}
                  ‚ñ≤
                {% elif current_order == '-quantity' %}
                  ‚ñº
                {% else %}
                  ‚áÖ
                {% endif %}
              </span>
            </a>
          </th>
        </tr>
      </thead>

      <tbody>
        {% for record in history_records %}
        <tr>
          <td class="text-center">{{ forloop.counter0|add:page_obj.start_index }}</td>
          <td class="text-center">{{ record.place.name }}</td>
          <td class="text-center">{{ record.culture.name }}</td>
          <td class="balance-type text-center">
            {% if record.balance_type == 'stock' %}
              <span class="badge-grain">–ó–µ—Ä–Ω–æ</span>
            {% else %}
              <span class="badge-waste">–í—ñ–¥—Ö–æ–¥–∏</span>
            {% endif %}
          </td>
          <td class="text-end">
            {# –î–æ–¥–∞—î–º–æ –∫–ª–∞—Å —Ç–∞ data-t –∞—Ç—Ä–∏–±—É—Ç –¥–ª—è —Ä–æ–±–æ—Ç–∏ JS #}
            <span class="quantity-value" data-t="{{ record.quantity|stringformat:'f' }}">{{ record.quantity|floatformat:3 }}</span>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if is_paginated %}
    <nav aria-label="Page navigation" class="mt-3">
      <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.order %}&order={{ request.GET.order }}{% endif %}">
              ‚Äπ
            </a>
          </li>
        {% else %}
          <li class="page-item disabled">
            <span class="page-link">‚Äπ</span>
          </li>
        {% endif %}

        {% for num in paginator.page_range %}
          {% if page_obj.number == num %}
            <li class="page-item active">
              <span class="page-link">{{ num }}</span>
            </li>
          {% else %}
            <li class="page-item">
              <a class="page-link" href="?page={{ num }}{% if request.GET.order %}&order={{ request.GET.order }}{% endif %}">
                {{ num }}
              </a>
            </li>
          {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.order %}&order={{ request.GET.order }}{% endif %}">
              ‚Ä∫
            </a>
          </li>
        {% else %}
          <li class="page-item disabled">
            <span class="page-link">‚Ä∫</span>
          </li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}

  {% else %}
  <div class="alert alert-info mt-3">
    <i class="bi bi-info-circle me-2"></i>–£ —Ü—å–æ–º—É –∑–ª—ñ–ø–∫—É –Ω–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤.
  </div>
  {% endif %}

</div>

<script>
    /**
     * –§–æ—Ä–º–∞—Ç—É—î —á–∏—Å–ª–æ. –î–ª—è –∫–≥ –æ–∫—Ä—É–≥–ª—é—î –¥–æ —Ü—ñ–ª–æ–≥–æ —Ç–∞ –¥–æ–¥–∞—î —Ä–æ–∑–¥—ñ–ª—å–Ω–∏–∫ —Ç–∏—Å—è—á.
     */
    function formatValue(value, isTons) {
        if (value === null || value === undefined || isNaN(value)) return '‚Äî';

        if (isTons) {
            // –î–ª—è —Ç–æ–Ω–Ω: 3 –∑–Ω–∞–∫–∏ –ø—ñ—Å–ª—è –∫–æ–º–∏
            return parseFloat(value).toFixed(3);
        } else {
            // –î–ª—è –∫–≥: –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è –¥–æ —Ü—ñ–ª–æ–≥–æ, —Ä–æ–∑–¥—ñ–ª—å–Ω–∏–∫ —Ç–∏—Å—è—á (–Ω–µ—Ä–æ–∑—Ä–∏–≤–Ω–∏–π –ø—Ä–æ–±—ñ–ª)
            const kgValue = Math.round(parseFloat(value) * 1000); 
            return kgValue.toLocaleString('uk-UA', { 
                maximumFractionDigits: 0,
                minimumFractionDigits: 0
            }).replace(/\s/g, '\u00A0'); 
        }
    }

    function updateUnits() {
        const toggle = document.getElementById("unitToggleDetail");
        const tLabel = document.getElementById('labelTDetail');
        const kgLabel = document.getElementById('labelKGDetail');
        const values = document.querySelectorAll(".quantity-value");
        const quantityHeaderUnit = document.getElementById("unit-label-detail"); 
        const totalQuantityStat = document.getElementById("totalQuantityStat");
        const totalQuantityUnit = document.getElementById("totalQuantityUnit");
        
        // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ç–æ–π —Å–∞–º–∏–π –∫–ª—é—á, —â–æ —ñ –≤ —Å–ø–∏—Å–∫—É, –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó
        const storageKey = 'snapshotListUnit'; 

        const modeKG = toggle.checked; 
        const unitTextHeader = modeKG ? "(–∫–≥)" : "(—Ç)";
        const unitTextStat = modeKG ? "–∫–≥" : "—Ç";

        // 1. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Å—Ç–æ–≤–ø—Ü—è —Ç–∞–±–ª–∏—Ü—ñ
        quantityHeaderUnit.textContent = unitTextHeader;

        // 2. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–≥–∞–ª—å–Ω–æ—ó –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —É —Å—Ç–∞—Ç–∏—Å—Ç–∏—Ü—ñ
        let totalTons = parseFloat(totalQuantityStat.dataset.t);
        totalQuantityStat.firstChild.textContent = formatValue(totalTons, !modeKG) + '\u00A0'; // –î–æ–¥–∞—î–º–æ –Ω–µ—Ä–æ–∑—Ä–∏–≤–Ω–∏–π –ø—Ä–æ–±—ñ–ª
        totalQuantityUnit.textContent = unitTextStat;

        // 3. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–Ω–∞—á–µ–Ω—å —É —Ç–∞–±–ª–∏—Ü—ñ
        values.forEach(v => {
            let tons = parseFloat(v.dataset.t);
            if (isNaN(tons)) tons = 0;

            v.textContent = formatValue(tons, !modeKG);
        });

        // 4. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–æ—ó –æ–¥–∏–Ω–∏—Ü—ñ (–≤—ñ–∑—É–∞–ª)
        if (modeKG) {
            tLabel.classList.remove('active');
            kgLabel.classList.add('active');
        } else {
            tLabel.classList.add('active');
            kgLabel.classList.remove('active');
        }

        // 5. –ó–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Å—Ç–∞–Ω—É
        localStorage.setItem(storageKey, modeKG ? 'kg' : 't');
    }

    document.addEventListener('DOMContentLoaded', function() {
        const storageKey = 'snapshotListUnit'; 
        const toggle = document.getElementById("unitToggleDetail");
        
        // --- –õ–æ–≥—ñ–∫–∞ –ø–µ—Ä–µ–º–∏–∫–∞—á–∞ –æ–¥–∏–Ω–∏—Ü—å ---
        const savedUnit = localStorage.getItem(storageKey);
        const initialModeKG = savedUnit === 'kg';
        
        // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø–æ—á–∞—Ç–∫–æ–≤–∏–π —Å—Ç–∞–Ω –ø–µ—Ä–µ–º–∏–∫–∞—á–∞
        toggle.checked = initialModeKG;
        toggle.addEventListener('change', updateUnits);
        
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –æ–¥–∏–Ω–∏—Ü—ñ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ, —â–æ–± –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π —Å—Ç–∞–Ω
        updateUnits();


        // --- –õ–æ–≥—ñ–∫–∞ –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è ---
        const urlParams = new URLSearchParams(window.location.search);
        // –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º —Å–æ—Ä—Ç—É—î–º–æ –∑–∞ –ú—ñ—Å—Ü–µ–º (place__name)
        const currentOrder = urlParams.get('order') || 'place__name'; 
        
        const sortLinks = document.querySelectorAll('.sort-link');
        
        sortLinks.forEach(link => {
            const href = link.getAttribute('href');
            if (href && href.includes('order=')) {
                const orderParam = href.split('order=')[1].split('&')[0];
                
                if (orderParam === currentOrder) {
                    link.style.color = '#2563eb';
                    link.style.fontWeight = '600';
                    
                    const icon = link.querySelector('.sort-icon');
                    if (icon) {
                        icon.style.color = '#2563eb';
                    }
                }
            }
        });
    });
</script>
{% endblock %}