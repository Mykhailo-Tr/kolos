{% extends "base.html" %}
{% load humanize %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/journal.css' %}">

<style>
/* ===== –ù–æ–≤—ñ —Å—Ç–∏–ª—ñ –¥–ª—è snapshot_detail.html ===== */

/* –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–µ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è –±—Ä–∞—É–∑–µ—Ä–∞ –ø—Ä–∏ –∫–ª—ñ–∫—É */
.sort-link:focus {
    outline: none;
    box-shadow: none;
}

/* –ö–æ–ª—ñ—Ä —Ç–∞ –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ */
.sort-link {
    color: inherit;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-weight: 500;
    transition: all 0.1s ease;
}

.sort-link:hover {
    color: #2563eb; /* –∫–æ–ª—ñ—Ä –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ */
}

.sort-icon {
    font-size: 0.8rem;
}

/* –ë–µ–π–¥–∂—ñ –¥–ª—è —Ç–∏–ø—É –±–∞–ª–∞–Ω—Å—É */
.badge-grain {
  display: inline-block;
  padding: 0.25rem 0.6rem;
  font-size: 0.8rem;
  font-weight: 600;
  color: #047857;
  background: #ecfdf5;
  border: 1px solid #10b981;
  border-radius: 0.35rem;
  text-align: center;
}

.badge-waste {
  display: inline-block;
  padding: 0.25rem 0.6rem;
  font-size: 0.8rem;
  font-weight: 600;
  color: #b45309;
  background: #fef3c7;
  border: 1px solid #f59e0b;
  border-radius: 0.35rem;
  text-align: center;
}

/* –¶–µ–Ω—Ç—Ä—É—î–º–æ —Ç–∏–ø –±–∞–ª–∞–Ω—Å—É */
.journal-table tbody td.balance-type {
  text-align: center;
  vertical-align: middle;
}

/* –ü–æ–∫—Ä–∞—â–µ–Ω–∞ —à–∞–ø–∫–∞ –∑ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é */
.snapshot-info {
  display: flex;
  flex-wrap: wrap;
  gap: 1.5rem;
  font-size: 0.95rem;
  color: #4b5563;
}

.snapshot-info div {
  display: flex;
  gap: 0.25rem;
}

.snapshot-info strong {
  color: #1f2937;
}

/* –ü–æ–∫—Ä–∞—â–µ–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
.stats-row {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.stats-card {
  flex: 1;
  min-width: 180px;
  background: white;
  border-radius: 0.45rem;
  border: 1px solid #d1d5db;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  text-align: center;
  padding: 1rem;
}

.stats-card h5 {
  font-size: 0.85rem;
  font-weight: 600;
  color: #374151;
  margin-bottom: 0.5rem;
}

.stats-card h2 {
  font-size: 1.5rem;
  margin: 0;
}

/* –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —à–∏—Ä–∏–Ω–∏ –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ñ –¥–µ—Ç–∞–ª–µ–π */
.journal-table th:nth-child(1), .journal-table td:nth-child(1) { width: 5%; text-align: center; }  /* # */
.journal-table th:nth-child(2), .journal-table td:nth-child(2) { width: 25%; text-align: center; }  /* –ú—ñ—Å—Ü–µ */
.journal-table th:nth-child(3), .journal-table td:nth-child(3) { width: 25%; text-align: center; }  /* –ö—É–ª—å—Ç—É—Ä–∞ */
.journal-table th:nth-child(4), .journal-table td:nth-child(4) { width: 15%; text-align: center; }  /* –¢–∏–ø –±–∞–ª–∞–Ω—Å—É */
.journal-table th:nth-child(5), .journal-table td:nth-child(5) { width: 15%; text-align: center; }  /* –ö—ñ–ª—å–∫—ñ—Å—Ç—å */

/* –°—Ç–∏–ª—ñ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.page-header-left {
    flex: 1;
}

.page-header-right {
    display: flex;
    gap: 0.75rem;
}

.page-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #1f2937;
    margin: 0 0 0.5rem 0;
}

.btn-add {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    border: none;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-add:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
    color: white;
}
</style>

<div class="journal-container">

  <!-- ===== –ó–∞–≥–æ–ª–æ–≤–æ–∫ ===== -->
  <div class="page-header">
    <div class="page-header-left">
      <h1 class="page-title">üìä –î–µ—Ç–∞–ª—å–Ω–∏–π –ø–µ—Ä–µ–≥–ª—è–¥ –∑–ª—ñ–ø–∫–∞</h1>
      <div class="snapshot-info">
        <div><strong>–î–∞—Ç–∞ –∑–ª—ñ–ø–∫—É:</strong> {{ snapshot.snapshot_date|date:"d.m.Y H:i" }}</div>
        <div><strong>–û–ø–∏—Å:</strong> {{ snapshot.description|default:"‚Äî" }}</div>
        <div><strong>–°—Ç–≤–æ—Ä–µ–Ω–æ:</strong> {{ snapshot.created_by|default:"‚Äî" }}</div>
      </div>
    </div>

    <div class="page-header-right">
      <a href="{% url 'balance_snapshot_update' snapshot.pk %}" class="btn-add"
         style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
        ‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏
      </a>

      <a href="{% url 'balance_snapshot_list' %}" class="btn-add"
         style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);">
        ‚Ü©Ô∏è –î–æ —ñ—Å—Ç–æ—Ä—ñ—ó
      </a>
    </div>
  </div>

  <!-- ===== –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ===== -->
  <div class="stats-row">
    <div class="stats-card">
      <h5>üì¶ –í—Å—å–æ–≥–æ –∑–∞–ø–∏—Å—ñ–≤</h5>
      <h2>{{ total_records_count }}</h2>
    </div>
    <div class="stats-card">
      <h5>‚öñÔ∏è –ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å</h5>
      <h2>{{ total_quantity|floatformat:3 }} —Ç</h2>
    </div>
    <div class="stats-card">
      <h5>üïí –î–∞—Ç–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è</h5>
      <h2 style="font-size: 1.3rem;">{{ snapshot.snapshot_date|date:"d.m.Y" }}</h2>
      <small class="text-muted">{{ snapshot.snapshot_date|date:"H:i" }}</small>
    </div>
  </div>

  <!-- ===== –¢–∞–±–ª–∏—Ü—è ===== -->
  {% if history_records %}
  <div class="table-wrapper">
    <table class="journal-table">
      <thead>
        <tr>
          <th>#</th>
          <th>
            <a href="?order={% if current_order == 'place__name' %}-place__name{% else %}place__name{% endif %}" class="sort-link">
              –ú—ñ—Å—Ü–µ
              <span class="sort-icon">
                {% if current_order == 'place__name' %}
                  ‚ñ≤
                {% elif current_order == '-place__name' %}
                  ‚ñº
                {% else %}
                  ‚áÖ
                {% endif %}
              </span>
            </a>
          </th>
          <th>
            <a href="?order={% if current_order == 'culture__name' %}-culture__name{% else %}culture__name{% endif %}" class="sort-link">
              –ö—É–ª—å—Ç—É—Ä–∞
              <span class="sort-icon">
                {% if current_order == 'culture__name' %}
                  ‚ñ≤
                {% elif current_order == '-culture__name' %}
                  ‚ñº
                {% else %}
                  ‚áÖ
                {% endif %}
              </span>
            </a>
          </th>
          <th>
            <a href="?order={% if current_order == 'balance_type' %}-balance_type{% else %}balance_type{% endif %}" class="sort-link">
              –¢–∏–ø –±–∞–ª–∞–Ω—Å—É
              <span class="sort-icon">
                {% if current_order == 'balance_type' %}
                  ‚ñ≤
                {% elif current_order == '-balance_type' %}
                  ‚ñº
                {% else %}
                  ‚áÖ
                {% endif %}
              </span>
            </a>
          </th>
          <th>
            <a href="?order={% if current_order == 'quantity' %}-quantity{% else %}quantity{% endif %}" class="sort-link">
              –ö—ñ–ª—å–∫—ñ—Å—Ç—å (—Ç)
              <span class="sort-icon">
                {% if current_order == 'quantity' %}
                  ‚ñ≤
                {% elif current_order == '-quantity' %}
                  ‚ñº
                {% else %}
                  ‚áÖ
                {% endif %}
              </span>
            </a>
          </th>
        </tr>
      </thead>

      <tbody>
        {% for record in history_records %}
        <tr>
          <td class="text-center">{{ forloop.counter0|add:page_obj.start_index }}</td>
          <td class="text-center">{{ record.place.name }}</td>
          <td class="text-center">{{ record.culture.name }}</td>
          <td class="balance-type text-center">
            {% if record.balance_type == 'stock' %}
              <span class="badge-grain">–ó–µ—Ä–Ω–æ</span>
            {% else %}
              <span class="badge-waste">–í—ñ–¥—Ö–æ–¥–∏</span>
            {% endif %}
          </td>
          <td class="text-center">
            <span class="quantity-value">{{ record.quantity|floatformat:3 }}</span>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- ===== –ü–∞–≥—ñ–Ω–∞—Ü—ñ—è ===== -->
  {% if is_paginated %}
    <nav aria-label="Page navigation" class="mt-3">
      <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.order %}&order={{ request.GET.order }}{% endif %}">
              ‚Äπ
            </a>
          </li>
        {% else %}
          <li class="page-item disabled">
            <span class="page-link">‚Äπ</span>
          </li>
        {% endif %}

        {% for num in paginator.page_range %}
          {% if page_obj.number == num %}
            <li class="page-item active">
              <span class="page-link">{{ num }}</span>
            </li>
          {% else %}
            <li class="page-item">
              <a class="page-link" href="?page={{ num }}{% if request.GET.order %}&order={{ request.GET.order }}{% endif %}">
                {{ num }}
              </a>
            </li>
          {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.order %}&order={{ request.GET.order }}{% endif %}">
              ‚Ä∫
            </a>
          </li>
        {% else %}
          <li class="page-item disabled">
            <span class="page-link">‚Ä∫</span>
          </li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}

  {% else %}
  <div class="alert alert-info mt-3">
    <i class="bi bi-info-circle me-2"></i>–£ —Ü—å–æ–º—É –∑–ª—ñ–ø–∫—É –Ω–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤.
  </div>
  {% endif %}

</div>

<script>
// JavaScript –¥–ª—è –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
document.addEventListener('DOMContentLoaded', function() {
  const urlParams = new URLSearchParams(window.location.search);
  const currentOrder = urlParams.get('order') || 'place__name';
  
  // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –≤—Å—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
  const sortLinks = document.querySelectorAll('.sort-link');
  
  sortLinks.forEach(link => {
    const href = link.getAttribute('href');
    if (href && href.includes('order=')) {
      // –û—Ç—Ä–∏–º—É—î–º–æ –ø–∞—Ä–∞–º–µ—Ç—Ä —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –∑ –ø–æ—Å–∏–ª–∞–Ω–Ω—è
      const orderParam = href.split('order=')[1].split('&')[0];
      
      // –Ø–∫—â–æ —Ü–µ –ø–æ—Ç–æ—á–Ω–µ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è, –¥–æ–¥–∞—î–º–æ —Å—Ç–∏–ª—å
      if (orderParam === currentOrder) {
        link.style.color = '#2563eb';
        link.style.fontWeight = '600';
        
        // –ó–Ω–∞—Ö–æ–¥–∏–º–æ —ñ–∫–æ–Ω–∫—É –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è —ñ –¥–æ–¥–∞—î–º–æ –∫–æ–ª—ñ—Ä
        const icon = link.querySelector('.sort-icon');
        if (icon) {
          icon.style.color = '#2563eb';
        }
      }
    }
  });
});
</script>
{% endblock %}