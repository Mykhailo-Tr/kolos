{% extends "base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/journal.css' %}">

<style>
.snapshot-info-card {
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 0.35rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.snapshot-info-card h5 {
    color: #1f2937;
    font-weight: 600;
    margin-bottom: 1rem;
    font-size: 1.1rem;
}

.form-control, .form-select {
    border: 1px solid #d1d5db;
    border-radius: 0.35rem;
    padding: 0.5rem 0.75rem;
    font-size: 0.9rem;
}

.form-control:focus, .form-select:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    outline: none;
}

.stats-badge {
    background: #e0f2fe;
    color: #0369a1;
    padding: 0.5rem 1rem;
    border-radius: 0.35rem;
    font-weight: 600;
    display: inline-block;
    font-size: 0.9rem;
}

.delete-checkbox-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
}

.delete-checkbox-wrapper input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.journal-table tbody tr.marked-for-delete {
    background: #fee2e2 !important;
    opacity: 0.6;
}

.journal-table tbody tr.marked-for-delete:hover {
    background: #fecaca !important;
}

.btn-save-all {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    padding: 0.75rem 2rem;
    border: none;
    border-radius: 0.35rem;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.25s ease;
    cursor: pointer;
}

.btn-save-all:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(16, 185, 129, 0.25);
}

.btn-cancel {
    background: #6b7280;
    color: white;
    padding: 0.75rem 2rem;
    border: none;
    border-radius: 0.35rem;
    font-weight: 600;
    text-decoration: none;
    display: inline-block;
    transition: all 0.25s ease;
}

.btn-cancel:hover {
    background: #4b5563;
    color: white;
    transform: translateY(-1px);
}

.input-in-table {
    width: 100%;
    border: 1px solid #e5e7eb;
    border-radius: 0.25rem;
    padding: 0.4rem 0.6rem;
    font-size: 0.9rem;
    background: white;
}

.input-in-table:focus {
    border-color: #3b82f6;
    outline: none;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
}

.select-in-table {
    width: 100%;
    border: 1px solid #e5e7eb;
    border-radius: 0.25rem;
    padding: 0.4rem 0.6rem;
    font-size: 0.9rem;
    background: white;
}

.select-in-table:focus {
    border-color: #3b82f6;
    outline: none;
}

.actions-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e5e7eb;
}

.sort-link {
    color: inherit;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-weight: 500;
}

.sort-link:hover {
    color: #2563eb;
}

.sort-icon {
    font-size: 0.8rem;
}

/* –°—Ç–∏–ª—ñ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ */
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.page-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #1f2937;
    margin: 0;
}

.btn-add {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    border: none;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-add:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
    color: white;
}

/* –¢–∞–±–ª–∏—Ü—è */
.journal-table {
    width: 100%;
    border-collapse: collapse;
    table-layout: auto;
}

.journal-table th, .journal-table td {
    padding: 0.5rem 0.75rem;
    vertical-align: middle;
    text-align: left;
    word-break: break-word;
}

/* –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —à–∏—Ä–∏–Ω–∏ –∫–æ–ª–æ–Ω–æ–∫ */
.journal-table th:nth-child(1), .journal-table td:nth-child(1) { width: 5%; text-align: center; }  /* # */
.journal-table th:nth-child(2), .journal-table td:nth-child(2) { width: 32.5%; }  /* –ú—ñ—Å—Ü–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è */
.journal-table th:nth-child(3), .journal-table td:nth-child(3) { width: 27.5%; }  /* –ö—É–ª—å—Ç—É—Ä–∞ */
.journal-table th:nth-child(4), .journal-table td:nth-child(4) { width: 15%; }  /* –¢–∏–ø –±–∞–ª–∞–Ω—Å—É */
.journal-table th:nth-child(5), .journal-table td:nth-child(5) { width: 15%; text-align: right; }  /* –ö—ñ–ª—å–∫—ñ—Å—Ç—å */
.journal-table th:nth-child(6), .journal-table td:nth-child(6) { width: 5%; text-align: center; }  /* –í–∏–¥–∞–ª–∏—Ç–∏ */

/* –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫–∏ */
.text-danger {
    color: #dc2626;
    font-size: 0.8rem;
    margin-top: 0.25rem;
}
</style>

<div class="journal-container">
  <div class="page-header">
    <h1 class="page-title">‚úèÔ∏è {{ model_name }}</h1>
    <a href="{% url 'balance_snapshot_detail' snapshot.pk %}" class="btn-add" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);">
      <span>‚Ü©Ô∏è</span>
      <span>–°–∫–∞—Å—É–≤–∞—Ç–∏</span>
    </a>
  </div>

  <form method="post" novalidate>
    {% csrf_token %}
    
    <!-- –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∑–ª—ñ–ø–æ–∫ -->
    <div class="snapshot-info-card">
      <h5>üìä –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∑–ª—ñ–ø–æ–∫</h5>
      <div class="row">
        <div class="col-md-4 mb-3">
          <label class="form-label fw-semibold">{{ snapshot_form.snapshot_date.label }}</label>
          {{ snapshot_form.snapshot_date }}
          {% if snapshot_form.snapshot_date.errors %}
            <small class="text-danger d-block mt-1">{{ snapshot_form.snapshot_date.errors }}</small>
          {% endif %}
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label fw-semibold">{{ snapshot_form.description.label }}</label>
          {{ snapshot_form.description }}
          {% if snapshot_form.description.errors %}
            <small class="text-danger d-block mt-1">{{ snapshot_form.description.errors }}</small>
          {% endif %}
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label fw-semibold">{{ snapshot_form.created_by.label }}</label>
          {{ snapshot_form.created_by }}
          {% if snapshot_form.created_by.errors %}
            <small class="text-danger d-block mt-1">{{ snapshot_form.created_by.errors }}</small>
          {% endif %}
        </div>
      </div>
      <div class="mt-2">
        <span class="stats-badge">üì¶ –í—Å—å–æ–≥–æ –∑–∞–ø–∏—Å—ñ–≤: {{ formset|length }}</span>
      </div>
    </div>

    {{ formset.management_form }}

    <!-- –¢–∞–±–ª–∏—Ü—è –∑–∞–ø–∏—Å—ñ–≤ -->
    {% if formset %}
      <div class="table-wrapper">
        <table class="journal-table">
          <thead>
            <tr>
              <th>#</th>
              <th>
                <a href="?order={% if current_order == 'place__name' %}-place__name{% else %}place__name{% endif %}" class="sort-link">
                  –ú—ñ—Å—Ü–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è
                  <span class="sort-icon">
                    {% if current_order == 'place__name' %}
                      ‚ñ≤
                    {% elif current_order == '-place__name' %}
                      ‚ñº
                    {% else %}
                      ‚áÖ
                    {% endif %}
                  </span>
                </a>
              </th>
              <th>
                <a href="?order={% if current_order == 'culture__name' %}-culture__name{% else %}culture__name{% endif %}" class="sort-link">
                  –ö—É–ª—å—Ç—É—Ä–∞
                  <span class="sort-icon">
                    {% if current_order == 'culture__name' %}
                      ‚ñ≤
                    {% elif current_order == '-culture__name' %}
                      ‚ñº
                    {% else %}
                      ‚áÖ
                    {% endif %}
                  </span>
                </a>
              </th>
              <th>
                <a href="?order={% if current_order == 'balance_type' %}-balance_type{% else %}balance_type{% endif %}" class="sort-link">
                  –¢–∏–ø –±–∞–ª–∞–Ω—Å—É
                  <span class="sort-icon">
                    {% if current_order == 'balance_type' %}
                      ‚ñ≤
                    {% elif current_order == '-balance_type' %}
                      ‚ñº
                    {% else %}
                      ‚áÖ
                    {% endif %}
                  </span>
                </a>
              </th>
              <th>
                <a href="?order={% if current_order == 'quantity' %}-quantity{% else %}quantity{% endif %}" class="sort-link">
                  –ö—ñ–ª—å–∫—ñ—Å—Ç—å (—Ç)
                  <span class="sort-icon">
                    {% if current_order == 'quantity' %}
                      ‚ñ≤
                    {% elif current_order == '-quantity' %}
                      ‚ñº
                    {% else %}
                      ‚áÖ
                    {% endif %}
                  </span>
                </a>
              </th>
              <th>–í–∏–¥–∞–ª–∏—Ç–∏</th>
            </tr>
          </thead>
          <tbody>
            {% for form in formset %}
            <tr class="formset-row" data-form-index="{{ forloop.counter0 }}">
              <td class="text-center">
                {{ forloop.counter }}
                {{ form.id }}  <!-- –ü—Ä–∏—Ö–æ–≤–∞–Ω–µ –ø–æ–ª–µ ID -->
              </td>

              <!-- –ú—ñ—Å—Ü–µ -->
              <td>
                <select name="{{ form.place.html_name }}" class="select-in-table">
                  {% for place in form.fields.place.queryset %}
                    <option value="{{ place.pk }}" 
                      {% if form.place.value|stringformat:"s" == place.pk|stringformat:"s" or form.instance.place and form.instance.place.pk == place.pk %}
                        selected
                      {% endif %}>
                      {{ place.name }}
                    </option>
                  {% endfor %}
                </select>
                {% if form.place.errors %}
                  <small class="text-danger d-block mt-1">{{ form.place.errors }}</small>
                {% endif %}
              </td>

              <!-- –ö—É–ª—å—Ç—É—Ä–∞ -->
              <td>
                <select name="{{ form.culture.html_name }}" class="select-in-table">
                  {% for culture in form.fields.culture.queryset %}
                    <option value="{{ culture.pk }}" 
                      {% if form.culture.value|stringformat:"s" == culture.pk|stringformat:"s" or form.instance.culture and form.instance.culture.pk == culture.pk %}
                        selected
                      {% endif %}>
                      {{ culture.name }}
                    </option>
                  {% endfor %}
                </select>
                {% if form.culture.errors %}
                  <small class="text-danger d-block mt-1">{{ form.culture.errors }}</small>
                {% endif %}
              </td>

              <!-- –¢–∏–ø –±–∞–ª–∞–Ω—Å—É -->
              <td>
                <select name="{{ form.balance_type.html_name }}" class="select-in-table">
                  <option value="stock" {% if form.balance_type.value == 'stock' or form.instance.balance_type == 'stock' %}selected{% endif %}>–ó–µ—Ä–Ω–æ</option>
                  <option value="waste" {% if form.balance_type.value == 'waste' or form.instance.balance_type == 'waste' %}selected{% endif %}>–í—ñ–¥—Ö–æ–¥–∏</option>
                </select>
                {% if form.balance_type.errors %}
                  <small class="text-danger d-block mt-1">{{ form.balance_type.errors }}</small>
                {% endif %}
              </td>

              <!-- –ö—ñ–ª—å–∫—ñ—Å—Ç—å -->
              <td>
                <input type="number" name="{{ form.quantity.html_name }}" 
                       value="{{ form.quantity.value|default:'0.000' }}" 
                       class="input-in-table" step="0.001" min="0" style="text-align:right;">
                {% if form.quantity.errors %}
                  <small class="text-danger d-block mt-1">{{ form.quantity.errors }}</small>
                {% endif %}
              </td>

              <!-- –í–∏–¥–∞–ª–∏—Ç–∏ -->
              <td class="delete-checkbox-wrapper">
                {{ form.DELETE }}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="actions-footer">
        <a href="{% url 'balance_history_create' snapshot.pk %}" class="btn-add" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
          <span>‚ûï</span>
          <span>–î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π –∑–∞–ø–∏—Å</span>
        </a>

        <div style="display:flex; gap:0.75rem;">
          <a href="{% url 'balance_snapshot_detail' snapshot.pk %}" class="btn-cancel">–°–∫–∞—Å—É–≤–∞—Ç–∏</a>
          <button type="submit" class="btn-save-all">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –≤—Å—ñ –∑–º—ñ–Ω–∏</button>
        </div>
      </div>
    {% else %}
      <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>–£ —Ü—å–æ–º—É –∑–ª—ñ–ø–∫—É –Ω–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤.
      </div>
    {% endif %}
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ü—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è —Ä—è–¥–∫—ñ–≤, –ø–æ–∑–Ω–∞—á–µ–Ω–∏—Ö –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è
    const deleteCheckboxes = document.querySelectorAll('input[name$="-DELETE"]');
    
    deleteCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const row = this.closest('tr');
            if (this.checked) {
                row.classList.add('marked-for-delete');
            } else {
                row.classList.remove('marked-for-delete');
            }
        });
        
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–æ—á–∞—Ç–∫–æ–≤–æ–≥–æ —Å—Ç–∞–Ω—É
        if (checkbox.checked) {
            checkbox.closest('tr').classList.add('marked-for-delete');
        }
    });
    
    // –ü—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
    const urlParams = new URLSearchParams(window.location.search);
    const currentOrder = urlParams.get('order') || 'place__name';
    
    const sortLinks = document.querySelectorAll('.sort-link');
    
    sortLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (href && href.includes('order=')) {
            const orderParam = href.split('order=')[1].split('&')[0];
            
            if (orderParam === currentOrder) {
                link.style.color = '#2563eb';
                link.style.fontWeight = '600';
                
                const icon = link.querySelector('.sort-icon');
                if (icon) {
                    icon.style.color = '#2563eb';
                }
            }
        }
    });
    
    // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        const deleteCount = document.querySelectorAll('input[name$="-DELETE"]:checked').length;
        if (deleteCount > 0) {
            if (!confirm(`–í–∏ –¥—ñ–π—Å–Ω–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ ${deleteCount} –∑–∞–ø–∏—Å(—ñ–≤)? –¶—é –¥—ñ—é –Ω–µ –º–æ–∂–Ω–∞ —Å–∫–∞—Å—É–≤–∞—Ç–∏.`)) {
                e.preventDefault();
                return false;
            }
        }
    });
});
</script>
{% endblock %}