{% extends "base.html" %}
{% load humanize %}
{% load static %}

{% block content %}
<style>
/* –°—Ç–∏–ª—ñ –¥–ª—è —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è */
.sort-link {
    color: inherit; /* –∑–∞–±–∏—Ä–∞—î —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π —Å–∏–Ω—ñ–π –∫–æ–ª—ñ—Ä */
    text-decoration: none; /* –ø—Ä–∏–±–∏—Ä–∞—î –ø—ñ–¥–∫—Ä–µ—Å–ª–µ–Ω–Ω—è */
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-weight: 500;
    transition: all 0.1s ease;
}

.sort-link:hover {
    color: #2563eb; /* –º–æ–∂–Ω–∞ –∑—Ä–æ–±–∏—Ç–∏ –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ */
}

.sort-icon {
    font-size: 0.8rem;
}

/* –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –¥–æ —Ç–∞–±–ª–∏—Ü—ñ –∂—É—Ä–Ω–∞–ª—É */
.journal-table {
    width: 100%;
    border-collapse: collapse;
    table-layout: auto; /* —à–∏—Ä–∏–Ω–∞ –ø—ñ–¥–ª–∞—à—Ç–æ–≤—É—î—Ç—å—Å—è –ø—ñ–¥ –≤–º—ñ—Å—Ç */
}

.journal-table th, .journal-table td {
    padding: 0.5rem 0.75rem;
    vertical-align: middle;
    text-align: left;
    word-break: break-word; /* —Ç–µ–∫—Å—Ç –Ω–µ –≤–∏–ª—ñ—Ç–∞—î –∑–∞ –º–µ–∂—ñ */
}

/* –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —à–∏—Ä–∏–Ω–∏ –∫–æ–ª–æ–Ω–æ–∫ */
.journal-table th:nth-child(1), .journal-table td:nth-child(1) { width: 3%; text-align: center; }  /* # */
.journal-table th:nth-child(2), .journal-table td:nth-child(2) { width: 15%; text-align: center; }  /* –î–∞—Ç–∞ */
.journal-table th:nth-child(3), .journal-table td:nth-child(3) { width: 35%; text-align: center; }  /* –û–ø–∏—Å */
.journal-table th:nth-child(4), .journal-table td:nth-child(4) { width: 15%; text-align: center; }  /* –°—Ç–≤–æ—Ä–µ–Ω–æ –∫–∏–º */
.journal-table th:nth-child(5), .journal-table td:nth-child(5) { width: 10%; text-align: center; }  /* –ö—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–ø–∏—Å—ñ–≤ */
.journal-table th:nth-child(6), .journal-table td:nth-child(6) { width: 15%; text-align: center; }  /* –ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å */
.journal-table th:nth-child(7), .journal-table td:nth-child(7) { width: 7%; text-align: center; }   /* –î—ñ—ó */

/* –°—Ç–∏–ª—ñ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥—ñ–π */
.actions-cell {
    display: flex;
    gap: 0.25rem;
    justify-content: center;
}

.btn-action {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border-radius: 6px;
    text-decoration: none;
    font-size: 1rem;
}

.btn-delete {
    background: #ef4444 !important;
    color: white !important;
}

/* –°—Ç–∏–ª—ñ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ */
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.page-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #1f2937;
    margin: 0;
}

.btn-add {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    border: none;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-add:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
    color: white;
}
</style>

<link rel="stylesheet" href="{% static 'css/journal.css' %}">

<div class="journal-container">
<!-- –£ —Ñ–∞–π–ª—ñ snapshot_list.html –¥–æ–¥–∞–π—Ç–µ –¥–æ –±–ª–æ–∫—É –∫–Ω–æ–ø–æ–∫ -->
<div class="page-header">
    <h1 class="page-title">üìä –ó–ª—ñ–ø–∫–∏ –∑–∞–ª–∏—à–∫—ñ–≤</h1>
    <div style="display: flex; gap: 0.75rem;">
      <a href="{% url 'balance_list' %}" class="btn-add" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);">
        <span>‚Ü©Ô∏è</span>
        <span>–î–æ –∑–∞–ª–∏—à–∫—ñ–≤</span>
      </a>
      <!-- –ù–æ–≤–∞ –∫–Ω–æ–ø–∫–∞ –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–ª—ñ–ø–∫–∞ -->
      <a href="{% url 'balance_snapshot_empty_create' %}" class="btn-add" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
        <span>üìÑ</span>
        <span>–ù–æ–≤–∏–π –∑–ª—ñ–ø–æ–∫</span>
      </a>
      <!-- –°—Ç–∞—Ä–∞ –∫–Ω–æ–ø–∫–∞ –¥–ª—è –∑–ª—ñ–ø–∫–∞ –∑ –ø–æ—Ç–æ—á–Ω–∏—Ö –∑–∞–ª–∏—à–∫—ñ–≤ -->
      <button type="button" class="btn-add" data-bs-toggle="modal" data-bs-target="#createSnapshotModal">
        <span>üíæ</span>
        <span>–ó–ª—ñ–ø–æ–∫ –∑ –ø–æ—Ç–æ—á–Ω–∏—Ö –∑–∞–ª–∏—à–∫—ñ–≤</span>
      </button>
    </div>
</div>

  {% if snapshots %}
    <div class="table-wrapper">
      <table class="journal-table">
        <thead>
          <tr>
            <th>#</th>
            <th>
              <a href="?order={% if current_order == 'snapshot_date' %}-snapshot_date{% else %}snapshot_date{% endif %}" class="sort-link">
                –î–∞—Ç–∞ –∑–ª—ñ–ø–∫—É
                <span class="sort-icon">
                  {% if current_order == 'snapshot_date' %}
                    ‚ñ≤
                  {% elif current_order == '-snapshot_date' %}
                    ‚ñº
                  {% else %}
                    ‚áÖ
                  {% endif %}
                </span>
              </a>
            </th>
            <th>–û–ø–∏—Å</th>
            <th>–°—Ç–≤–æ—Ä–µ–Ω–æ</th>
            <th>
              <a href="?order={% if current_order == 'total_records' %}-total_records{% else %}total_records{% endif %}" class="sort-link">
                –ö—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–ø–∏—Å—ñ–≤
                <span class="sort-icon">
                  {% if current_order == 'total_records' %}
                    ‚ñ≤
                  {% elif current_order == '-total_records' %}
                    ‚ñº
                  {% else %}
                    ‚áÖ
                  {% endif %}
                </span>
              </a>
            </th>
            <th>
              <a href="?order={% if current_order == 'total_quantity' %}-total_quantity{% else %}total_quantity{% endif %}" class="sort-link">
                –ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å (—Ç)
                <span class="sort-icon">
                  {% if current_order == 'total_quantity' %}
                    ‚ñ≤
                  {% elif current_order == '-total_quantity' %}
                    ‚ñº
                  {% else %}
                    ‚áÖ
                  {% endif %}
                </span>
              </a>
            </th>
            <th>–î—ñ—ó</th>
          </tr>
        </thead>
        <tbody>
          {% for snapshot in snapshots %}
          <tr>
            <td class="text-center">{{ forloop.counter0|add:page_obj.start_index }}</td>
            <td class="text-center">{{ snapshot.snapshot_date|date:"d.m.Y H:i" }}</td>
            <td>{{ snapshot.description|default:"‚Äî" }}</td>
            <td class="text-center">{{ snapshot.created_by }}</td>
            <td class="text-center">{{ snapshot.total_records }}</td>
            <td class="text-end">{{ snapshot.total_quantity|floatformat:3 }}</td>
            <td>
              <div class="actions-cell">
                <a href="{% url 'balance_snapshot_detail' snapshot.pk %}" class="btn-action" style="background: #3b82f6; color: white;" title="–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏">üëÅÔ∏è</a>
                <a href="{% url 'balance_snapshot_update' snapshot.pk %}" class="btn-action" style="background: #fbbf24; color: white;" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">‚úèÔ∏è</a>
                <a href="{% url 'balance_snapshot_delete' snapshot.pk %}" class="btn-action btn-delete" title="–í–∏–¥–∞–ª–∏—Ç–∏">üóëÔ∏è</a>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- ===== –ü–∞–≥—ñ–Ω–∞—Ü—ñ—è ===== -->
    {% if is_paginated %}
      <nav aria-label="Page navigation" class="mt-3">
        <ul class="pagination justify-content-center">
          {% if page_obj.has_previous %}
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.order %}&order={{ request.GET.order }}{% endif %}">‚Äπ</a></li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">‚Äπ</span></li>
          {% endif %}

          {% for num in paginator.page_range %}
            {% if num == page_obj.number %}
              <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% else %}
              <li class="page-item"><a class="page-link" href="?page={{ num }}{% if request.GET.order %}&order={{ request.GET.order }}{% endif %}">{{ num }}</a></li>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.order %}&order={{ request.GET.order }}{% endif %}">‚Ä∫</a></li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">‚Ä∫</span></li>
          {% endif %}
        </ul>
      </nav>
    {% endif %}
  {% else %}
    <div class="alert-info">–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö –∑–ª—ñ–ø–∫—ñ–≤ –∑–∞–ª–∏—à–∫—ñ–≤.</div>
  {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–ª—ñ–ø–∫—É -->
<div class="modal fade" id="createSnapshotModal" tabindex="-1" aria-labelledby="createSnapshotModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createSnapshotModalLabel">üíæ –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–ª—ñ–ø–æ–∫ –∑–∞–ª–∏—à–∫—ñ–≤</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä–∏—Ç–∏"></button>
      </div>
      <form method="post" action="{% url 'balance_snapshot_create' %}">
        {% csrf_token %}
        <div class="modal-body">
          <div class="mb-3">
            <label for="description" class="form-label">–û–ø–∏—Å –∑–ª—ñ–ø–∫—É (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
            <input type="text" class="form-control" id="description" name="description" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ó–∞–ª–∏—à–∫–∏ –Ω–∞ –∫—ñ–Ω–µ—Ü—å –º—ñ—Å—è—Ü—è">
            <div class="form-text">–î–æ–¥–∞–π—Ç–µ –æ–ø–∏—Å, —â–æ–± –ª–µ–≥–∫–æ –∑–Ω–∞–π—Ç–∏ —Ü–µ–π –∑–ª—ñ–ø–æ–∫ –ø—ñ–∑–Ω—ñ—à–µ</div>
          </div>
          <div class="alert alert-info mb-0">
            <strong>‚ÑπÔ∏è –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è:</strong> –ë—É–¥–µ –∑–±–µ—Ä–µ–∂–µ–Ω–æ –ø–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω –≤—Å—ñ—Ö –∑–∞–ª–∏—à–∫—ñ–≤ –Ω–∞ —Å–∫–ª–∞–¥–∞—Ö.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
          <button type="submit" class="btn btn-primary">üíæ –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–ª—ñ–ø–æ–∫</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// –î–æ–¥–∞—î–º–æ JavaScript –¥–ª—è –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
document.addEventListener('DOMContentLoaded', function() {
  const urlParams = new URLSearchParams(window.location.search);
  const currentOrder = urlParams.get('order') || '-snapshot_date';
  
  // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –≤—Å—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
  const sortLinks = document.querySelectorAll('.sort-link');
  
  sortLinks.forEach(link => {
    const href = link.getAttribute('href');
    if (href && href.includes('order=')) {
      // –û—Ç—Ä–∏–º—É—î–º–æ –ø–∞—Ä–∞–º–µ—Ç—Ä —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –∑ –ø–æ—Å–∏–ª–∞–Ω–Ω—è
      const orderParam = href.split('order=')[1].split('&')[0];
      
      // –Ø–∫—â–æ —Ü–µ –ø–æ—Ç–æ—á–Ω–µ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è, –¥–æ–¥–∞—î–º–æ —Å—Ç–∏–ª—å
      if (orderParam === currentOrder) {
        link.style.color = '#2563eb';
        link.style.fontWeight = '600';
        
        // –ó–Ω–∞—Ö–æ–¥–∏–º–æ —ñ–∫–æ–Ω–∫—É –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è —ñ –¥–æ–¥–∞—î–º–æ –∫–æ–ª—ñ—Ä
        const icon = link.querySelector('.sort-icon');
        if (icon) {
          icon.style.color = '#2563eb';
        }
      }
    }
  });
});
</script>
{% endblock %}