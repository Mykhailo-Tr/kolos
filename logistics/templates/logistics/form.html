{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h3 class="mb-3">
    {% if view.object %}
      ‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è: {{ view.object }}
    {% else %}
      ‚ûï –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É
    {% endif %}
  </h3>

  <form method="post" novalidate>
    {% csrf_token %}
    
    {% if form.non_field_errors %}
      <div class="alert alert-danger">
        {% for error in form.non_field_errors %}
          <div>{{ error }}</div>
        {% endfor %}
      </div>
    {% endif %}
    
    <div class="row g-3">
      {% for field in form.visible_fields %}
        
        {% comment %} 
        –û–±—Ä–æ–±–∫–∞ –≤–∞–≥–æ–≤–∏—Ö –ø–æ–ª—ñ–≤ –∑ —ñ–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–∏–º–∏ –ø–µ—Ä–µ–º–∏–∫–∞—á–∞–º–∏ –æ–¥–∏–Ω–∏—Ü—å.
        –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –æ–∫—Ä–µ–º—ñ if/elif –≥—ñ–ª–∫–∏ –∑ –ø–æ–≤–Ω–∏–º –±–ª–æ–∫–æ–º {% with %} / {% endwith %} 
        –¥–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–æ—ó —Ä–æ–±–æ—Ç–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –≤ Django —à–∞–±–ª–æ–Ω–∞—Ö.
        {% endcomment %}
        
        {% if field.name == 'weight_gross' %}
            {% with unit_field=form.gross_unit %}
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="{{ field.id_for_label }}" class="form-label fw-semibold">
                        {{ field.label }}
                        <span class="weight-unit-label-span" data-field-name="{{ field.name }}">
                            ({{ unit_field.value|default:'—Ç' }})
                        </span>
                        {% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                    </label>
                    
                    <div class="input-group">
                        {{ field }}
                        <span class="input-group-text p-0">
                            {{ unit_field }}
                        </span>
                    </div>
                    
                    <div class="form-text mt-1 conversion-display" data-field-name="{{ field.name }}"></div>
                    
                    {% if field.help_text %}
                        <div class="form-text">{{ field.help_text }}</div>
                    {% endif %}
                    {% for error in field.errors %}
                        <div class="text-danger small">{{ error }}</div>
                    {% endfor %}
                </div>
            </div>
            {% endwith %}
        
        {% elif field.name == 'weight_tare' %}
            {% with unit_field=form.tare_unit %}
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="{{ field.id_for_label }}" class="form-label fw-semibold">
                        {{ field.label }}
                        <span class="weight-unit-label-span" data-field-name="{{ field.name }}">
                            ({{ unit_field.value|default:'—Ç' }})
                        </span>
                        {% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                    </label>
                    
                    <div class="input-group">
                        {{ field }}
                        <span class="input-group-text p-0">
                            {{ unit_field }}
                        </span>
                    </div>
                    
                    <div class="form-text mt-1 conversion-display" data-field-name="{{ field.name }}"></div>
                    
                    {% if field.help_text %}
                        <div class="form-text">{{ field.help_text }}</div>
                    {% endif %}
                    {% for error in field.errors %}
                        <div class="text-danger small">{{ error }}</div>
                    {% endfor %}
                </div>
            </div>
            {% endwith %}

        {% elif field.name == 'weight_loss' %}
            {% with unit_field=form.loss_unit %}
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="{{ field.id_for_label }}" class="form-label fw-semibold">
                        {{ field.label }}
                        <span class="weight-unit-label-span" data-field-name="{{ field.name }}">
                            ({{ unit_field.value|default:'—Ç' }})
                        </span>
                        {% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                    </label>
                    
                    <div class="input-group">
                        {{ field }}
                        <span class="input-group-text p-0">
                            {{ unit_field }}
                        </span>
                    </div>
                    
                    <div class="form-text mt-1 conversion-display" data-field-name="{{ field.name }}"></div>
                    
                    {% if field.help_text %}
                        <div class="form-text">{{ field.help_text }}</div>
                    {% endif %}
                    {% for error in field.errors %}
                        <div class="text-danger small">{{ error }}</div>
                    {% endfor %}
                </div>
            </div>
            {% endwith %}
            
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label fw-semibold">–í–∞–≥–∞ –Ω–µ—Ç—Ç–æ (—Ç)</label>
                <input
                  type="number"
                  id="weight-net-display"
                  class="form-control"
                  step="0.001"
                  readonly
                >
                <div class="form-text">–†–æ–∑—Ä–∞—Ö–æ–≤—É—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤ —Ç–æ–Ω–Ω–∞—Ö</div>
              </div>
            </div>

        {% elif field.name != 'gross_unit' and field.name != 'tare_unit' and field.name != 'loss_unit' and field.name != 'action_type' and field.name != 'note' %}
          <div class="col-md-6">
            <div class="mb-3">
              <label for="{{ field.id_for_label }}" class="form-label fw-semibold">
                {{ field.label }}{% if field.field.required %}<span class="text-danger">*</span>{% endif %}
              </label>
              {{ field }}
              {% if field.help_text %}
                <div class="form-text">{{ field.help_text }}</div>
              {% endif %}
              {% for error in field.errors %}
                <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            </div>
          </div>
        
        {% elif field.name == 'action_type' or field.name == 'note' %}
          <div class="col-md-12">
            <div class="mb-3">
              <label for="{{ field.id_for_label }}" class="form-label fw-semibold">
                {{ field.label }}{% if field.field.required %}<span class="text-danger">*</span>{% endif %}
              </label>
              {{ field }}
              {% if field.help_text %}
                <div class="form-text">{{ field.help_text }}</div>
              {% endif %}
              {% for error in field.errors %}
                <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>
    
    <div class="mt-4 d-flex gap-2">
      <button type="submit" class="btn btn-primary">
        üíæ –ó–±–µ—Ä–µ–≥—Ç–∏
      </button>
      <a href="{% url url_name|add:'_list' %}" class="btn btn-secondary">
        ‚¨Ö –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ —Å–ø–∏—Å–∫—É
      </a>
    </div>
  </form>
</div>
<style>
/* –û—Å–Ω–æ–≤–Ω–∏–π —Å—Ç–∏–ª—å Select2 –ø—ñ–¥ Bootstrap */
.select2-container .select2-selection--single {
    height: 38px !important;
    padding: 6px 12px;
    border: 1px solid #ced4da;
    border-radius: 6px;
    font-size: 1rem;
    display: flex;
    align-items: center;
}
.select2-selection__rendered {
    color: #212529 !important;
    line-height: 26px !important;
}
/* ... (—Å—Ç–∏–ª—ñ Select2) ... */
.select2-container--default .select2-results__option {
    padding: 8px 12px;
}
.select2-container--default .select2-results__option--highlighted {
    background-color: #0d6efd !important;
    color: white !important;
}
.select2-container--default .select2-selection--multiple {
    min-height: 38px;
    border: 1px solid #ced4da;
    border-radius: 6px;
    padding: 2px 6px;
}
/* –°—Ç–∏–ª—å –¥–ª—è –ø–µ—Ä–µ–º–∏–∫–∞—á–∞ –æ–¥–∏–Ω–∏—Ü—å */
.unit-switcher {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
    width: 120px !important; /* –®–∏—Ä–∏–Ω–∞ –¥–ª—è '–¢–æ–Ω–Ω–∏ (—Ç)' */
}
</style>

<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

<script>
$(document).ready(function() {
    
    // –ö–∞—Ä—Ç–∞ –¥–ª—è –ø—Ä–∏–≤'—è–∑–∫–∏ –ø–æ–ª—è –≤–∞–≥–∏ –¥–æ –π–æ–≥–æ –ø–µ—Ä–µ–º–∏–∫–∞—á–∞ –æ–¥–∏–Ω–∏—Ü—å
    const unitMap = {
        '#id_weight_gross': '#id_gross_unit',
        '#id_weight_tare': '#id_tare_unit',
        '#id_weight_loss': '#id_loss_unit'
    };
    
    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è —á–∏—Å–ª–∞:
    // - –Ø–∫—â–æ —á–∏—Å–ª–æ —Ü—ñ–ª–µ, –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î –±–µ–∑ –¥—Ä–æ–±–æ–≤–æ—ó —á–∞—Å—Ç–∏–Ω–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 1 000 –∫–≥).
    // - –Ø–∫—â–æ —á–∏—Å–ª–æ –¥—Ä–æ–±–æ–≤–µ, –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î –∑ —Ç—Ä—å–æ–º–∞ –∑–Ω–∞–∫–∞–º–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 1 000,500 –∫–≥).
    const formatNumber = (num) => {
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —î —á–∏—Å–ª–æ —Ü—ñ–ª–∏–º
        if (num === Math.floor(num)) {
            // –Ø–∫—â–æ —Ü—ñ–ª–µ: –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ 0 –¥—Ä–æ–±—ñ–≤, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ 0 –¥—Ä–æ–±—ñ–≤
            return num.toLocaleString('uk-UA', { 
                minimumFractionDigits: 0, 
                maximumFractionDigits: 0 
            });
        } else {
            // –Ø–∫—â–æ –¥—Ä–æ–±–æ–≤–µ: –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ 3 –¥—Ä–æ–±–∏, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ 3 –¥—Ä–æ–±–∏
            return num.toLocaleString('uk-UA', { 
                minimumFractionDigits: 3, 
                maximumFractionDigits: 3 
            });
        }
    };

    // Helper: –ö–æ–Ω–≤–µ—Ä—Ç—É—î –∑–Ω–∞—á–µ–Ω–Ω—è –∑ –≤–∫–∞–∑–∞–Ω–æ—ó –æ–¥–∏–Ω–∏—Ü—ñ ('t' –∞–±–æ 'kg') —É –¢–æ–Ω–Ω–∏
    function convertToTons(value, unit) {
        if (unit === 'kg') {
            return value / 1000;
        }
        return value; // –í–∂–µ –≤ —Ç–æ–Ω–Ω–∞—Ö
    }

    // 1. –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –º—ñ—Ç–æ–∫ —Ç–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó –¥–ª—è –û–î–ù–û–ì–û –ø–æ–ª—è
    function updateWeightDisplay(weightInput) {
        const weightSelector = '#' + weightInput.attr('id');
        const unitSelector = unitMap[weightSelector];
        
        if (!unitSelector) return;
        
        const unitSwitcher = $(unitSelector);
        const fieldName = weightInput.attr('name');
        
        // –ó–∞–º—ñ–Ω—é—î–º–æ –∫–æ–º—É –Ω–∞ –∫—Ä–∞–ø–∫—É –¥–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥—É
        const rawValue = weightInput.val();
        const value = parseFloat(rawValue.replace(/,/g, '.')) || 0; 
        const unit = unitSwitcher.val() || 't';
        
        const unitLabelSpan = $(`.weight-unit-label-span[data-field-name="${fieldName}"]`);
        const conversionDisplay = $(`.conversion-display[data-field-name="${fieldName}"]`);
        
        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–ø–∏—Å—É –æ–¥–∏–Ω–∏—Ü—ñ –≤ –¥—É–∂–∫–∞—Ö
        const shortUnit = unit === 't' ? '—Ç' : '–∫–≥';
        unitLabelSpan.text(`(${shortUnit})`);
        
        let displayHTML = '';
        if (rawValue.length > 0 && !isNaN(value) && value >= 0) {
            let convertedValue;
            let convertedUnit;

            if (unit === 't') {
                // –Ø–∫—â–æ –≤–≤–µ–¥–µ–Ω–æ —Ç–æ–Ω–Ω–∏, –ø–æ–∫–∞–∑—É—î–º–æ —Å–∫—ñ–ª—å–∫–∏ —Ü–µ –∫—ñ–ª–æ–≥—Ä–∞–º—ñ–≤ (t -> kg)
                convertedValue = value * 1000;
                convertedUnit = '–∫–≥';
            } else if (unit === 'kg') {
                // –Ø–∫—â–æ –≤–≤–µ–¥–µ–Ω–æ –∫—ñ–ª–æ–≥—Ä–∞–º–∏, –ø–æ–∫–∞–∑—É—î–º–æ —Å–∫—ñ–ª—å–∫–∏ —Ü–µ —Ç–æ–Ω–Ω (kg -> t)
                convertedValue = value / 1000;
                convertedUnit = '—Ç';
            }
            // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –æ–Ω–æ–≤–ª–µ–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é formatNumber
            displayHTML = `–¶–µ –ø—Ä–∏–±–ª–∏–∑–Ω–æ <strong>${formatNumber(convertedValue)} ${convertedUnit}</strong>.`;
        }
        
        conversionDisplay.html(displayHTML);
    }
    
    // 2. –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –í–°–Ü–• –≤–∞–≥–æ–≤–∏—Ö –ø–æ–ª—ñ–≤
    function updateAllWeightDisplays() {
        for (const selector in unitMap) {
            updateWeightDisplay($(selector));
        }
    }


    // 3. –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –í–∞–≥–∏ –Ω–µ—Ç—Ç–æ (–≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –≤ —Ç–æ–Ω–Ω–∞—Ö)
    function calculateNet() {
        // 1. –ó—á–∏—Ç—É—î–º–æ —Å–∏—Ä—ñ –∑–Ω–∞—á–µ–Ω–Ω—è —Ç–∞ —ó—Ö –æ–¥–∏–Ω–∏—Ü—ñ
        const rawGross = parseFloat($('#id_weight_gross').val().replace(/,/g, '.')) || 0;
        const grossUnit = $('#id_gross_unit').val() || 't';

        const rawTare = parseFloat($('#id_weight_tare').val().replace(/,/g, '.')) || 0;
        const tareUnit = $('#id_tare_unit').val() || 't';

        const rawLoss = parseFloat($('#id_weight_loss').val().replace(/,/g, '.')) || 0;
        const lossUnit = $('#id_loss_unit').val() || 't';

        // 2. –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ –≤—Å—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –≤ —Ç–æ–Ω–Ω–∏
        const grossTons = convertToTons(rawGross, grossUnit);
        const tareTons = convertToTons(rawTare, tareUnit);
        const lossTons = convertToTons(rawLoss, lossUnit);
        
        // 3. –†–æ–∑—Ä–∞—Ö–æ–≤—É—î–º–æ –Ω–µ—Ç—Ç–æ –≤ —Ç–æ–Ω–Ω–∞—Ö
        const netTons = grossTons - tareTons - lossTons;
        
        // 4. –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–≤ —Ç–æ–Ω–Ω–∞—Ö)
        $('#weight-net-display').val(netTons.toFixed(3));
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó –¥–ª—è –≤—Å—ñ—Ö –≤–∞–≥–æ–≤–∏—Ö –ø–æ–ª—ñ–≤
        updateAllWeightDisplays();
    }
    

    // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π
    
    // –ü–æ–¥—ñ—è –∑–º—ñ–Ω–∏ –≤–≤–æ–¥—É –Ω–∞ –≤–∞–≥–æ–≤–∏—Ö –ø–æ–ª—è—Ö
    for (const selector in unitMap) {
        $(selector).on('input', calculateNet);
    }

    // –ü–æ–¥—ñ—è –∑–º—ñ–Ω–∏ –ø–µ—Ä–µ–º–∏–∫–∞—á–∞ –æ–¥–∏–Ω–∏—Ü—å
    for (const selector in unitMap) {
        const unitSelector = unitMap[selector];
        $(unitSelector).on('change', calculateNet);
    }

    // –ü–æ—á–∞—Ç–∫–æ–≤–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Ç–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
    calculateNet();

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Select2 –¥–ª—è –≤—Å—ñ—Ö select –ø–æ–ª—ñ–≤
    $('select:not(.unit-switcher)').select2({
        width: '100%',
        language: 'uk',
        placeholder: '–û–±–µ—Ä—ñ—Ç—å –∑–Ω–∞—á–µ–Ω–Ω—è...',
        allowClear: true
    });
});
</script>
{% endblock %}