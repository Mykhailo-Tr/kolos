{% extends "base.html" %}
{% load humanize %}
{% load static %}
{% load sort_tags %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/journal.css' %}">
<link rel="stylesheet" href="{% static 'logistics/sort_link.css' %}">

<style>
/* --- –í–ò–°–û–ö–û–ö–û–ù–¢–†–ê–°–¢–ù–ò–ô –°–ï–ì–ú–ï–ù–¢–û–í–ê–ù–ò–ô –ü–ï–†–ï–ú–ò–ö–ê–ß –û–î–ò–ù–ò–¶–¨ (KG/T Segmented Control) --- */
.unit-switch {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 15px; /* –í—ñ–¥—Å—Ç–∞–Ω—å –¥–æ –∫–Ω–æ–ø–∫–∏ "–î–æ–¥–∞—Ç–∏ –∑–∞–ø–∏—Å" */
    margin-bottom: 15px;
    font-family: "Inter", sans-serif;
    user-select: none;
}

.segmented-control {
    display: flex;
    background-color: #e2e8f0; /* –°–≤—ñ—Ç–ª–æ-—Å—ñ—Ä–∏–π, –∞–ª–µ –±—ñ–ª—å—à –Ω–∞—Å–∏—á–µ–Ω–∏–π —Ñ–æ–Ω (slate-200) */
    border-radius: 10px;
    padding: 3px;
    position: relative;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15); /* –í–∏—Ä–∞–∑–Ω—ñ—à–∞ —Ç—ñ–Ω—å */
}

.control-item {
    padding: 7px 16px; 
    font-size: 0.95rem;
    font-weight: 700; /* –ñ–∏—Ä–Ω–∏–π —à—Ä–∏—Ñ—Ç –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç—É */
    color: #475569; /* –¢–µ–º–Ω–æ-—Å—ñ—Ä–∏–π —Ç–µ–∫—Å—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—ó –æ–¥–∏–Ω–∏—Ü—ñ */
    cursor: pointer;
    z-index: 1;
    transition: color 0.3s ease;
    min-width: 45px;
    text-align: center;
    line-height: 1.2;
}

.control-item.active {
    color: #1e293b; /* –ú–∞–π–∂–µ —á–æ—Ä–Ω–∏–π —Ç–µ–∫—Å—Ç –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–∞—Å—Ç—É */
}

/* –ü—Ä–∏—Ö–æ–≤–∞–Ω–∏–π —á–µ–∫–±–æ–∫—Å */
.toggle-input {
    display: none;
}

/* –ü–æ–≤–∑—É–Ω–æ–∫ (—ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å—Ç–∞–Ω—É) */
.toggle-slider {
    position: absolute;
    top: 3px;
    left: 3px;
    height: calc(100% - 6px); /* –í–∏—Å–æ—Ç–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
    width: calc(50% - 3px); /* –®–∏—Ä–∏–Ω–∞ 50% –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
    background: #ffffff; /* –ß–∏—Å—Ç–∏–π –±—ñ–ª–∏–π —Ñ–æ–Ω */
    border-radius: 8px;
    /* –Ø—Å–∫—Ä–∞–≤—ñ—à–∞, –±—ñ–ª—å—à –≥–ª–∏–±–æ–∫–∞ —Ç—ñ–Ω—å */
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08); 
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 0;
}

/* –ü–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è –ø–æ–≤–∑—É–Ω–∫–∞ –Ω–∞ "–∫–≥" (–ø—Ä–∏ checked=true) */
.toggle-input:checked ~ .toggle-slider {
    transform: translateX(100%);
}

/* –î–æ–¥–∞—Ç–∫–æ–≤–∏–π –µ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ –Ω–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏–π –µ–ª–µ–º–µ–Ω—Ç */
.control-item:hover {
    color: #0f172a; 
}
.control-item.active:hover {
    color: #1e293b;
}
</style>

<div class="journal-container">

    <div class="page-header">
        <h1 class="page-title">üì¶ {{ model_name }}</h1>

        <div class="unit-switch" id="unitSwitchContainer">
            
            <div class="segmented-control">
                <input type="checkbox" id="unitToggle" class="toggle-input">
                
                <label for="unitToggle" class="control-item" data-unit="t" id="labelT">—Ç</label>
                <label for="unitToggle" class="control-item" data-unit="kg" id="labelKG">–∫–≥</label>

                <span class="toggle-slider"></span>
            </div>
            
            {% if url_name == 'fieldsincome' %}
                <a href="{% url 'fields_income_create' %}" class="btn-add"><span>‚ûï</span><span>–î–æ–¥–∞—Ç–∏ –∑–∞–ø–∏—Å</span></a>
            {% elif url_name == 'shipmentjournal' %}
                <a href="{% url 'shipment_journal_create' %}" class="btn-add"><span>‚ûï</span><span>–î–æ–¥–∞—Ç–∏ –∑–∞–ø–∏—Å</span></a>
            {% elif url_name == 'weigherjournal' %}
                <a href="{% url 'weigher_journal_create' %}" class="btn-add"><span>‚ûï</span><span>–î–æ–¥–∞—Ç–∏ –∑–∞–ø–∏—Å</span></a>
            {% endif %}
        </div>
    </div>

    {% if journals %}
        <div class="table-wrapper">
            <table class="journal-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>{% sort_link request "date_time" "–î–∞—Ç–∞ —ñ —á–∞—Å" %}</th>
                        <th>{% sort_link request "document_number" "–î–æ–∫—É–º–µ–Ω—Ç" %}</th>
                        <th>{% sort_link request "culture__name" "–ö—É–ª—å—Ç—É—Ä–∞" %}</th>

                        {# --- –£–ú–û–í–ù–Ü –ö–û–õ–û–ù–ö–ò –ó–ê–õ–ï–ñ–ù–û –í–Ü–î –¢–ò–ü–£ –ñ–£–†–ù–ê–õ–£ --- #}
                        {% if url_name == 'fieldsincome' %}
                            <th>{% sort_link request "field__name" "–ü–æ–ª–µ" %}</th>
                            <th>{% sort_link request "place_to__name" "–î–æ –º—ñ—Å—Ü—è" %}</th>

                        {% elif url_name == 'shipmentjournal' %}
                            <th>{% sort_link request "place_from__name" "–ó –º—ñ—Å—Ü—è" %}</th>
                            <th>{% sort_link request "place_to__name" "–î–æ –º—ñ—Å—Ü—è" %}</th>

                        {% elif url_name == 'weigherjournal' %}
                            <th>{% sort_link request "from_place__name" "–ó –º—ñ—Å—Ü—è" %}</th>
                            <th>{% sort_link request "to_place__name" "–î–æ –º—ñ—Å—Ü—è" %}</th>
                        {% endif %}

                        {# --- –í–ê–ì–û–í–Ü –ö–û–õ–û–ù–ö–ò (–°–ø—ñ–ª—å–Ω—ñ) --- #}
                        <th id="header-gross">{% sort_link request "weight_gross" "–í–∞–≥–∞ –±—Ä—É—Ç—Ç–æ" %}</th>
                        <th id="header-tare">{% sort_link request "weight_tare" "–í–∞–≥–∞ —Ç–∞—Ä–∞" %}</th>
                        <th id="header-loss">{% sort_link request "weight_loss" "–í–∞–≥–∞ –≤—Ç—Ä–∞—Ç" %}</th>
                        <th id="header-net">{% sort_link request "weight_net" "–í–∞–≥–∞ –Ω–µ—Ç—Ç–æ" %}</th>
                        <th>–î—ñ—ó</th>
                    </tr>
                </thead>

                <tbody>
                    {% for journal in journals %}
                    <tr>
                        <td class="text-center">{{ forloop.counter }}</td>
                        <td>{{ journal.date_time|date:"d.m.Y H:i" }}</td>
                        <td>{{ journal.document_number }}</td>
                        <td>{{ journal.culture }}</td>

                        {# --- –£–ú–û–í–ù–Ü –î–ê–ù–Ü –ó–ê–õ–ï–ñ–ù–û –í–Ü–î –¢–ò–ü–£ –ñ–£–†–ù–ê–õ–£ --- #}
                        {% if url_name == 'fieldsincome' %}
                            <td>{{ journal.field }}</td>
                            <td>{{ journal.place_to }}</td>

                        {% elif url_name == 'shipmentjournal' %}
                            <td>
                                {% if journal.place_from %}{{ journal.place_from }}{% else %}{{ journal.place_from_text }}{% endif %}
                            </td>
                            <td>
                                {% if journal.place_to %}{{ journal.place_to }}{% else %}{{ journal.place_to_text }}{% endif %}
                            </td>

                        {% elif url_name == 'weigherjournal' %}
                            <td>{{ journal.from_place }}</td>
                            <td>{{ journal.to_place }}</td>
                        {% endif %}


                        {# --- –í–ê–ì–û–í–Ü –î–ê–ù–Ü (–°–ø—ñ–ª—å–Ω—ñ) --- #}
                        <td class="text-end">
                            <span class="weight-value" data-t="{{ journal.weight_gross|default:0 }}">
                                {{ journal.weight_gross|default:0|floatformat:3 }}
                            </span>
                        </td>

                        <td class="text-end">
                            <span class="weight-value" data-t="{{ journal.weight_tare|default:0 }}">
                                {{ journal.weight_tare|default:0|floatformat:3 }}
                            </span>
                        </td>

                        <td class="text-end">
                            <span class="weight-value" data-t="{{ journal.weight_loss|default:0 }}">
                                {{ journal.weight_loss|default:0|floatformat:3 }}
                            </span>
                        </td>

                        <td class="text-end">
                            <span class="weight-value quantity-value" data-t="{{ journal.weight_net|default:0 }}">
                                {{ journal.weight_net|default:0|floatformat:3 }}
                            </span>
                        </td>

                        {# --- –î–Ü–á (URLs –∑–∞–ª–µ–∂–∞—Ç—å –≤—ñ–¥ —Ç–∏–ø—É –∂—É—Ä–Ω–∞–ª—É) --- #}
                        <td>
                            <div class="actions-cell">
                                {% if url_name == 'fieldsincome' %}
                                    <a href="{% url 'fields_income_update' journal.pk %}" class="btn-action btn-edit" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">‚úèÔ∏è</a>
                                    <a href="{% url 'fields_income_delete' journal.pk %}" class="btn-action btn-delete" title="–í–∏–¥–∞–ª–∏—Ç–∏">üóëÔ∏è</a>
                                
                                {% elif url_name == 'shipmentjournal' %}
                                    <a href="{% url 'shipment_journal_update' journal.pk %}" class="btn-action btn-edit" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">‚úèÔ∏è</a>
                                    <a href="{% url 'shipment_journal_delete' journal.pk %}" class="btn-action btn-delete" title="–í–∏–¥–∞–ª–∏—Ç–∏">üóëÔ∏è</a>
                                
                                {% elif url_name == 'weigherjournal' %}
                                    <a href="{% url 'weigher_journal_update' journal.pk %}" class="btn-action btn-edit" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">‚úèÔ∏è</a>
                                    <a href="{% url 'weigher_journal_delete' journal.pk %}" class="btn-action btn-delete" title="–í–∏–¥–∞–ª–∏—Ç–∏">üóëÔ∏è</a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if is_paginated %}
        <div class="pagination-wrapper">
            <ul class="pagination">
                {% if page_obj.has_previous %}
                    <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">¬´</a></li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">¬´</span></li>
                {% endif %}

                {% for i in paginator.page_range %}
                    {% if page_obj.number == i %}
                        <li class="page-item active"><span class="page-link">{{ i }}</span></li>
                    {% else %}
                        <li class="page-item"><a class="page-link" href="?page={{ i }}">{{ i }}</a></li>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                    <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">¬ª</a></li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">¬ª</span></li>
                {% endif %}
            </ul>
        </div>
        {% endif %}

    {% else %}
        <div class="alert-info">–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤ —É –∂—É—Ä–Ω–∞–ª—ñ.</div>
    {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const toggle = document.getElementById("unitToggle");
    const values = document.querySelectorAll(".weight-value");
    const tLabel = document.getElementById('labelT');
    const kgLabel = document.getElementById('labelKG');

    // –û—Ç—Ä–∏–º—É—î–º–æ –µ–ª–µ–º–µ–Ω—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤ —Ç–∞–±–ª–∏—Ü—ñ –∑–∞ ID
    const headers = {
        gross: document.getElementById("header-gross"),
        tare: document.getElementById("header-tare"),
        loss: document.getElementById("header-loss"),
        net: document.getElementById("header-net")
    };
    
    // –ë–∞–∑–æ–≤—ñ –Ω–∞–∑–≤–∏ –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤
    const baseHeaders = {
        gross: "–í–∞–≥–∞ –±—Ä—É—Ç—Ç–æ",
        tare: "–í–∞–≥–∞ —Ç–∞—Ä–∞",
        loss: "–í–∞–≥–∞ –≤—Ç—Ä–∞—Ç",
        net: "–í–∞–≥–∞ –Ω–µ—Ç—Ç–æ"
    };

    /**
     * –§–æ—Ä–º–∞—Ç—É—î —á–∏—Å–ª–æ, –¥–æ–¥–∞—é—á–∏ –ø—Ä–æ–±—ñ–ª–∏ —è–∫ —Ä–æ–∑–¥—ñ–ª—å–Ω–∏–∫ —Ç–∏—Å—è—á.
     */
    function formatNumberWithSpaces(num) {
        return num.toLocaleString('uk-UA', { 
            maximumFractionDigits: 0,
            minimumFractionDigits: 0
        }).replace(/\s/g, '\u00A0'); 
    }

    /**
     * –û–Ω–æ–≤–ª—é—î —Ç–µ–∫—Å—Ç –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤ —Ç–∞–±–ª–∏—Ü—ñ, –¥–æ–¥–∞—é—á–∏ –æ–¥–∏–Ω–∏—Ü—é –≤–∏–º—ñ—Ä—É (—Ç/–∫–≥).
     */
    function updateHeader(key, unitText) {
        const headerElement = headers[key];
        const sortLinkAnchor = headerElement ? headerElement.querySelector('a') : null;
        const newText = `${baseHeaders[key]} (${unitText})`;
        
        if (sortLinkAnchor) {
            let foundTextNode = false;
            sortLinkAnchor.childNodes.forEach(node => {
                if (node.nodeType === 3) { // Text node
                    node.textContent = newText;
                    foundTextNode = true;
                }
            });
            if (!foundTextNode) {
                 sortLinkAnchor.textContent = newText;
            }
        } else if (headerElement) {
             headerElement.textContent = newText;
        }
    }

    function updateUnits() {
        // –†–µ–∂–∏–º: false = —Ç (unchecked/–ª—ñ–≤–æ—Ä—É—á), true = –∫–≥ (checked/–ø—Ä–∞–≤–æ—Ä—É—á)
        const modeKG = toggle.checked; 

        // 1. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–Ω–∞—á–µ–Ω—å
        values.forEach(v => {
            let tons = parseFloat(v.dataset.t);
            if (isNaN(tons)) tons = 0;

            if (modeKG) {
                // —Ä–µ–∂–∏–º –∫–≥: –∑–Ω–∞—á–µ–Ω–Ω—è * 1000, –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è –¥–æ —Ü—ñ–ª–æ–≥–æ, —Ä–æ–∑–¥—ñ–ª—å–Ω–∏–∫ —Ç–∏—Å—è—á
                const kgValue = Math.round(tons * 1000); 
                v.textContent = formatNumberWithSpaces(kgValue);
            } else {
                // —Ä–µ–∂–∏–º —Ç: 3 –∑–Ω–∞–∫–∏ –ø—ñ—Å–ª—è –∫–æ–º–∏ (–≤–∏—Ö—ñ–¥–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è)
                v.textContent = tons.toFixed(3);
            }
        });

        // 2. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤ —Å—Ç–æ–≤–ø—Ü—ñ–≤
        const unitText = modeKG ? "–∫–≥" : "—Ç";
        for (const key in baseHeaders) {
            updateHeader(key, unitText);
        }

        // 3. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–æ—ó –æ–¥–∏–Ω–∏—Ü—ñ (–≤—ñ–∑—É–∞–ª)
        if (modeKG) {
            tLabel.classList.remove('active');
            kgLabel.classList.add('active');
        } else {
            tLabel.classList.add('active');
            kgLabel.classList.remove('active');
        }
    }

    // –û–±—Ä–æ–±–Ω–∏–∫ –∑–º—ñ–Ω–∏ —Å—Ç–∞–Ω—É —á–µ–∫–±–æ–∫—Å—É
    toggle.addEventListener("change", updateUnits);

    // –û–±—Ä–æ–±–Ω–∏–∫–∏ –∫–ª—ñ–∫—É –Ω–∞ –º—ñ—Ç–∫–∏ –¥–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–æ—ó —Ä–æ–±–æ—Ç–∏ Segmented Control
    tLabel.addEventListener('click', (e) => {
        if (toggle.checked) { 
            e.preventDefault(); 
            toggle.checked = false;
            updateUnits();
        }
    });

    kgLabel.addEventListener('click', (e) => {
        if (!toggle.checked) {
            e.preventDefault(); 
            toggle.checked = true;
            updateUnits();
        }
    });

    // –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ—á–∞—Ç–∫–æ–≤–æ–≥–æ —Å—Ç–∞–Ω—É (—Ç) –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
    toggle.checked = false; 
    updateUnits();
});
</script>
{% endblock %}