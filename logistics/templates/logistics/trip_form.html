{% extends "base.html" %}
{% load widget_tweaks %}

{% block content %}
<div class="container mt-4">
  <div class="card shadow-sm">
    <div class="card-body">
      <h4>{{ form.instance.pk|yesno:"–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ä–µ–π—Å,–î–æ–¥–∞—Ç–∏ —Ä–µ–π—Å" }}</h4>

      <form method="post" novalidate>
        {% csrf_token %}
        {{ form.non_field_errors }}

        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">‚Ññ –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
            {{ form.document_number|add_class:"form-control" }}
          </div>
          <div class="col-md-4">
            <label class="form-label">–î–∞—Ç–∞ / —á–∞—Å</label>
            {{ form.date_time|add_class:"form-control" }}
          </div>
        </div>

        <div class="row g-3 mt-2">
          <div class="col-md-6">
            <label class="form-label">–í—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫</label>
            <div class="input-group">
              {{ form.sender|add_class:"form-select" }}
              <a href="{% url 'partner_add' %}?next={{ request.path }}" class="btn btn-outline-success">+</a>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">–û—Ç—Ä–∏–º—É–≤–∞—á</label>
            <div class="input-group">
              {{ form.receiver|add_class:"form-select" }}
              <a href="{% url 'partner_add' %}?next={{ request.path }}" class="btn btn-outline-success">+</a>
            </div>
          </div>
        </div>

        <div class="row g-3 mt-2">
          <div class="col-md-4">
            <label class="form-label">–ê–≤—Ç–æ</label>
            <div class="input-group">
              {{ form.car|add_class:"form-select" }}
              <a href="{% url 'car_add' %}?next={{ request.path }}" class="btn btn-outline-success">+</a>
            </div>
          </div>
          <div class="col-md-4">
            <label class="form-label">–í–æ–¥—ñ–π</label>
            <div class="input-group">
              {{ form.driver|add_class:"form-select" }}
              <a href="{% url 'driver_add' %}?next={{ request.path }}" class="btn btn-outline-success">+</a>
            </div>
          </div>
          <div class="col-md-4">
            <label class="form-label">–ü—Ä–∏—á—ñ–ø</label>
            <div class="input-group">
              {{ form.trailer|add_class:"form-select" }}
              <a href="{% url 'trailer_add' %}?next={{ request.path }}" class="btn btn-outline-success">+</a>
            </div>
          </div>
        </div>

        <div class="row g-3 mt-2">
          <div class="col-md-6">
            <label class="form-label">–ö—É–ª—å—Ç—É—Ä–∞</label>
            <div class="input-group">
              {{ form.culture|add_class:"form-select" }}
              <a href="{% url 'culture_add' %}?next={{ request.path }}" class="btn btn-outline-success">+</a>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">–ú—ñ—Å—Ü–µ —Ä–æ–∑–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</label>
            <div class="input-group">
              {{ form.unloading_place|add_class:"form-select" }}
              <a href="{% url 'place_add' %}?next={{ request.path }}" class="btn btn-outline-success">+</a>
            </div>
          </div>
        </div>

        <div class="row g-3 mt-2">
          <div class="col-md-4">
            <label class="form-label">–ë—Ä—É—Ç—Ç–æ(–∫–≥)</label>
            {{ form.weight_gross|add_class:"form-control" }}
          </div>
          <div class="col-md-4">
            <label class="form-label">–¢–∞—Ä–∞(–∫–≥)</label>
            {{ form.weight_tare|add_class:"form-control" }}
          </div>
            <div class="col-md-4">
                <label class="form-label">–ù–µ—Ç—Ç–æ(–∫–≥)</label>
                <input type="text" id="weightNetDisplay" class="form-control" value="0.00" readonly>
            </div>
          <div class="col-md-4">
            <label class="form-label">–ü—ñ–¥–ø–∏—Å –≤–æ–¥—ñ—è</label>
            {{ form.driver_signature|add_class:"form-control" }}
          </div>
        </div>

        <div class="mt-3">
          <label class="form-label">–ü—Ä–∏–º—ñ—Ç–∫–∞</label>
          {{ form.note|add_class:"form-control" }}
        </div>

        <div class="mt-4">
          <button type="submit" class="btn btn-primary">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
          <a href="{% url 'trip_list' %}" class="btn btn-secondary">‚¨Ö –ù–∞–∑–∞–¥</a>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Å–∫—Ä–∏–ø—Ç–∏ -->
<script>
  // –ê–≤—Ç–æ–ø—ñ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–æ–¥—ñ—è –∑–∞ –≤–∏–±—Ä–∞–Ω–∏–º –∞–≤—Ç–æ (–æ–ø—Ü—ñ–π–Ω–æ)
  // –ü–µ—Ä–µ–¥–∞–π —É –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ: car_driver_map = {"1": 5, "2": 7, ...}
  {% if car_driver_map %}
  const CAR_DRIVER_MAP = {{ car_driver_map|safe }};
  {% else %}
  const CAR_DRIVER_MAP = null;
  {% endif %}

  document.addEventListener("DOMContentLoaded", function () {
    const carSelect = document.getElementById("id_car");
    const driverSelect = document.getElementById("id_driver");
    const grossInput = document.getElementById("id_weight_gross");
    const tareInput  = document.getElementById("id_weight_tare");
    const netDisplay = document.getElementById("weightNetDisplay");

    // –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ—Ç–æ—á–Ω–µ –Ω–µ—Ç—Ç–æ –ø—Ä–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—ñ
    function updateNet() {
      const g = parseFloat(grossInput?.value || 0);
      const t = parseFloat(tareInput?.value  || 0);
      const net = (isFinite(g - t) ? (g - t) : 0);
      if (netDisplay) netDisplay.value = net.toFixed(2);
    }
    if (grossInput && tareInput) {
      grossInput.addEventListener("input", updateNet);
      tareInput.addEventListener("input", updateNet);
      updateNet();
    }

    // –Ø–∫—â–æ —î –º–∞–ø–∞ –∞–≤—Ç–æ‚Üí–≤–æ–¥—ñ–π ‚Äî –ø—ñ–¥—Å—Ç–∞–≤–ª—è—î–º–æ
    if (CAR_DRIVER_MAP && carSelect && driverSelect) {
      carSelect.addEventListener("change", function () {
        const driverId = CAR_DRIVER_MAP[this.value];
        if (!driverId) return;
        // –ü—Ä–æ—Å—Ç–∞–≤–∏—Ç–∏ –∑–Ω–∞—á–µ–Ω–Ω—è, —è–∫—â–æ —ñ—Å–Ω—É—î –≤ —Å–ø–∏—Å–∫—É
        for (const opt of driverSelect.options) {
          if (String(opt.value) === String(driverId)) {
            driverSelect.value = opt.value;
            break;
          }
        }
      });

      // –í–∏–∫–æ–Ω–∞—Ç–∏ –Ω–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ, —è–∫—â–æ –∞–≤—Ç–æ –≤–∂–µ –≤–∏–±—Ä–∞–Ω–µ
      if (carSelect.value) {
        const initialDriver = CAR_DRIVER_MAP[carSelect.value];
        if (initialDriver) {
          for (const opt of driverSelect.options) {
            if (String(opt.value) === String(initialDriver)) {
              driverSelect.value = opt.value;
              break;
            }
          }
        }
      }
    }
  });
</script>
{% endblock %}
