{% extends "base.html" %}
{% load widget_tweaks %}

{% block content %}
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

<!-- Select2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<div class="container mt-4">
  <div class="card shadow-sm rounded-4">
    <div class="card-body">
      <h4 class="mb-3">
        {{ form.instance.pk|yesno:"–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ä–µ–π—Å,–î–æ–¥–∞—Ç–∏ —Ä–µ–π—Å" }}
      </h4>

      <form method="post" novalidate>
        {% csrf_token %}
        {{ form.media }}

        {% if form.non_field_errors %}
          <div class="alert alert-danger">
            {{ form.non_field_errors }}
          </div>
        {% endif %}

        <!-- –î–æ–∫—É–º–µ–Ω—Ç —ñ –¥–∞—Ç–∞ -->
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">‚Ññ –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
            {{ form.document_number|add_class:"form-control" }}
          </div>
          <div class="col-md-4">
            <label class="form-label">–î–∞—Ç–∞ / —á–∞—Å</label>
            {{ form.date_time|add_class:"form-control" }}
          </div>
        </div>

        <!-- –í—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫ —Ç–∞ –æ—Ç—Ä–∏–º—É–≤–∞—á -->
        <div class="row g-3 mt-2">
          <div class="col-md-6">
            <label class="form-label">–í—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫</label>
            <div class="input-group">
              {{ form.sender|add_class:"form-select select2-field" }}
              <a href="{% url 'partner_add' %}?next={{ request.path }}" class="btn btn-outline-success">+</a>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">–û—Ç—Ä–∏–º—É–≤–∞—á</label>
            <div class="input-group">
              {{ form.receiver|add_class:"form-select select2-field" }}
              <a href="{% url 'partner_add' %}?next={{ request.path }}" class="btn btn-outline-success">+</a>
            </div>
          </div>
        </div>

        <!-- –ê–≤—Ç–æ, –≤–æ–¥—ñ–π, –ø—Ä–∏—á—ñ–ø -->
        <div class="row g-3 mt-2">
          <div class="col-md-4">
            <label class="form-label">–ê–≤—Ç–æ</label>
            <div class="input-group">
              {{ form.car|add_class:"form-select select2-field" }}
              <a href="{% url 'car_add' %}?next={{ request.path }}" class="btn btn-outline-success">+</a>
            </div>
          </div>
          <div class="col-md-4">
            <label class="form-label">–í–æ–¥—ñ–π</label>
            <div class="input-group">
              {{ form.driver|add_class:"form-select select2-field" }}
              <a href="{% url 'driver_add' %}?next={{ request.path }}" class="btn btn-outline-success">+</a>
            </div>
          </div>
          <div class="col-md-4">
            <label class="form-label">–ü—Ä–∏—á—ñ–ø</label>
            <div class="input-group">
              {{ form.trailer|add_class:"form-select select2-field" }}
              <a href="{% url 'trailer_add' %}?next={{ request.path }}" class="btn btn-outline-success">+</a>
            </div>
          </div>
        </div>

        <!-- –ö—É–ª—å—Ç—É—Ä–∞ —Ç–∞ –º—ñ—Å—Ü–µ —Ä–æ–∑–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è -->
        <div class="row g-3 mt-2">
          <div class="col-md-6">
            <label class="form-label">–ö—É–ª—å—Ç—É—Ä–∞</label>
            <div class="input-group">
              {{ form.culture|add_class:"form-select select2-field" }}
              <a href="{% url 'culture_add' %}?next={{ request.path }}" class="btn btn-outline-success">+</a>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">–ú—ñ—Å—Ü–µ —Ä–æ–∑–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</label>
            <div class="input-group">
              {{ form.unloading_place|add_class:"form-select select2-field" }}
              <a href="{% url 'place_add' %}?next={{ request.path }}" class="btn btn-outline-success">+</a>
            </div>
          </div>
        </div>

        <!-- –í–∞–≥–∞ —Ç–∞ –ø—ñ–¥–ø–∏—Å –≤–æ–¥—ñ—è -->
        <div class="row g-3 mt-2">
          <div class="col-md-4">
            <label class="form-label">–ë—Ä—É—Ç—Ç–æ (–∫–≥)</label>
            {{ form.weight_gross|add_class:"form-control" }}
          </div>
          <div class="col-md-4">
            <label class="form-label">–¢–∞—Ä–∞ (–∫–≥)</label>
            {{ form.weight_tare|add_class:"form-control" }}
          </div>
          <div class="col-md-4">
            <label class="form-label">–ù–µ—Ç—Ç–æ (–∫–≥)</label>
            <input type="text" id="weightNetDisplay" class="form-control" value="0.00" readonly>
          </div>
          <div class="col-md-4 mt-2">
            <label class="form-label">–ü—ñ–¥–ø–∏—Å –≤–æ–¥—ñ—è</label>
            {{ form.driver_signature|add_class:"form-control" }}
          </div>
        </div>

        <!-- –ü—Ä–∏–º—ñ—Ç–∫–∞ -->
        <div class="mt-3">
          <label class="form-label">–ü—Ä–∏–º—ñ—Ç–∫–∞</label>
          {{ form.note|add_class:"form-control" }}
        </div>

        <div class="mt-4 d-flex gap-2">
          <button type="submit" class="btn btn-primary">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
          <a href="{% url 'trip_list' %}" class="btn btn-secondary">‚¨Ö –ù–∞–∑–∞–¥</a>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- –°–∫—Ä–∏–ø—Ç–∏ -->
<script>
  $(document).ready(function () {
    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Select2
    $('.select2-field').select2({
      theme: "bootstrap-5",
      width: '100%',
      placeholder: "–û–±–µ—Ä—ñ—Ç—å –∑–Ω–∞—á–µ–Ω–Ω—è",
      allowClear: true
    });

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –Ω–µ—Ç—Ç–æ
    function updateNetto() {
      let gross = parseFloat($('#id_weight_gross').val()) || 0;
      let tare = parseFloat($('#id_weight_tare').val()) || 0;
      let netto = gross - tare;
      $('#weightNetDisplay').val(netto.toFixed(2));
    }

    $('#id_weight_gross, #id_weight_tare').on('input', updateNetto);
    updateNetto();
  });
</script>
{% endblock %}
