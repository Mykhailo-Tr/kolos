{% extends "base.html" %}
{% load widget_tweaks %}


{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>{{ form.instance.pk|yesno:"–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ä–µ–π—Å—É,–ù–æ–≤–∏–π —Ä–µ–π—Å" }}</h2>
    <div>
      <a href="{% url 'trip_list' %}" class="btn btn-outline-secondary">‚¨Ö –ù–∞–∑–∞–¥ –¥–æ —Å–ø–∏—Å–∫—É</a>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <form method="post" novalidate>
        {% csrf_token %}
        {{ form.non_field_errors }}

        <!-- ‚Ññ –¥–æ–∫—É–º–µ–Ω—Ç–∞ / –¥–∞—Ç–∞ -->
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">‚Ññ –¥–æ–∫—É–º–µ–Ω—Ç–∞ / –Ω–∞–∫–ª–∞–¥–Ω–æ—ó</label>
            {{ form.document_number|add_class:"form-control" }}
            <div class="text-danger small">{{ form.document_number.errors }}</div>
          </div>
          <div class="col-md-4">
            <!-- date_time —É –º–æ–¥–µ–ª—ñ auto_now_add; —è–∫—â–æ –∑–∞—Ö–æ—á–µ—à –≤—Ä—É—á–Ω—É ‚Äî –¥–æ–¥–∞–π –ø–æ–ª–µ —É —Ñ–æ—Ä–º—É -->
            <label class="form-label">–î–∞—Ç–∞ —ñ —á–∞—Å</label>
            <input class="form-control" value="{{ form.instance.date_time|date:'d.m.Y H:i' }}" disabled>
            <div class="form-text">–ó–∞–ø–∏—Å—É—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ</div>
          </div>
        </div>

        <hr class="my-4">

        <!-- –í—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫ / –û—Ç—Ä–∏–º—É–≤–∞—á -->
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">–í—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫</label>
            {{ form.sender|add_class:"form-select" }}
            <div class="text-danger small">{{ form.sender.errors }}</div>
          </div>
          <div class="col-md-6">
            <label class="form-label">–û—Ç—Ä–∏–º—É–≤–∞—á</label>
            {{ form.receiver|add_class:"form-select" }}
            <div class="text-danger small">{{ form.receiver.errors }}</div>
          </div>
        </div>

        <hr class="my-4">

        <!-- –ê–≤—Ç–æ / –í–æ–¥—ñ–π / –ü—Ä–∏—á–µ–ø -->
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">–ê–≤—Ç–æ–º–æ–±—ñ–ª—å</label>
            {{ form.car|add_class:"form-select" }}
            <div class="text-danger small">{{ form.car.errors }}</div>
          </div>
          <div class="col-md-4">
            <label class="form-label">–í–æ–¥—ñ–π</label>
            {{ form.driver|add_class:"form-select" }}
            <div class="form-text">–ü—ñ–¥—Å—Ç–∞–≤–∏—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ, —è–∫—â–æ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å –∞–≤—Ç–æ‚Üí–≤–æ–¥—ñ–π</div>
            <div class="text-danger small">{{ form.driver.errors }}</div>
          </div>
          <div class="col-md-4">
            <label class="form-label">–ü—Ä–∏—á–µ–ø</label>
            {{ form.trailer|add_class:"form-select" }}
            <div class="text-danger small">{{ form.trailer.errors }}</div>
          </div>
        </div>

        <hr class="my-4">

        <!-- –ö—É–ª—å—Ç—É—Ä–∞ / –í–∞–≥–∏ -->
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">–ö—É–ª—å—Ç—É—Ä–∞</label>
            {{ form.culture|add_class:"form-select" }}
            <div class="text-danger small">{{ form.culture.errors }}</div>
          </div>

          <div class="col-md-8">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">–í–∞–≥–∞ –±—Ä—É—Ç—Ç–æ (–∫–≥)</label>
                {{ form.weight_gross|add_class:"form-control weight-input" }}
                <div class="text-danger small">{{ form.weight_gross.errors }}</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">–í–∞–≥–∞ —Ç–∞—Ä–∏ (–∫–≥)</label>
                {{ form.weight_tare|add_class:"form-control weight-input" }}
                <div class="text-danger small">{{ form.weight_tare.errors }}</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">–í–∞–≥–∞ –Ω–µ—Ç—Ç–æ (–∫–≥)</label>
                <input id="weightNetDisplay" class="form-control" value="" readonly>
                <div class="form-text">–†–æ–∑—Ä–∞—Ö–æ–≤—É—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ</div>
              </div>
            </div>
          </div>
        </div>

        <hr class="my-4">

        <!-- –ú—ñ—Å—Ü–µ —Ä–æ–∑–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è -->
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">–ú—ñ—Å—Ü–µ —Ä–æ–∑–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</label>
            {{ form.unloading_place|add_class:"form-select" }}
            <div class="text-danger small">{{ form.unloading_place.errors }}</div>
          </div>
          <div class="col-md-6">
            <label class="form-label">–ü—ñ–¥–ø–∏—Å –≤–æ–¥—ñ—è (–µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∏–π)</label>
            {{ form.driver_signature|add_class:"form-control" }}
            <div class="text-danger small">{{ form.driver_signature.errors }}</div>
          </div>
        </div>

        <div class="mt-3">
          <label class="form-label">–ü—Ä–∏–º—ñ—Ç–∫–∞</label>
          {{ form.note|add_class:"form-control" }}
          <div class="text-danger small">{{ form.note.errors }}</div>
        </div>

        <div class="d-flex gap-2 mt-4">
          <button type="submit" class="btn btn-primary">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
          <a href="{% url 'trip_list' %}" class="btn btn-outline-secondary">–°–∫–∞—Å—É–≤–∞—Ç–∏</a>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Å–∫—Ä–∏–ø—Ç–∏ -->
<script>
  // –ê–≤—Ç–æ–ø—ñ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–æ–¥—ñ—è –∑–∞ –≤–∏–±—Ä–∞–Ω–∏–º –∞–≤—Ç–æ (–æ–ø—Ü—ñ–π–Ω–æ)
  // –ü–µ—Ä–µ–¥–∞–π —É –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ: car_driver_map = {"1": 5, "2": 7, ...}
  {% if car_driver_map %}
  const CAR_DRIVER_MAP = {{ car_driver_map|safe }};
  {% else %}
  const CAR_DRIVER_MAP = null;
  {% endif %}

  document.addEventListener("DOMContentLoaded", function () {
    const carSelect = document.getElementById("id_car");
    const driverSelect = document.getElementById("id_driver");
    const grossInput = document.getElementById("id_weight_gross");
    const tareInput  = document.getElementById("id_weight_tare");
    const netDisplay = document.getElementById("weightNetDisplay");

    // –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ—Ç–æ—á–Ω–µ –Ω–µ—Ç—Ç–æ –ø—Ä–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—ñ
    function updateNet() {
      const g = parseFloat(grossInput?.value || 0);
      const t = parseFloat(tareInput?.value  || 0);
      const net = (isFinite(g - t) ? (g - t) : 0);
      if (netDisplay) netDisplay.value = net.toFixed(2);
    }
    if (grossInput && tareInput) {
      grossInput.addEventListener("input", updateNet);
      tareInput.addEventListener("input", updateNet);
      updateNet();
    }

    // –Ø–∫—â–æ —î –º–∞–ø–∞ –∞–≤—Ç–æ‚Üí–≤–æ–¥—ñ–π ‚Äî –ø—ñ–¥—Å—Ç–∞–≤–ª—è—î–º–æ
    if (CAR_DRIVER_MAP && carSelect && driverSelect) {
      carSelect.addEventListener("change", function () {
        const driverId = CAR_DRIVER_MAP[this.value];
        if (!driverId) return;
        // –ü—Ä–æ—Å—Ç–∞–≤–∏—Ç–∏ –∑–Ω–∞—á–µ–Ω–Ω—è, —è–∫—â–æ —ñ—Å–Ω—É—î –≤ —Å–ø–∏—Å–∫—É
        for (const opt of driverSelect.options) {
          if (String(opt.value) === String(driverId)) {
            driverSelect.value = opt.value;
            break;
          }
        }
      });

      // –í–∏–∫–æ–Ω–∞—Ç–∏ –Ω–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ, —è–∫—â–æ –∞–≤—Ç–æ –≤–∂–µ –≤–∏–±—Ä–∞–Ω–µ
      if (carSelect.value) {
        const initialDriver = CAR_DRIVER_MAP[carSelect.value];
        if (initialDriver) {
          for (const opt of driverSelect.options) {
            if (String(opt.value) === String(initialDriver)) {
              driverSelect.value = opt.value;
              break;
            }
          }
        }
      }
    }
  });
</script>
{% endblock %}
