{% extends "base.html" %}
{% load widget_tweaks %}

{% block content %}

<!-- –ü–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø: —Ç—ñ–ª—å–∫–∏ –æ–¥–Ω–∞ –≤–µ—Ä—Å—ñ—è jQuery + Select2 (CDN). –ù–µ –¥—É–±–ª—é—î–º–æ. -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<div class="container mt-4">
  <div class="card shadow-sm rounded-4">
    <div class="card-body">
      <h4 class="mb-3">{{ form.instance.pk|yesno:"–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∑–∞–ø–∏—Å,–î–æ–¥–∞—Ç–∏ –∑–∞–ø–∏—Å" }}</h4>

      <form method="post" novalidate>
        {% csrf_token %}
        {# –ú–∏ –ù–ï –≤—Å—Ç–∞–≤–ª—è—î–º–æ {{ form.media }} —Ç—É—Ç, –±–æ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ select2 –≤—Ä—É—á–Ω—É (CDN) #}

        {% if form.non_field_errors %}
          <div class="alert alert-danger">{{ form.non_field_errors }}</div>
        {% endif %}

        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">‚Ññ –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
            {{ form.document_number|add_class:"form-control" }}
          </div>
          <div class="col-md-4">
            <label class="form-label">–î–∞—Ç–∞ / —á–∞—Å</label>
            {{ form.date_time|add_class:"form-control" }}
          </div>
        </div>

        <div class="row g-3 mt-2">
          <div class="col-md-6">
            <label class="form-label">–í—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫</label>
            <div class="input-group">
              {{ form.sender|add_class:"form-select ajax-no-tags" }}
              <a href="{% url 'partner_add' %}?next={{ request.path }}" class="btn btn-outline-success">+</a>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">–û—Ç—Ä–∏–º—É–≤–∞—á</label>
            <div class="input-group">
              {{ form.receiver|add_class:"form-select ajax-no-tags" }}
              <a href="{% url 'partner_add' %}?next={{ request.path }}" class="btn btn-outline-success">+</a>
            </div>
          </div>
        </div>

        <div class="row g-3 mt-2">
          <div class="col-md-4">
            <label class="form-label">–ê–≤—Ç–æ</label>
            <div class="input-group">
              {{ form.car|add_class:"form-select ajax-tags" }}
              <a href="{% url 'car_add' %}?next={{ request.path }}" class="btn btn-outline-success">+</a>
            </div>
          </div>
          <div class="col-md-4">
            <label class="form-label">–í–æ–¥—ñ–π</label>
            <div class="input-group">
              {{ form.driver|add_class:"form-select ajax-tags" }}
              <a href="{% url 'driver_add' %}?next={{ request.path }}" class="btn btn-outline-success">+</a>
            </div>
          </div>
          <div class="col-md-4">
            <label class="form-label">–ü—Ä–∏—á—ñ–ø</label>
            <div class="input-group">
              {{ form.trailer|add_class:"form-select ajax-tags" }}
              <a href="{% url 'trailer_add' %}?next={{ request.path }}" class="btn btn-outline-success">+</a>
            </div>
          </div>
        </div>

        <div class="row g-3 mt-2">
          <div class="col-md-6">
            <label class="form-label">–ö—É–ª—å—Ç—É—Ä–∞</label>
            <div class="input-group">
              {{ form.culture|add_class:"form-select ajax-tags" }}
              <a href="{% url 'culture_add' %}?next={{ request.path }}" class="btn btn-outline-success">+</a>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">–ú—ñ—Å—Ü–µ —Ä–æ–∑–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</label>
            <div class="input-group">
              {{ form.unloading_place|add_class:"form-select ajax-no-tags" }}
              <a href="{% url 'place_add' %}?next={{ request.path }}" class="btn btn-outline-success">+</a>
            </div>
          </div>
        </div>

      <div class="row g-3 mt-2">
        <div class="col-md-4">
          <label class="form-label">–ë—Ä—É—Ç—Ç–æ (–∫–≥)</label>
          <div class="input-group">
            {{ form.weight_gross|add_class:"form-control" }}
            <button type="button" class="btn btn-outline-primary" id="btnGross">üì• –ó—á–∏—Ç–∞—Ç–∏</button>
          </div>
        </div>
        <div class="col-md-4">
          <label class="form-label">–¢–∞—Ä–∞ (–∫–≥)</label>
          <div class="input-group">
            {{ form.weight_tare|add_class:"form-control" }}
            <button type="button" class="btn btn-outline-primary" id="btnTare">üì• –ó—á–∏—Ç–∞—Ç–∏</button>
          </div>
        </div>
        <div class="col-md-4">
          <label class="form-label">–ù–µ—Ç—Ç–æ (–∫–≥)</label>
          <input type="text" id="weightNetDisplay" class="form-control" value="0.00" readonly>
        </div>
      </div>

        <div class="mt-3">
          <label class="form-label">–ü—Ä–∏–º—ñ—Ç–∫–∞</label>
          {{ form.note|add_class:"form-control" }}
        </div>

        <div class="mt-4 d-flex gap-2">
          <button type="submit" class="btn btn-primary">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
          <a href="{% url 'weigher_journal_list' %}" class="btn btn-secondary">‚¨Ö –ù–∞–∑–∞–¥</a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  (function($){
    $(document).ready(function(){
        let activeField = "gross"; // "gross" –∞–±–æ "tare" –∞–±–æ null
        if ($('#id_weight_gross').val()) {
          activeField = "tare";
        }
        function fetchWeight() {
          fetch("{% url 'api_current_weight' %}")
            .then(resp => resp.json())
            .then(data => {
              if (data.weight !== null) {
                if (activeField === "gross") {
                  $('#id_weight_gross').val(data.weight.toFixed(2));
                } else {
                  $('#id_weight_tare').val(data.weight.toFixed(2));
                }
                updateNetto();
              }
            })
            .catch(err => console.error("Weight fetch error:", err));
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –æ–ø–∏—Ç—É–≤–∞—á
        setInterval(fetchWeight, 1000);

        // –ö–Ω–æ–ø–∫–∏ —Ä—É—á–Ω–æ–≥–æ –≤–∏–±–æ—Ä—É
        $('#btnGross').click(function(){
          activeField = "gross";
          fetchWeight();
        });

        $('#btnTare').click(function(){
          activeField = "tare";
          fetchWeight();
        });

      // –ü–æ–ª—è –±–µ–∑ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–∏—Ö –∑–Ω–∞—á–µ–Ω—å (sender, receiver, unloading_place)
      $('.ajax-no-tags').each(function(){
        const $el = $(this);
        const url = $el.data('autocomplete-light-url') || $el.data('autocomplete-url') || $el.data('url');
        $el.select2({
          theme: 'bootstrap-5',
          width: '100%',
          placeholder: $el.attr('placeholder') || $el.data('placeholder') || '–û–±–µ—Ä—ñ—Ç—å –∑–Ω–∞—á–µ–Ω–Ω—è',
          allowClear: true,
          ajax: {
            url: url,
            dataType: 'json',
            delay: 250,
            data: function(params){
              return { q: params.term };
            },
            processResults: function(data){
              return data;
            },
            cache: true
          },
          minimumInputLength: 0
        }).on('focus', function(){
          if ($el.data('select2')) {
            $el.select2('open');
          }
        });
      });

      // –ü–æ–ª—è –∑ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—é —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è (car, driver, trailer, culture)
      $('.ajax-tags').each(function(){
        const $el = $(this);
        const url = $el.data('autocomplete-light-url') || $el.data('autocomplete-url') || $el.data('url');
        $el.select2({
          theme: 'bootstrap-5',
          width: '100%',
          placeholder: $el.attr('placeholder') || $el.data('placeholder') || '–í–≤–µ–¥—ñ—Ç—å –∞–±–æ –æ–±–µ—Ä—ñ—Ç—å',
          allowClear: true,
          tags: true,
          tokenSeparators: [','],
          createTag: function(params) {
            const term = $.trim(params.term);
            if (term === '') return null;
            return {
              id: term,
              text: term,
              newTag: true
            };
          },
          templateResult: function(data) {
            if (data.newTag) {
              return $('<span style="color: green; font-weight: bold;">‚ûï ' + data.text + ' (–Ω–æ–≤–∏–π)</span>');
            }
            return data.text;
          },
          ajax: {
            url: url,
            dataType: 'json',
            delay: 250,
            data: function(params){
              return { q: params.term };
            },
            processResults: function(data){
              return data;
            },
            cache: true
          },
          minimumInputLength: 0
        }).on('focus', function(){
          if ($el.data('select2')) {
            $el.select2('open');
          }
        });
      });

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –ø—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ –Ω–µ—Ç—Ç–æ
      function updateNetto(){
        let gross = parseFloat($('#id_weight_gross').val()) || 0;
        let tare = parseFloat($('#id_weight_tare').val()) || 0;
        $('#weightNetDisplay').val((gross - tare).toFixed(2));
      }
      $('#id_weight_gross, #id_weight_tare').on('input', updateNetto);
      updateNetto();

    });
  })(jQuery);
</script>

{% endblock %}
