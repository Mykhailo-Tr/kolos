{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container-fluid mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>üìÖ –î–µ–Ω–Ω–∏–π –∑–≤—ñ—Ç ‚Äî {{ selected_date }}</h3>
  </div>
  <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}export=csv" class="btn btn-outline-secondary">‚¨á –ï–∫—Å–ø–æ—Ä—Ç CSV</a>
    <div class="d-inline-block ms-3">
      <label for="name" class="form-label d-block small mt-2">–Ü–º'—è —Ñ–∞–π–ª—É –Ω–∞ —Ä–µ–ø–æ—Ä—Ç-—Å–µ—Ä–≤–µ—Ä—ñ:</label>
      <input name="name" type="text" class="form-control form-control-sm"
             placeholder="–Ü–º'—è —Ñ–∞–π–ª—É –Ω–∞ —Ä–µ–ø–æ—Ä—Ç-—Å–µ—Ä–≤–µ—Ä—ñ"
             value="daily_report_{{ edited_selected_date }}">
      <button id="btn-send-report" class="btn btn-outline-primary"
              data-report-type="daily"
              data-date="{{ selected_date|default:today }}"
              data-group-by="{{ group_by|default:'none' }}">
      –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–≤—ñ—Ç –Ω–∞ —Ä–µ–ø–æ—Ä—Ç-—Å–µ—Ä–≤–µ—Ä
      </button>
      <span id="send-report-status" class="ms-2"></span>
    </div>

  <form method="get" class="mb-3">
    <div class="row g-2 align-items-end">
      <div class="col-auto">
        {{ form.date.label_tag }} {{ form.date }}
      </div>
      <div class="col-auto">
        {{ form.group_by.label_tag }} {{ form.group_by }}
      </div>
      <div class="col-auto">
        {{ form.car.label_tag }} {{ form.car }}
      </div>
      <div class="col-auto">
        {{ form.driver.label_tag }} {{ form.driver }}
      </div>
      <div class="col-auto">
        {{ form.culture.label_tag }} {{ form.culture }}
      </div>
      <div class="col-auto">
        {{ form.unloading_place.label_tag }} {{ form.unloading_place }}
      </div>
      <div class="col-auto">
        <button class="btn btn-primary">–°—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ –¥–µ–Ω–Ω–∏–π –∑–≤—ñ—Ç</button>
      </div>
    </div>
  </form>

  <hr>

  <div class="mb-3">
    <strong>–ó–∞–≥–∞–ª–æ–º:</strong>
    <span class="badge bg-success">–ó–∞–≤–µ–∑–µ–Ω–æ (net): {{ totals.net_in|default:0 }}</span>
    <span class="badge bg-danger">–í–∏–≤–µ–∑–µ–Ω–æ (net): {{ totals.net_out|default:0 }}</span>
    <span class="badge bg-info text-dark">–ë–∞–ª–∞–Ω—Å: {{ totals.balance|default:0 }}</span>
  </div>

  <div class="table-responsive">
    <table class="table table-sm table-bordered align-middle">
      <thead class="table-dark">
        <tr>
          <th>–ì—Ä—É–ø–∞ ({{ group_by }})</th>
          <th>–ö—É–ª—å—Ç—É—Ä–∞</th>
          <th class="text-end">Gross (–∫–≥)</th>
          <th class="text-end">Tare (–∫–≥)</th>
          <th class="text-end">Net (–∫–≥)</th>
          <th>–î–µ—Ç–∞–ª—ñ</th>
        </tr>
      </thead>
      <tbody>
        {% for row in table_rows %}
        <tr>
          <td>{{ row.group }}</td>
          <td>{{ row.culture }}</td>
          <td class="text-end">{{ row.gross }}</td>
          <td class="text-end">{{ row.tare }}</td>
          <td class="text-end">{{ row.net }}</td>
          <td>
            <!-- –º–æ–¥–∞–ª–∫–∞: –ø–µ—Ä–µ–¥–∞—î–º–æ group & culture -->
            <button class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#detailsModal-{{ forloop.counter }}">
              üõà
            </button>

            <!-- modal content (simple) -->
            <div class="modal fade" id="detailsModal-{{ forloop.counter }}" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">–î–µ—Ç–∞–ª—ñ: {{ row.group }} ‚Äî {{ row.culture }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä–∏—Ç–∏"></button>
                  </div>
                  <div class="modal-body">
                  <div class="mb-3">
                    <p><strong>Gross:</strong> {{ row.gross }} –∫–≥</p>
                    <p><strong>Tare:</strong> {{ row.tare }} –∫–≥</p>
                    <p><strong>Net:</strong> {{ row.net }} –∫–≥</p>
                  </div>
                  <hr>
                  <h6>–†–µ–π—Å–∏ —É –≥—Ä—É–ø—ñ:</h6>
                  <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                      <thead class="table-light">
                        <tr>
                          <th>–î–æ–∫—É–º–µ–Ω—Ç</th>
                          <th>–î–∞—Ç–∞</th>
                          <th>–ê–≤—Ç–æ</th>
                          <th>–í–æ–¥—ñ–π</th>
                          <th>–ü—Ä–∏—á—ñ–ø</th>
                          <th>–í—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫</th>
                          <th>–û–¥–µ—Ä–∂—É–≤–∞—á</th>
                          <th class="text-end">Gross</th>
                          <th class="text-end">Tare</th>
                          <th class="text-end">Net</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for trip in row.trips %}
                        <tr>
                          <td>{{ trip.document_number }}</td>
                          <td>{{ trip.date_time|date:"Y-m-d H:i" }}</td>
                          <td>{{ trip.car__number }}</td>
                          <td>{{ trip.driver__name }}</td>
                          <td>{{ trip.trailer__number|default:"‚Äî" }}</td>
                          <td>{{ trip.sender__name }}</td>
                          <td>{{ trip.receiver__name }}</td>
                          <td class="text-end">{{ trip.gross_weight }}</td>
                          <td class="text-end">{{ trip.tare_weight }}</td>
                          <td class="text-end">{{ trip.net_weight }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="10" class="text-center">–ù–µ–º–∞—î —Ä–µ–π—Å—ñ–≤</td></tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
                  <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä–∏—Ç–∏</button>
                  </div>
                </div>
              </div>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="6" class="text-center">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <hr>
  <h5>–ü—ñ–¥—Å—É–º–∫–∏ –ø–æ –≥—Ä—É–ø–∞—Ö</h5>
  <div class="row">
    {% for g, s in groups_summary.items %}
    <div class="col-md-4 mb-2">
      <div class="p-2 border rounded">
        <strong>{{ g }}</strong><br>
        Gross: {{ s.gross }} –∫–≥<br>
        Tare: {{ s.tare }} –∫–≥<br>
        Net: {{ s.net }} –∫–≥
      </div>
    </div>
    {% empty %}
    <div class="col-12">–ù–µ–º–∞—î –∑–≤–µ–¥–µ–Ω—å</div>
    {% endfor %}
  </div>

  <!-- –û–∫—Ä–µ–º–∏–π –Ω–µ–≤–µ–ª–∏–∫–∏–π –≥—Ä–∞—Ñ—ñ–∫ (Chart.js) -->
  <div class="row mt-4">
    <div class="col-md-8">
      <canvas id="barChart"></canvas>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const labels = {{ chart_labels|default:"[]"|safe }};
  const values = {{ chart_values|default:"[]"|safe }};

  if (labels.length && values.length) {
    new Chart(document.getElementById("barChart"), {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Net (kg)',
          data: values,
        }]
      },
      options: { responsive: true }
    });
  }
  (function() {
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
            }
        }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    const btn = document.getElementById('btn-send-report');
    const statusEl = document.getElementById('send-report-status');
    if (!btn) return;

    btn.addEventListener('click', async function(){
        const reportType = btn.dataset.reportType;
        const payload = new URLSearchParams();
        payload.append('report_type', reportType);
        if (reportType === 'daily') {
            const date = document.querySelector('input[name="date"]').value;
            payload.append('name', document.querySelector('input[name="name"]').value || '');
            payload.append('date', date || '');
            payload.append('group_by', btn.dataset.groupBy || 'none');
        }
        if (reportType === 'stock_balance') {
            payload.append('mode', btn.dataset.mode || 'current');

            if (btn.dataset.mode === 'period') {
                payload.append('date_from', '{{ request.GET.date_from|default:"" }}');
                payload.append('date_to', '{{ request.GET.date_to|default:"" }}');
                payload.append('unloading_place', '{{ request.GET.unloading_place|default:"" }}');
                payload.append('culture', '{{ request.GET.culture|default:"" }}');
            }
        }

        statusEl.textContent = '–í—ñ–¥–ø—Ä–∞–≤–ª—è—é...';

        try {
        const resp = await fetch("{% url 'reports_send' %}", {
            method: 'POST',
            headers: {
            'X-CSRFToken': csrftoken,
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
            },
            body: payload
        });

        // –Ω–∞–¥—ñ–π–Ω–æ –æ–±—Ä–æ–±–ª—è—î–º–æ —Ç—ñ–ª–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
        const contentType = resp.headers.get('content-type') || '';
        let data;
        if (contentType.includes('application/json')) {
            data = await resp.json();
        } else {
            // —Ñ–æ–ª–±–µ–∫ ‚Äî —Ç–µ–∫—Å—Ç (—â–µ –º–æ–∂–µ –±—É—Ç–∏ HTML –∞–±–æ plain text)
            const text = await resp.text();
            data = { sent: resp.ok ? true : false, status: resp.status, response: text, error: resp.ok ? null : text };
        }

        if (resp.ok && data.sent !== false) {
            statusEl.textContent = '‚úì –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ';
        } else {
            const errMsg = data.error || data.response || ('HTTP ' + resp.status);
            statusEl.textContent = '‚úï –ü–æ–º–∏–ª–∫–∞: ' + errMsg;
        }

        } catch (err) {
        // –º–µ—Ä–µ–∂–µ–≤—ñ –ø–æ–º–∏–ª–∫–∏, CORS, timeout (fetch –Ω–µ –º–∞—î timeout –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º)
        statusEl.textContent = '‚úï –ü–æ–º–∏–ª–∫–∞: ' + (err.message || err);
        console.error("Send report error:", err);
        }
    });
  })();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
