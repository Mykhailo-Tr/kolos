{% extends "base.html" %}
{% load static %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<link rel="stylesheet" href="{% static 'reports/css/dashboard.css' %}">
<link rel="stylesheet" href="{% static 'css/live_clock.css' %}">

<div class="reports-container">
    
    <div class="reports-header">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
            <h1 class="reports-title">
                <span>üìä</span>
                <span>–ó–≤—ñ—Ç–∏ —Ç–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞</span>
            </h1>
            <div style="display: flex; align-items: center; gap: 15px;">
                <div id="live-clock" class="live-clock-badge"></div> 
                <a href="{% url 'pdf_reports_dashboard' %}" class="btn btn-primary">
                    <i class="fas fa-file-pdf" style="margin-right: 8px;"></i> PDF –ó–≤—ñ—Ç–∏
                </a>
            </div>
        </div>
    </div>

    <h2 class="crm-summary-header">
        <span>üìÖ</span>
        <span>–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∏–π –∑–≤—ñ—Ç –∑–∞ {{ daily_summary.date }}</span>
    </h2>

    <div class="crm-summary-grid">
        
        <a href="{% url 'report_fields' %}" class="crm-card theme-green summary-link-card">
            <div class="crm-card-header">
                <div class="crm-icon-box">üå±</div>
                <div>
                    <h3 class="crm-card-title">–ó –ø–æ–ª—ñ–≤</h3>
                    <div class="crm-card-subtitle">–í–ª–∞—Å–Ω–∏–π —É—Ä–æ–∂–∞–π</div>
                </div>
            </div>

            <div class="crm-stats-row">
                <div class="crm-stat-group">
                    <span class="crm-label">–ü—Ä–∏—Ö—ñ–¥</span>
                    <div class="crm-value">
                        {{ daily_summary.today.fields.total|floatformat:0 }}<span class="crm-unit">—Ç</span>
                    </div>
                    <div class="crm-sub-value tooltip-container">
                        {% if daily_summary.trends.fields > 0 %}
                            <span class="trend-indicator trend-up">‚ñ≤ {{ daily_summary.trends.fields|floatformat:1 }}%</span>
                        {% elif daily_summary.trends.fields < 0 %}
                            <span class="trend-indicator trend-down">‚ñº {{ daily_summary.trends.fields|floatformat:1 }}%</span>
                        {% else %}
                            <span class="trend-indicator trend-neutral">‚Äî 0%</span>
                        {% endif %}
                        <span style="color: #94a3b8; font-size: 0.75rem;">–¥–æ –≤—á–æ—Ä–∞</span>
                        <div class="tooltip-content">–í—á–æ—Ä–∞: {{ daily_summary.yest_fields_total|floatformat:0 }}—Ç.</div>
                    </div>
                </div>
                <div class="crm-stat-group align-right">
                    <span class="crm-label">–û–ø–µ—Ä–∞—Ü—ñ–π</span>
                    <span class="crm-badge">{{ daily_summary.today.fields.count }} –∞–≤—Ç–æ</span>
                </div>
            </div>
            
            <div id="chart-fields" class="mini-chart"></div>
        </a>

        <a href="{% url 'report_shipment' %}" class="crm-card theme-orange summary-link-card">
            <div class="crm-card-header">
                <div class="crm-icon-box">üöõ</div>
                <div>
                    <h3 class="crm-card-title">–õ–æ–≥—ñ—Å—Ç–∏–∫–∞</h3>
                    <div class="crm-card-subtitle">–í–≤–µ–∑–µ–Ω–Ω—è —Ç–∞ –≤–∏–≤–µ–∑–µ–Ω–Ω—è</div>
                </div>
            </div>

            <div class="crm-stats-row">
                <div class="crm-stat-group">
                    <span class="crm-label" style="color: #16a34a;">‚¨á –í–≤–µ–∑–µ–Ω–Ω—è</span>
                    <div class="crm-value" style="font-size: 1.4rem;">
                        {{ daily_summary.today.shipment.in_total|floatformat:0 }}<span class="crm-unit" style="font-size: 0.8rem;">—Ç</span>
                    </div>
                    <div class="crm-sub-value tooltip-container">
                        {{ daily_summary.today.shipment.in_count }} –∞–≤—Ç–æ
                        {% if daily_summary.trends.shipment_in > 0 %}
                            <span class="trend-indicator trend-up" style="padding: 1px 4px;">‚ñ≤ {{ daily_summary.trends.shipment_in|floatformat:1 }}%</span>
                        {% elif daily_summary.trends.shipment_in < 0 %}
                             <span class="trend-indicator trend-down" style="padding: 1px 4px;">‚ñº {{ daily_summary.trends.shipment_in|floatformat:1 }}%</span>
                        {% endif %}
                    </div>
                </div>

                <div class="crm-stat-group align-right">
                    <span class="crm-label" style="color: #ea580c;">‚¨Ü –í–∏–≤–µ–∑–µ–Ω–Ω—è</span>
                    <div class="crm-value" style="font-size: 1.4rem;">
                        {{ daily_summary.today.shipment.out_total|floatformat:0 }}<span class="crm-unit" style="font-size: 0.8rem;">—Ç</span>
                    </div>
                    <div class="crm-sub-value" style="justify-content: flex-end;">
                        {{ daily_summary.today.shipment.out_count }} –∞–≤—Ç–æ
                        {% if daily_summary.trends.shipment_out > 0 %}
                            <span class="trend-indicator trend-up" style="padding: 1px 4px;">‚ñ≤ {{ daily_summary.trends.shipment_out|floatformat:1 }}%</span>
                        {% elif daily_summary.trends.shipment_out < 0 %}
                            <span class="trend-indicator trend-down" style="padding: 1px 4px;">‚ñº {{ daily_summary.trends.shipment_out|floatformat:1 }}%</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div id="chart-shipment" class="mini-chart"></div>
        </a>

        <a href="{% url 'report_weigher' %}" class="crm-card theme-blue summary-link-card">
            <div class="crm-card-header">
                <div class="crm-icon-box">üìã</div>
                <div>
                    <h3 class="crm-card-title">–ü–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è</h3>
                    <div class="crm-card-subtitle">–í–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π —Ä—É—Ö</div>
                </div>
            </div>

            <div class="crm-stats-row">
                <div class="crm-stat-group">
                    <span class="crm-label">–û–±—ñ–≥ –≤–∞–≥–∏</span>
                    <div class="crm-value">
                        {{ daily_summary.today.weigher.total|floatformat:0 }}<span class="crm-unit">—Ç</span>
                    </div>
                    <div class="crm-sub-value tooltip-container">
                        {% if daily_summary.trends.weigher > 0 %}
                            <span class="trend-indicator trend-up">‚ñ≤ {{ daily_summary.trends.weigher|floatformat:1 }}%</span>
                        {% elif daily_summary.trends.weigher < 0 %}
                            <span class="trend-indicator trend-down">‚ñº {{ daily_summary.trends.weigher|floatformat:1 }}%</span>
                        {% else %}
                             <span class="trend-indicator trend-neutral">‚Äî 0%</span>
                        {% endif %}
                        <span style="color: #94a3b8; font-size: 0.75rem;">–¥–æ –≤—á–æ—Ä–∞</span>
                    </div>
                </div>
                <div class="crm-stat-group align-right">
                    <span class="crm-label">–û–ø–µ—Ä–∞—Ü—ñ–π</span>
                    <span class="crm-badge">{{ daily_summary.today.weigher.count }} –∑–≤–∞–∂.</span>
                </div>
            </div>
            
            <div id="chart-weigher" class="mini-chart"></div>
        </a>        
        
        <a href="{% url 'report_balance' %}" class="crm-card theme-purple summary-link-card">
            <div class="crm-card-header">
                <div class="crm-icon-box">üì¶</div>
                <div>
                    <h3 class="crm-card-title">–°–∫–ª–∞–¥</h3>
                    <div class="crm-card-subtitle">–ó–∞–≥–∞–ª—å–Ω—ñ –∑–∞–ª–∏—à–∫–∏</div>
                </div>
            </div>

            <div class="crm-stats-row">
                <div class="crm-stat-group">
                    <span class="crm-label">–í—Å—å–æ–≥–æ –Ω–∞ —Å–∫–ª–∞–¥–∞—Ö</span>
                    <div class="crm-value">
                        {{ daily_summary.today.balance|floatformat:0 }}<span class="crm-unit">—Ç</span>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: auto; padding-top: 15px;">
                <div style="background: rgba(168, 85, 247, 0.1); border-radius: 8px; padding: 10px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-info-circle" style="color: #a855f7;"></i>
                    <span style="font-size: 0.8rem; color: #6b21a8; font-weight: 500;">–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –∞–∫—Ç—É–∞–ª—å–Ω–∞ –Ω–∞ –ø–æ—Ç–æ—á–Ω–∏–π –º–æ–º–µ–Ω—Ç</span>
                </div>
            </div>
        </a>

        <div class="crm-card theme-red">
            <div class="crm-card-header">
                <div class="crm-icon-box">üåç</div>
                <div>
                    <h3 class="crm-card-title">–ó–∞–≥–∞–ª—å–Ω–∏–π –û–±—ñ–≥</h3>
                    <div class="crm-card-subtitle">–í—Å—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó –∑–∞ –¥–µ–Ω—å</div>
                </div>
            </div>

            <div class="crm-stats-row" style="margin-top: 5px;">
                <div class="crm-stat-group">
                    <span class="crm-label">–ó–∞–≥–∞–ª—å–Ω–∞ –≤–∞–≥–∞</span>
                    <div class="crm-value" style="font-size: 2.2rem;">
                        {{ daily_summary.grand_total|floatformat:0 }}<span class="crm-unit">—Ç</span>
                    </div>
                    <div class="crm-sub-value">
                        <span class="trend-indicator trend-neutral">
                            ~ {{ daily_summary.today.fields.count|add:daily_summary.today.shipment.in_count|add:daily_summary.today.shipment.out_count|add:daily_summary.today.weigher.count }} –æ–ø–µ—Ä–∞—Ü—ñ–π
                        </span>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: auto; padding-top: 15px;">
                <div style="background: rgba(239, 68, 68, 0.1); border-radius: 8px; padding: 10px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-chart-bar" style="color: #ef4444;"></i>
                    <span style="font-size: 0.8rem; color: #b91c1c; font-weight: 500;">–°—É–º–∞ –ø—Ä–∏—Ö–æ–¥—É, –≤–∏–≤–µ–∑–µ–Ω–Ω—è —Ç–∞ –ø–µ—Ä–µ–º—ñ—â–µ–Ω—å.</span>
                </div>
            </div>
        </div>
        


    </div>
    
    <div class="reports-section">
        <h2 class="section-title">
            <span>üöÄ –®–≤–∏–¥–∫—ñ –∑–≤—ñ—Ç–∏</span>
        </h2>

        <div class="reports-grid">
            <a href="{% url 'report_balance' %}" class="report-card">
              <div class="report-icon">üì¶</div>
              <h3 class="report-title">–ó–∞–ª–∏—à–∫–∏</h3>
              <p class="report-desc">–ü–æ—Ç–æ—á–Ω—ñ –∑–∞–ª–∏—à–∫–∏ –ø–æ —Å–∫–ª–∞–¥–∞—Ö</p>
            </a>

            <a href="{% url 'report_waste' %}" class="report-card">
              <div class="report-icon">‚ôªÔ∏è</div>
              <h3 class="report-title">–í—ñ–¥—Ö–æ–¥–∏</h3>
              <p class="report-desc">–ê–Ω–∞–ª—ñ–∑ –≤—ñ–¥—Ö–æ–¥—ñ–≤ —Ç–∞ –≤—Ç—Ä–∞—Ç</p>
            </a>

            <a href="{% url 'report_weigher' %}" class="report-card">
              <div class="report-icon">üìã</div>
              <h3 class="report-title">–ü–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è</h3>
              <p class="report-desc">–í–Ω—É—Ç—Ä—ñ—à–Ω—ñ –ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è –∑–µ—Ä–Ω–∞</p>
            </a>

            <a href="{% url 'report_shipment' %}" class="report-card">
              <div class="report-icon">üöõ</div>
              <h3 class="report-title">–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</h3>
              <p class="report-desc">–í–≤–µ–∑–µ–Ω–Ω—è —Ç–∞ –≤–∏–≤–µ–∑–µ–Ω–Ω—è</p>
            </a>

            <a href="{% url 'report_fields' %}" class="report-card">
              <div class="report-icon">üå±</div>
              <h3 class="report-title">–ü–æ–ª—è</h3>
              <p class="report-desc">–ù–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è –∑ –ø–æ–ª—ñ–≤</p>
            </a>

            <a href="{% url 'report_daily' %}" class="report-card">
              <div class="report-icon">üìÖ</div>
              <h3 class="report-title">–î–µ–Ω–Ω–∏–π –∑–≤—ñ—Ç</h3>
              <p class="report-desc">–ü—ñ–¥—Å—É–º–∫–∏ –∑–∞ –¥–µ–Ω—å</p>
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
          <div class="reports-section">
            <h2 class="section-title">
              <span>üìú –Ü—Å—Ç–æ—Ä—ñ—è –∑–≤—ñ—Ç—ñ–≤</span>
              <a href="{% url 'report_history' %}" class="section-link">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –≤—Å—ñ ‚Üí</a>
            </h2>

            {% if recent_reports %}
              <ul class="report-list">
                {% for execution in recent_reports %}
                <li class="report-item">
                  <div class="report-item-title">{{ execution.template.name }}</div>
                  <div class="report-item-time">{{ execution.executed_at|date:"d.m.Y H:i" }}</div>
                </li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="empty-state">
                <div class="empty-icon">üìä</div>
                <p>–í–∏ —â–µ –Ω–µ —Å—Ç–≤–æ—Ä—é–≤–∞–ª–∏ –∑–≤—ñ—Ç–∏</p>
              </div>
            {% endif %}
          </div>
        </div>

        <div class="col-md-6">
          <div class="reports-section">
            <h2 class="section-title">
              <span>üíæ –ó–±–µ—Ä–µ–∂–µ–Ω—ñ –∑–≤—ñ—Ç–∏</span>
              <a href="{% url 'saved_reports' %}" class="section-link">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –≤—Å—ñ ‚Üí</a>
            </h2>

            {% if saved_reports %}
              <ul class="report-list">
                {% for saved in saved_reports %}
                <li class="report-item">
                  <div class="report-item-title">{{ saved.name }}</div>
                  <div class="report-item-time">{{ saved.created_at|date:"d.m.Y" }}</div>
                </li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="empty-state">
                <div class="empty-icon">üíæ</div>
                <p>–ù–µ–º–∞—î –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö –∑–≤—ñ—Ç—ñ–≤</p>
              </div>
            {% endif %}
          </div>
        </div>
    </div>
</div>

{% block extra_scripts %}
<script src="{% static 'js/live_clock.js' %}"></script>
{% endblock extra_scripts %}

<script>
    document.addEventListener('DOMContentLoaded', function () {

        // –î–∞–Ω—ñ –∑ –±–µ–∫–µ–Ω–¥—É (–∑–º—ñ–Ω–Ω—ñ –∑ Python)
        const sparklineDates = {{ daily_summary.sparklines.dates|safe }};
        
        // –°–ø—ñ–ª—å–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è Sparklines
        const commonOptions = {
            chart: {
                type: 'area',
                height: 50,
                sparkline: { enabled: true }
            },
            stroke: { curve: 'smooth', width: 2 },
            fill: { opacity: 0.2, type: 'solid' },
            xaxis: {
                categories: sparklineDates, // –î–æ–¥–∞–Ω–æ –¥–∞—Ç–∏ –¥–ª—è –ø—ñ–¥–∫–∞–∑–æ–∫
            },
            tooltip: {
                fixed: { enabled: false },
                x: { show: true, formatter: function(val) { return val; } }, // –ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –¥–∞—Ç—É
                y: { title: { formatter: function (seriesName) { return '–¢–æ–Ω–Ω' } } }, // –ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –æ–¥–∏–Ω–∏—Ü—é –≤–∏–º—ñ—Ä—É
                marker: { show: false }
            },
        };

        // 1. –ì—Ä–∞—Ñ—ñ–∫ –ü–æ–ª—ñ–≤ (Green)
        if (document.querySelector("#chart-fields")) {
            new ApexCharts(document.querySelector("#chart-fields"), {
                ...commonOptions,
                series: [{ name: '–ó –ø–æ–ª—ñ–≤', data: {{ daily_summary.sparklines.fields|safe }} }],
                colors: ['#22c55e']
            }).render();
        }

        // 2. –ì—Ä–∞—Ñ—ñ–∫ –í—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω—å (Orange - Out)
        if (document.querySelector("#chart-shipment")) {
            new ApexCharts(document.querySelector("#chart-shipment"), {
                ...commonOptions,
                series: [
                    { name: '–í–∏–≤–µ–∑–µ–Ω–Ω—è', data: {{ daily_summary.sparklines.shipment_out|safe }} }
                ],
                colors: ['#f97316']
            }).render();
        }

        // 3. –ì—Ä–∞—Ñ—ñ–∫ –ü–µ—Ä–µ–º—ñ—â–µ–Ω—å (Blue)
        if (document.querySelector("#chart-weigher")) {
            new ApexCharts(document.querySelector("#chart-weigher"), {
                ...commonOptions,
                series: [{ name: '–ü–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è', data: {{ daily_summary.sparklines.weigher|safe }} }],
                colors: ['#3b82f6']
            }).render();
        }
    });
</script>

{% endblock %}