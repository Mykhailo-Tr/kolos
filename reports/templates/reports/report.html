{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'reports/css/report.css' %}">
{% endblock %}

{% block content %}
<div class="report-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="report-header">
        <h1 class="report-title">üìä {{ report_title }}</h1>
        <a href="{% url 'reports_dashboard' %}" class="btn-back">‚Üê –ù–∞–∑–∞–¥ –¥–æ –∑–≤—ñ—Ç—ñ–≤</a>
    </div>

    <!-- –ü–æ–º–∏–ª–∫–∏ —Ñ–æ—Ä–º–∏ -->
    {% if form.errors %}
        <div class="error-alert">
            <strong>–í–∏–ø—Ä–∞–≤—Ç–µ –Ω–∞—Å—Ç—É–ø–Ω—ñ –ø–æ–º–∏–ª–∫–∏:</strong>
            <ul>
                {% for field in form %}
                    {% if field.errors %}
                        <li>{{ field.label }}: {{ field.errors|join:", " }}</li>
                    {% endif %}
                {% endfor %}
                {% if form.non_field_errors %}
                    {% for error in form.non_field_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                {% endif %}
            </ul>
        </div>
    {% endif %}

    <!-- –§—ñ–ª—å—Ç—Ä–∏ -->
    <div class="filters-panel">
        <h2 class="filters-title">
            <span>üîç</span>
            <span>–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –∑–≤—ñ—Ç—É</span>
        </h2>

        <form method="post" id="reportForm">
            {% csrf_token %}
            
            <div class="form-row">
                {% for field in form %}
                    <div class="form-group">
                        {{ field.label_tag }}
                        {{ field }}
                        {% if field.help_text %}
                            <small class="text-muted">{{ field.help_text }}</small>
                        {% endif %}
                        {% if field.errors %}
                            <div class="text-danger">{{ field.errors }}</div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>

            <button type="submit" class="btn-generate">
                üìà –°—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ –∑–≤—ñ—Ç
            </button>
        </form>
    </div>

    {% if filters_applied %}
        <!-- –î–æ–¥–∞—î–º–æ –±–ª–æ–∫ debug –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –¥–∞–Ω–∏—Ö -->
        {% if debug %}
        <div class="mt-3 p-3 bg-light border rounded">
            <small class="text-muted">Debug - –°—Ç—Ä—É–∫—Ç—É—Ä–∞ report_data:</small>
            <pre class="mt-2 mb-0"><code>{% if report_data %}{{ report_data|pprint }}{% else %}report_data is None{% endif %}</code></pre>
        </div>
        {% endif %}

        <!-- –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ -->
        {% if report_data %}
            <!-- –ü–∞–Ω–µ–ª—å –¥—ñ–π -->
            <div class="actions-panel">
                <div class="chart-selector">
                    <button class="chart-btn active" data-chart="table" title="–¢–∞–±–ª–∏—Ü—è">üìã</button>
                    <button class="chart-btn" data-chart="bar" title="–°—Ç–æ–≤–ø—á–∞—Å—Ç–∞ –¥—ñ–∞–≥—Ä–∞–º–∞">üìä</button>
                    <button class="chart-btn" data-chart="line" title="–õ—ñ–Ω—ñ–π–Ω–∏–π –≥—Ä–∞—Ñ—ñ–∫">üìà</button>
                    <button class="chart-btn" data-chart="pie" title="–ö—Ä—É–≥–æ–≤–∞ –¥—ñ–∞–≥—Ä–∞–º–∞">ü•ß</button>
                </div>

                <button class="btn-export" onclick="exportToCSV()" id="exportBtn">
                    üíæ –ï–∫—Å–ø–æ—Ä—Ç –≤ CSV
                </button>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            {% if report_data.aggregation %}
                <div class="results-panel" style="margin-bottom: 25px;">
                    <div class="results-header">
                        <h3 style="margin: 0; font-size: 1.1rem;">üìä –ü—ñ–¥—Å—É–º–∫–∏</h3>
                    </div>
                    <div class="stats-row">
                        {% for key, value in report_data.aggregation.items %}
                            {% if value != None and key != 'by_place' and key != 'by_culture' and key != 'by_route' and key != 'by_action' and key != 'by_field' %}
                                <div class="stat-box">
                                    <div class="stat-label">
                                        {% if key == 'total_quantity' %}–ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å
                                        {% elif key == 'total_waste' %}–ó–∞–≥–∞–ª—å–Ω—ñ –≤—ñ–¥—Ö–æ–¥–∏
                                        {% elif key == 'total_weight' %}–ó–∞–≥–∞–ª—å–Ω–∞ –≤–∞–≥–∞
                                        {% elif key == 'total_rows' %}–£—Å—å–æ–≥–æ –∑–∞–ø–∏—Å—ñ–≤
                                        {% else %}{{ key }}{% endif %}
                                    </div>
                                    <div class="stat-value">
                                        {% if value|floatformat == "0" %}
                                            {{ value|floatformat:"0" }}
                                        {% else %}
                                            {{ value|floatformat:"3" }}
                                        {% endif %}
                                        {% if key == 'total_quantity' or key == 'total_waste' or key == 'total_weight' or key == 'total_weight' %}—Ç{% endif %}
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ -->
            {% if report_data.data and report_data.data|length > 0 %}
                <div class="results-panel">
                    <div class="results-header">
                        <span class="results-count">–ó–Ω–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å—ñ–≤: {{ report_data.total_rows }}</span>
                    </div>

                    <!-- –¢–∞–±–ª–∏—Ü—è -->
                    <div id="tableView">
                        <div style="overflow-x: auto;">
                            <table class="report-table">
                                <thead>
                                    <tr>
                                        {% for key in report_data.data.0.keys %}
                                            <th>
                                                {% if key == 'place' %}–ú—ñ—Å—Ü–µ
                                                {% elif key == 'culture' %}–ö—É–ª—å—Ç—É—Ä–∞
                                                {% elif key == 'type' %}–¢–∏–ø
                                                {% elif key == 'quantity' %}–ö—ñ–ª—å–∫—ñ—Å—Ç—å (—Ç)
                                                {% elif key == 'date' %}–î–∞—Ç–∞
                                                {% elif key == 'document' %}–î–æ–∫—É–º–µ–Ω—Ç
                                                {% elif key == 'from_place' %}–ó–≤—ñ–¥–∫–∏
                                                {% elif key == 'to_place' %}–ö—É–¥–∏
                                                {% elif key == 'weight_net' %}–í–∞–≥–∞ –Ω–µ—Ç—Ç–æ (—Ç)
                                                {% elif key == 'driver' %}–í–æ–¥—ñ–π
                                                {% elif key == 'car' %}–ê–≤—Ç–æ–º–æ–±—ñ–ª—å
                                                {% elif key == 'action_type' %}–¢–∏–ø –æ–ø–µ—Ä–∞—Ü—ñ—ó
                                                {% elif key == 'place_from' %}–ú—ñ—Å—Ü–µ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è
                                                {% elif key == 'place_to' %}–ú—ñ—Å—Ü–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è
                                                {% elif key == 'field' %}–ü–æ–ª–µ
                                                {% else %}{{ key }}{% endif %}
                                            </th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in report_data.data %}
                                    <tr>
                                        {% for key, value in row.items %}
                                            <td>
                                                {% if value == None or value == "" or value == "‚Äî" %}
                                                    ‚Äî
                                                {% elif value|floatformat == "0" %}
                                                    {{ value|floatformat:"0" }}
                                                {% elif key == 'date' %}
                                                    {{ value }}
                                                {% elif key == 'quantity' or key == 'weight_net' %}
                                                    {{ value|floatformat:"3" }}
                                                {% else %}
                                                    {{ value }}
                                                {% endif %}
                                                {% if key == 'quantity' or key == 'weight_net' %} —Ç{% endif %}
                                            </td>
                                        {% endfor %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- –ì—Ä–∞—Ñ—ñ–∫–∏ -->
                    <div id="chartView" class="chart-container" style="display: none;">
                        <canvas id="reportChart"></canvas>
                    </div>
                </div>
            
            {% else %}
                <!-- –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –¥–∞–Ω–∏—Ö -->
                <div class="results-panel">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <p><strong>–î–∞–Ω—ñ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∑–∞ –≤–∫–∞–∑–∞–Ω–∏–º–∏ –∫—Ä–∏—Ç–µ—Ä—ñ—è–º–∏</strong></p>
                        <p class="text-muted">–°–ø—Ä–æ–±—É–π—Ç–µ –∑–º—ñ–Ω–∏—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó –∞–±–æ –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –¥–∞–Ω–∏—Ö –∑–∞ –≤–∏–±—Ä–∞–Ω–∏–π –ø–µ—Ä—ñ–æ–¥.</p>
                    </div>
                </div>
            {% endif %}
        
        {% elif form.is_bound %}
            <!-- –§–æ—Ä–º–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∞, –∞–ª–µ —î –ø–æ–º–∏–ª–∫–∏ -->
            <div class="results-panel">
                <div class="empty-state">
                    <div class="empty-state-icon">‚ö†Ô∏è</div>
                    <p><strong>–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–±—Ä–æ–±—Ü—ñ –∑–∞–ø–∏—Ç—É</strong></p>
                    <p class="text-muted">–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ—Å—Ç—å –≤–≤–µ–¥–µ–Ω–∏—Ö –¥–∞—Ç —Ç–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó.</p>
                </div>
            </div>
        {% endif %}
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // –ë–µ–∑–ø–µ—á–Ω–µ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –∑ Django
    let reportData = null;
    {% if report_data and report_data.data %}
        try {
            reportData = {
                records: {{ report_data.data|safe }},  // –ó–ú–Ü–ù–ê: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ data –∑–∞–º—ñ—Å—Ç—å records
                summary: {{ report_data.aggregation|default:"{}"|safe }},  // –ó–ú–Ü–ù–ê: aggregation –∑–∞–º—ñ—Å—Ç—å summary
                total_rows: {{ report_data.total_rows|default:"0"|safe }}
            };
        } catch (e) {
            console.error('Error parsing report data:', e);
            reportData = null;
        }
    {% endif %}

    console.log('Report data loaded:', reportData);

    let currentChart = null;

    // –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –≤–∏–¥—ñ–≤
    document.querySelectorAll('.chart-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const chartType = this.dataset.chart;
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –∞–∫—Ç–∏–≤–Ω—É –∫–Ω–æ–ø–∫—É
            document.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // –ü–æ–∫–∞–∑—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π –≤–∏–¥
            if (chartType === 'table') {
                document.getElementById('tableView').style.display = 'block';
                document.getElementById('chartView').style.display = 'none';
            } else {
                document.getElementById('tableView').style.display = 'none';
                document.getElementById('chartView').style.display = 'block';
                renderChart(chartType);
            }
        });
    });

    function renderChart(type) {
        const ctx = document.getElementById('reportChart');
        if (!ctx) return;
        
        if (currentChart) {
            currentChart.destroy();
        }
        
        // –°–ø—Ä–æ–±—É—î–º–æ –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–∞–Ω—ñ –¥–ª—è –≥—Ä–∞—Ñ—ñ–∫–∞ –∑ –∞–≥—Ä–µ–≥–∞—Ü—ñ—ó
        let chartData = null;
        if (reportData && reportData.summary) {
            // –®—É–∫–∞—î–º–æ –ø–µ—Ä—à—ñ –¥–æ—Å—Ç—É–ø–Ω—ñ –∞–≥—Ä–µ–≥–æ–≤–∞–Ω—ñ –¥–∞–Ω—ñ –¥–ª—è –≥—Ä–∞—Ñ—ñ–∫–∞
            const possibleCharts = ['by_culture', 'by_place', 'by_route', 'by_action', 'by_field'];
            for (const chartKey of possibleCharts) {
                if (reportData.summary[chartKey] && Object.keys(reportData.summary[chartKey]).length > 0) {
                    const dataObj = reportData.summary[chartKey];
                    chartData = {
                        labels: Object.keys(dataObj),
                        data: Object.values(dataObj),
                        datasetLabel: getChartLabel(chartKey),
                        unit: '—Ç'
                    };
                    break;
                }
            }
        }
        
        // –Ø–∫—â–æ –Ω–µ–º–∞—î –∞–≥—Ä–µ–≥–æ–≤–∞–Ω–∏—Ö –¥–∞–Ω–∏—Ö, –≥–µ–Ω–µ—Ä—É—î–º–æ –∑ –∑–∞–ø–∏—Å—ñ–≤
        if (!chartData && reportData && reportData.records && reportData.records.length > 0) {
            chartData = generateChartDataFromRecords();
        }
        
        if (!chartData || !chartData.labels || chartData.labels.length === 0) {
            console.warn('No data available for chart');
            document.getElementById('chartView').innerHTML = '<p class="text-muted text-center">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –ø–æ–±—É–¥–æ–≤–∏ –≥—Ä–∞—Ñ—ñ–∫–∞</p>';
            return;
        }
        
        currentChart = new Chart(ctx, {
            type: type,
            data: {
                labels: chartData.labels,
                datasets: [{
                    label: chartData.datasetLabel || '–ó–Ω–∞—á–µ–Ω–Ω—è',
                    data: chartData.data,
                    backgroundColor: getChartColors(chartData.labels.length),
                    borderColor: getChartColors(chartData.labels.length, false),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: type === 'pie' || type === 'doughnut',
                        position: 'right'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += context.parsed.y || context.parsed;
                                if (chartData.unit) {
                                    label += ' ' + chartData.unit;
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: type !== 'pie' && type !== 'doughnut' ? {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toFixed(1) + (chartData.unit ? ' ' + chartData.unit : '');
                            }
                        }
                    }
                } : undefined
            }
        });
    }

    function getChartLabel(chartKey) {
        const labels = {
            'by_culture': '–†–æ–∑–ø–æ–¥—ñ–ª –ø–æ –∫—É–ª—å—Ç—É—Ä–∞—Ö',
            'by_place': '–†–æ–∑–ø–æ–¥—ñ–ª –ø–æ –º—ñ—Å—Ü—è—Ö',
            'by_route': '–†–æ–∑–ø–æ–¥—ñ–ª –ø–æ –º–∞—Ä—à—Ä—É—Ç–∞—Ö',
            'by_action': '–†–æ–∑–ø–æ–¥—ñ–ª –ø–æ —Ç–∏–ø–∞—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π',
            'by_field': '–†–æ–∑–ø–æ–¥—ñ–ª –ø–æ –ø–æ–ª—è—Ö'
        };
        return labels[chartKey] || chartKey;
    }

    function getChartColors(count, transparent = true) {
        const baseColors = [
            'rgba(37, 99, 235, {alpha})',
            'rgba(16, 185, 129, {alpha})',
            'rgba(245, 158, 11, {alpha})',
            'rgba(239, 68, 68, {alpha})',
            'rgba(139, 92, 246, {alpha})',
            'rgba(20, 184, 166, {alpha})',
            'rgba(249, 115, 22, {alpha})',
        ];
        
        return baseColors.slice(0, count).map(color => 
            color.replace('{alpha}', transparent ? '0.6' : '1')
        );
    }

    function generateChartDataFromRecords() {
        if (!reportData || !reportData.records || reportData.records.length === 0) {
            return null;
        }
        
        // –°–ø—Ä–æ–±—É—î–º–æ –∑–Ω–∞–π—Ç–∏ —á–∏—Å–ª–æ–≤—ñ –ø–æ–ª—è –¥–ª—è –≥—Ä–∞—Ñ—ñ–∫–∞
        const records = reportData.records;
        const firstRecord = records[0];
        
        // –ó–Ω–∞–π–¥–µ–º–æ —á–∏—Å–ª–æ–≤—ñ –ø–æ–ª—è —Ç–∞ –ø–æ–ª—è –¥–ª—è –≥—Ä—É–ø—É–≤–∞–Ω–Ω—è
        let numericField = null;
        let groupField = null;
        
        for (const key in firstRecord) {
            const value = firstRecord[key];
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Ü–µ —á–∏—Å–ª–æ–≤–µ –ø–æ–ª–µ (–≤–∞–≥–∞ –∞–±–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å)
            if ((typeof value === 'number' || !isNaN(parseFloat(value))) && 
                (key.toLowerCase().includes('–≤–∞–≥–∞') || 
                 key.toLowerCase().includes('–∫—ñ–ª—å–∫—ñ—Å—Ç—å') ||
                 key.toLowerCase().includes('weight') ||
                 key.toLowerCase().includes('quantity'))) {
                numericField = key;
            } 
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Ü–µ –ø–æ–ª–µ –¥–ª—è –≥—Ä—É–ø—É–≤–∞–Ω–Ω—è (—Ä—è–¥–∫–æ–≤–µ —ñ –Ω–µ –¥–∞—Ç–∞)
            else if (typeof value === 'string' && value !== "‚Äî" && value.length > 0 && 
                     !key.toLowerCase().includes('–¥–∞—Ç–∞') && 
                     !key.toLowerCase().includes('date') &&
                     !key.toLowerCase().includes('—á–∞—Å') &&
                     !key.toLowerCase().includes('time') &&
                     key !== 'document' && key !== 'driver' && key !== 'car') {
                groupField = key;
            }
        }
        
        if (!numericField || !groupField) {
            console.log('No suitable fields found for chart:', { numericField, groupField });
            return null;
        }
        
        // –ì—Ä—É–ø—É—î–º–æ –¥–∞–Ω—ñ
        const groupedData = {};
        records.forEach(record => {
            const groupValue = record[groupField] || '–Ü–Ω—à–µ';
            const numericValue = parseFloat(record[numericField]) || 0;
            
            if (!groupedData[groupValue]) {
                groupedData[groupValue] = 0;
            }
            groupedData[groupValue] += numericValue;
        });
        
        // –§—ñ–ª—å—Ç—Ä—É—î–º–æ –ø–æ—Ä–æ–∂–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è
        Object.keys(groupedData).forEach(key => {
            if (groupedData[key] === 0 || key === "‚Äî") {
                delete groupedData[key];
            }
        });
        
        if (Object.keys(groupedData).length === 0) {
            return null;
        }
        
        return {
            labels: Object.keys(groupedData),
            data: Object.values(groupedData),
            datasetLabel: `–†–æ–∑–ø–æ–¥—ñ–ª –ø–æ ${getFieldLabel(groupField)}`,
            unit: '—Ç'
        };
    }

    function getFieldLabel(field) {
        const labels = {
            'place': '–º—ñ—Å—Ü—è—Ö',
            'culture': '–∫—É–ª—å—Ç—É—Ä–∞—Ö',
            'from_place': '–º—ñ—Å—Ü—è—Ö –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è',
            'to_place': '–º—ñ—Å—Ü—è—Ö –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è',
            'action_type': '—Ç–∏–ø–∞—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π',
            'field': '–ø–æ–ª—è—Ö'
        };
        return labels[field] || field;
    }

    function exportToCSV() {
        if (!reportData || !reportData.records || reportData.records.length === 0) {
            alert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É');
            return;
        }
        
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "export_report" %}';
        form.style.display = 'none';
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const records = reportData.records;
        
        // –ì–æ—Ç—É—î–º–æ –¥–∞–Ω—ñ –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É
        const exportData = JSON.stringify(records);
        const columns = Object.keys(records[0] || {}).join(',');
        
        form.innerHTML = `
            <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
            <input type="hidden" name="data" value='${exportData}'>
            <input type="hidden" name="columns" value="${columns}">
            <input type="hidden" name="report_name" value="{{ report_type }}">
        `;
        
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫–∞, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
    document.addEventListener('DOMContentLoaded', function() {
        // –Ø–∫—â–æ —î –¥–∞–Ω—ñ –¥–ª—è –≥—Ä–∞—Ñ—ñ–∫–∞, –º–æ–∂–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç–∏—Å—å –Ω–∞ –≥—Ä–∞—Ñ—ñ—á–Ω–∏–π –≤–∏–≥–ª—è–¥
        if (reportData && (reportData.summary || (reportData.records && reportData.records.length > 0))) {
            setTimeout(() => {
                const chartBtn = document.querySelector('.chart-btn[data-chart="bar"]');
                if (chartBtn) {
                    chartBtn.click();
                }
            }, 1000);
        }
    });
</script>
{% endblock %}