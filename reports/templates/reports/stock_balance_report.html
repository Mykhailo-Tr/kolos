{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container mt-4">

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ + –ø–µ—Ä–µ–º–∏–∫–∞—á -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>üì¶ –ó–≤—ñ—Ç: –∑–∞–ª–∏—à–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥–∞—Ö</h2>
        <div class="btn-group">
            <a href="?mode=period" class="btn btn-sm {% if mode == 'period' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                –ó–≤—ñ—Ç –∑–∞ –ø–µ—Ä—ñ–æ–¥
            </a>
            <a href="?mode=current" class="btn btn-sm {% if mode == 'current' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                –°—Ç–∞–Ω–æ–º –Ω–∞ –∑–∞—Ä–∞–∑
            </a>
        </div>
    </div>

    <!-- –ï–∫—Å–ø–æ—Ä—Ç CSV —Ç—ñ–ª—å–∫–∏ –¥–ª—è –∑–≤—ñ—Ç—É –∑–∞ –ø–µ—Ä—ñ–æ–¥ -->
    <a href="?mode={{ mode }}&export=csv{% if mode == 'period' %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}{% endif %}"
        class="btn btn-sm btn-outline-secondary">
        ‚¨á –ï–∫—Å–ø–æ—Ä—Ç CSV
    </a>
    <div class="d-inline-block ms-3">
        <label for="name" class="form-label d-block small mt-2">–Ü–º'—è —Ñ–∞–π–ª—É –Ω–∞ —Ä–µ–ø–æ—Ä—Ç-—Å–µ—Ä–≤–µ—Ä—ñ:</label>
        <input name="name" type="text" class="form-control form-control-sm"
            placeholder="–Ü–º'—è —Ñ–∞–π–ª—É –Ω–∞ —Ä–µ–ø–æ—Ä—Ç-—Å–µ—Ä–≤–µ—Ä—ñ"
            value="{% if mode == 'period' %}stock_balance_report_period.csv{% else %}stock_balance_report_current.csv{% endif %}">
        <button id="btn-send-report" class="btn btn-outline-primary"
            data-report-type="stock_balance"
            data-date="{{ selected_date|default:today }}"
            data-group-by="{{ group_by|default:'none' }}"
            data-mode="{{ mode|default:'current' }}">
        –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–≤—ñ—Ç –Ω–∞ —Ä–µ–ø–æ—Ä—Ç-—Å–µ—Ä–≤–µ—Ä
        </button>
        <span id="send-report-status" class="ms-2"></span>
    </div>


    <!-- –§–æ—Ä–º–∞ —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ —Ç—ñ–ª—å–∫–∏ –¥–ª—è —Ä–µ–∂–∏–º—É "–ø–µ—Ä—ñ–æ–¥" -->
    {% if mode == "period" %}
    <form method="get" class="card card-body mb-4">
        <input type="hidden" name="mode" value="period">
        <div class="row g-2">
            <div class="col-auto">
                {{ form.date_from.label_tag }} {{ form.date_from }}
            </div>
            <div class="col-auto">
                {{ form.date_to.label_tag }} {{ form.date_to }}
            </div>
            <div class="col-auto">
                {{ form.unloading_place.label_tag }} {{ form.unloading_place }}
            </div>
            <div class="col-auto">
                {{ form.culture.label_tag }} {{ form.culture }}
            </div>
            <div class="col-auto">
                <button class="btn btn-primary" type="submit">–§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </form>
    {% endif %}

    <!-- –ì—Ä–∞—Ñ—ñ–∫ + –ø–æ–∫–∞–∑–Ω–∏–∫–∏ -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <canvas id="stockChart" height="120"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6>–ü–æ–∫–∞–∑–Ω–∏–∫–∏</h6>
                    {% if mode == "period" %}
                        <p>–ü–µ—Ä—ñ–æ–¥: <strong>{{ date_from }} ‚Äî {{ date_to }}</strong></p>
                    {% else %}
                        <p><strong>–°—Ç–∞–Ω–æ–º –Ω–∞ –∑–∞—Ä–∞–∑</strong></p>
                    {% endif %}
                    <p>–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ä—è–¥–∫—ñ–≤: <strong>{{ rows|length }}</strong></p>
                </div>
            </div>
        </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü—è -->
    <div class="card shadow-sm">
        <div class="card-body">
            <h5 class="mb-3">
                {% if mode == "period" %}–¢–∞–±–ª–∏—Ü—è –∑–∞–ª–∏—à–∫—ñ–≤ –∑–∞ –ø–µ—Ä—ñ–æ–¥{% else %}–ü–æ—Ç–æ—á–Ω—ñ –∑–∞–ª–∏—à–∫–∏{% endif %}
            </h5>
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>–°–∫–ª–∞–¥</th>
                            <th>–ö—É–ª—å—Ç—É—Ä–∞</th>
                            {% if mode == "period" %}
                                <th class="text-end">–ù–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è (–∫–≥)</th>
                                <th class="text-end">–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ (–∫–≥)</th>
                            {% endif %}
                            <th class="text-end">–ë–∞–ª–∞–Ω—Å (–∫–≥)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in rows %}
                        <tr>
                            <td>{{ r.place_name }}</td>
                            <td>{{ r.culture }}</td>
                            {% if mode == "period" %}
                                <td class="text-end">{{ r.in_net|default:"‚Äî"|floatformat:2 }}</td>
                                <td class="text-end">{{ r.out_net|default:"‚Äî"|floatformat:2 }}</td>
                            {% endif %}
                            <td class="text-end">{{ r.balance|floatformat:2 }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="{% if mode == 'period' %}5{% else %}3{% endif %}" class="text-muted text-center">
                                {% if mode == "period" %}
                                    –ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –∑–∞ –æ–±—Ä–∞–Ω–∏–π –ø–µ—Ä—ñ–æ–¥.
                                {% else %}
                                    –ù–µ–º–∞—î –ø–æ—Ç–æ—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö.
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    (function(){
        const labels = {{ chart_labels|safe }};
        const values = {{ chart_values|safe }};
        const ctx = document.getElementById('stockChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '–ë–∞–ª–∞–Ω—Å (–∫–≥)',
                    data: values,
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    x: { title: { display: false } },
                    y: { title: { display: true, text: '–ö—ñ–ª–æ–≥—Ä–∞–º–∏ (kg)' } }
                }
            }
        });
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
            }
        }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    const btn = document.getElementById('btn-send-report');
    const statusEl = document.getElementById('send-report-status');
    if (!btn) return;

    btn.addEventListener('click', async function(){
        const reportType = btn.dataset.reportType;
        const payload = new URLSearchParams();
        payload.append('report_type', reportType);
        if (reportType === 'daily') {
            payload.append('name', document.querySelector('input[name="name"]').value || '');
            payload.append('date', btn.dataset.date || '');
            payload.append('group_by', btn.dataset.groupBy || 'none');
        }
        if (reportType === 'stock_balance') {
            payload.append('mode', btn.dataset.mode || 'current');

            if (btn.dataset.mode === 'period') {
                payload.append('name', document.querySelector('input[name="name"]').value || '');
                payload.append('date_from', '{{ request.GET.date_from|default:"" }}');
                payload.append('date_to', '{{ request.GET.date_to|default:"" }}');
                payload.append('unloading_place', '{{ request.GET.unloading_place|default:"" }}');
                payload.append('culture', '{{ request.GET.culture|default:"" }}');
            }
        }

        statusEl.textContent = '–í—ñ–¥–ø—Ä–∞–≤–ª—è—é...';

        try {
        const resp = await fetch("{% url 'reports_send' %}", {
            method: 'POST',
            headers: {
            'X-CSRFToken': csrftoken,
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
            },
            body: payload
        });

        // –Ω–∞–¥—ñ–π–Ω–æ –æ–±—Ä–æ–±–ª—è—î–º–æ —Ç—ñ–ª–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
        const contentType = resp.headers.get('content-type') || '';
        let data;
        if (contentType.includes('application/json')) {
            data = await resp.json();
        } else {
            // —Ñ–æ–ª–±–µ–∫ ‚Äî —Ç–µ–∫—Å—Ç (—â–µ –º–æ–∂–µ –±—É—Ç–∏ HTML –∞–±–æ plain text)
            const text = await resp.text();
            data = { sent: resp.ok ? true : false, status: resp.status, response: text, error: resp.ok ? null : text };
        }

        if (resp.ok && data.sent !== false) {
            statusEl.textContent = '‚úì –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ';
        } else {
            const errMsg = data.error || data.response || ('HTTP ' + resp.status);
            statusEl.textContent = '‚úï –ü–æ–º–∏–ª–∫–∞: ' + errMsg;
        }

        } catch (err) {
        // –º–µ—Ä–µ–∂–µ–≤—ñ –ø–æ–º–∏–ª–∫–∏, CORS, timeout (fetch –Ω–µ –º–∞—î timeout –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º)
        statusEl.textContent = '‚úï –ü–æ–º–∏–ª–∫–∞: ' + (err.message || err);
        console.error("Send report error:", err);
        }
    });
    })();
</script>
{% endblock %}
