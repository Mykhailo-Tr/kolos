{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid mt-4">
    <h2 class="mb-3">üìä –ó–≤—ñ—Ç –ø–æ —Ä–µ–π—Å–∞–º</h2>

    <!-- –§—ñ–ª—å—Ç—Ä–∏ -->
    <form method="get" class="mb-3">
        <div class="row row-cols-auto g-2 align-items-end">
            <div class="col">{{ form.start_date.label_tag }} {{ form.start_date }}</div>
            <div class="col">{{ form.end_date.label_tag }} {{ form.end_date }}</div>
            <div class="col">{{ form.driver.label_tag }} {{ form.driver }}</div>
            <div class="col">{{ form.car.label_tag }} {{ form.car }}</div>
            <div class="col">{{ form.trailer.label_tag }} {{ form.trailer }}</div>
            <div class="col">{{ form.culture.label_tag }} {{ form.culture }}</div>
            <div class="col">{{ form.sender.label_tag }} {{ form.sender }}</div>
            <div class="col">{{ form.receiver.label_tag }} {{ form.receiver }}</div>
            <div class="col">{{ form.unloading_place.label_tag }} {{ form.unloading_place }}</div>
            <div class="col">
                <button type="submit" class="btn btn-primary">üîé –§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </form>

    <hr>

    <!-- –¢–∞–±–ª–∏—Ü—è -->
    <div class="table-responsive shadow-sm rounded">
        <table class="table table-hover table-striped align-middle">
            <thead class="table-dark">
                <tr>
                    <th>‚Ññ –¥–æ–∫—É–º–µ–Ω—Ç–∞</th>
                    <th>–î–∞—Ç–∞</th>
                    <th>–í—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫</th>
                    <th>–û—Ç—Ä–∏–º—É–≤–∞—á</th>
                    <th>–ú–∞—à–∏–Ω–∞</th>
                    <th>–í–æ–¥—ñ–π</th>
                    <th>–ü—Ä–∏—á—ñ–ø</th>
                    <th>–ö—É–ª—å—Ç—É—Ä–∞</th>
                    <th>–í–∞–≥–∞ –±—Ä—É—Ç—Ç–æ</th>
                    <th>–í–∞–≥–∞ —Ç–∞—Ä–∞</th>
                    <th>–ù–µ—Ç—Ç–æ</th>
                </tr>
            </thead>
            <tbody>
                {% for trip in trips %}
                <tr class="clickable-row" data-bs-toggle="collapse" data-bs-target="#trip{{ trip.id }}">
                    <td>{{ trip.document_number }}</td>
                    <td>{{ trip.date_time|date:"d.m.Y H:i" }}</td>
                    <td>{{ trip.sender }}</td>
                    <td>{{ trip.receiver }}</td>
                    <td>{{ trip.car }}</td>
                    <td>{{ trip.driver }}</td>
                    <td>{{ trip.trailer }}</td>
                    <td>{{ trip.culture }}</td>
                    <td>{{ trip.weight_gross }}</td>
                    <td>{{ trip.weight_tare }}</td>
                    <td>{{ trip.net_weight }}</td>
                </tr>
                <tr class="collapse bg-light" id="trip{{ trip.id }}">
                    <td colspan="11">
                        <div class="p-2">
                            <strong>–î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è:</strong><br>
                            üìç –ú—ñ—Å—Ü–µ —Ä–æ–∑–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: {{ trip.unloading_place }}<br>
                            üè¢ –í—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫: {{ trip.sender }}<br>
                            üöõ –ê–≤—Ç–æ–º–æ–±—ñ–ª—å: {{ trip.car }} / {{ trip.trailer }}<br>
                            üë®‚Äç‚úàÔ∏è –í–æ–¥—ñ–π: {{ trip.driver }}<br>
                            üåæ –ö—É–ª—å—Ç—É—Ä–∞: {{ trip.culture }}<br>
                            üìù –î–∞—Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è: {{ trip.date_time|date:"d.m.Y H:i" }}
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="11" class="text-center">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- –ì—Ä–∞—Ñ—ñ–∫–∏ -->
    <div class="row mt-5 g-4">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">üìä –†–æ–∑–ø–æ–¥—ñ–ª –ø–æ –∫—É–ª—å—Ç—É—Ä–∞—Ö</div>
                <div class="card-body">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">ü•ß –ß–∞—Å—Ç–∫–∏ –∫—É–ª—å—Ç—É—Ä</div>
                <div class="card-body">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const colors = [
        'rgba(255, 99, 132, 0.6)',
        'rgba(54, 162, 235, 0.6)',
        'rgba(255, 206, 86, 0.6)',
        'rgba(75, 192, 192, 0.6)',
        'rgba(153, 102, 255, 0.6)',
        'rgba(255, 159, 64, 0.6)',
    ];

    // –î–∞–Ω—ñ –¥–ª—è –≥—Ä–∞—Ñ—ñ–∫—ñ–≤ (–∞–≥—Ä–µ–≥–æ–≤–∞–Ω—ñ)
    const labels = {{ culture_labels|safe }};
    const values = {{ culture_values|safe }};

    // –ë–∞—Ä-—á–∞—Ä—Ç
    new Chart(document.getElementById('barChart'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '–í–∞–≥–∞ –Ω–µ—Ç—Ç–æ (–∫–≥)',
                data: values,
                backgroundColor: colors,
            }]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: { enabled: true },
                legend: { display: false }
            },
            animation: { duration: 1200, easing: 'easeOutBounce' }
        }
    });

    // Pie chart
    new Chart(document.getElementById('pieChart'), {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: colors,
                hoverOffset: 15
            }]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(ctx) {
                            let label = ctx.label || '';
                            let value = ctx.raw || 0;
                            return `${label}: ${value} –∫–≥`;
                        }
                    }
                },
                legend: {
                    position: 'bottom',
                    labels: { usePointStyle: true }
                }
            }
        }
    });
</script>

<!-- Bootstrap collapse -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
