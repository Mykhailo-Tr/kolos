{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid mt-4">
    <h2 class="mb-3">üìä –ó–≤—ñ—Ç –ø–æ —Ä–µ–π—Å–∞–º</h2>

    <!-- –§—ñ–ª—å—Ç—Ä–∏ -->
    <form method="get" class="mb-3">
        <div class="row row-cols-auto g-2 align-items-end">
            <div class="col">{{ form.start_date.label_tag }} {{ form.start_date }}</div>
            <div class="col">{{ form.end_date.label_tag }} {{ form.end_date }}</div>
            <div class="col">{{ form.driver.label_tag }} {{ form.driver }}</div>
            <div class="col">{{ form.car.label_tag }} {{ form.car }}</div>
            <div class="col">{{ form.trailer.label_tag }} {{ form.trailer }}</div>
            <div class="col">{{ form.culture.label_tag }} {{ form.culture }}</div>
            <div class="col">{{ form.sender.label_tag }} {{ form.sender }}</div>
            <div class="col">{{ form.receiver.label_tag }} {{ form.receiver }}</div>
            <div class="col">{{ form.unloading_place.label_tag }} {{ form.unloading_place }}</div>
            <div class="col">
                <button type="submit" class="btn btn-primary">üîé –§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </form>

    <hr>

    <!-- –¢–∞–±–ª–∏—Ü—è -->
    <div class="table-responsive shadow-sm rounded">
        <table class="table table-hover table-striped align-middle">
            <thead class="table-dark">
                <tr>
                    <th>‚Ññ –¥–æ–∫—É–º–µ–Ω—Ç–∞</th>
                    <th>–î–∞—Ç–∞</th>
                    <th>–í—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫</th>
                    <th>–û—Ç—Ä–∏–º—É–≤–∞—á</th>
                    <th>–ú–∞—à–∏–Ω–∞</th>
                    <th>–í–æ–¥—ñ–π</th>
                    <th>–ü—Ä–∏—á—ñ–ø</th>
                    <th>–ö—É–ª—å—Ç—É—Ä–∞</th>
                    <th>–í–∞–≥–∞ –±—Ä—É—Ç—Ç–æ</th>
                    <th>–í–∞–≥–∞ —Ç–∞—Ä–∞</th>
                    <th>–ù–µ—Ç—Ç–æ</th>
                    <th>‚ÑπÔ∏è</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in entrys %}
                <tr>
                    <td>{{ entry.document_number }}</td>
                    <td>{{ entry.date_time|date:"d.m.Y H:i" }}</td>
                    <td>{{ entry.sender }}</td>
                    <td>{{ entry.receiver }}</td>
                    <td>{{ entry.car }}</td>
                    <td>{{ entry.driver }}</td>
                    <td>{{ entry.trailer }}</td>
                    <td>{{ entry.culture }}</td>
                    <td>{{ entry.weight_gross }}</td>
                    <td>{{ entry.weight_tare }}</td>
                    <td>{{ entry.net_weight }}</td>
                    <td>
                        <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#modal{{ entry.id }}">
                            üìÑ
                        </button>
                    </td>
                </tr>

                <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ -->
                <div class="modal fade" id="modal{{ entry.id }}" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-lg">
                        <div class="modal-content shadow-lg">
                        <div class="modal-header bg-dark text-white">
                            <h5 class="modal-title">üìë –†–µ–π—Å ‚Ññ{{ entry.document_number }}</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä–∏—Ç–∏"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <p><strong>üìÑ ‚Ññ –¥–æ–∫—É–º–µ–Ω—Ç–∞:</strong> {{ entry.document_number }}</p>
                                    <p><strong>üìÖ –î–∞—Ç–∞ —ñ —á–∞—Å:</strong> {{ entry.date_time|date:"d.m.Y H:i" }}</p>
                                    <p><strong>üè¢ –í—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫:</strong> {{ entry.sender }}</p>
                                    <p><strong>üè¨ –û—Ç—Ä–∏–º—É–≤–∞—á:</strong> {{ entry.receiver }}</p>
                                    <p><strong>üìç –ú—ñ—Å—Ü–µ —Ä–æ–∑–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è:</strong> {{ entry.unloading_place }}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>üöõ –ê–≤—Ç–æ–º–æ–±—ñ–ª—å:</strong> {{ entry.car }}</p>
                                    <p><strong>üöö –ü—Ä–∏—á—ñ–ø:</strong> {{ entry.trailer|default:"‚Äî" }}</p>
                                    <p><strong>üë®‚Äç‚úàÔ∏è –í–æ–¥—ñ–π:</strong> {{ entry.driver }}</p>
                                    <p><strong>üåæ –ö—É–ª—å—Ç—É—Ä–∞:</strong> {{ entry.culture }}</p>
                                    <p><strong>üìù –ü—Ä–∏–º—ñ—Ç–∫–∞:</strong> {{ entry.note|default:"‚Äî" }}</p>
                                </div>
                            </div>
                            <hr>
                            <!-- –í–∞–≥–æ–≤—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ -->
                            <div class="row text-center">
                                <div class="col">
                                    <div class="p-3 bg-light rounded shadow-sm">
                                        <strong>‚öñÔ∏è –í–∞–≥–∞ –±—Ä—É—Ç—Ç–æ</strong><br>{{ entry.weight_gross }} –∫–≥
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="p-3 bg-light rounded shadow-sm">
                                        <strong>‚öñÔ∏è –í–∞–≥–∞ —Ç–∞—Ä–∏</strong><br>{{ entry.weight_tare }} –∫–≥
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="p-3 bg-success text-white rounded shadow-sm">
                                        <strong>‚úÖ –í–∞–≥–∞ –Ω–µ—Ç—Ç–æ</strong><br>{{ entry.weight_net }} –∫–≥
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä–∏—Ç–∏</button>
                        </div>
                    </div>
                </div>
                </div>
                {% empty %}
                    <tr><td colspan="12" class="text-center">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- –ì—Ä–∞—Ñ—ñ–∫–∏ -->
    <div class="row mt-5 g-4">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">üìä –†–æ–∑–ø–æ–¥—ñ–ª –ø–æ –∫—É–ª—å—Ç—É—Ä–∞—Ö</div>
                <div class="card-body">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">ü•ß –ß–∞—Å—Ç–∫–∏ –∫—É–ª—å—Ç—É—Ä</div>
                <div class="card-body">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const colors = [
        'rgba(255, 99, 132, 0.6)',
        'rgba(54, 162, 235, 0.6)',
        'rgba(255, 206, 86, 0.6)',
        'rgba(75, 192, 192, 0.6)',
        'rgba(153, 102, 255, 0.6)',
        'rgba(255, 159, 64, 0.6)',
    ];

    const labels = {{ culture_labels|safe }};
    const values = {{ culture_values|safe }};

    new Chart(document.getElementById('barChart'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '–í–∞–≥–∞ –Ω–µ—Ç—Ç–æ (–∫–≥)',
                data: values,
                backgroundColor: colors,
            }]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: { enabled: true },
                legend: { display: false }
            },
            animation: { duration: 1200, easing: 'easeOutBounce' }
        }
    });

    new Chart(document.getElementById('pieChart'), {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: colors,
                hoverOffset: 15
            }]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(ctx) {
                            let label = ctx.label || '';
                            let value = ctx.raw || 0;
                            return `${label}: ${value} –∫–≥`;
                        }
                    }
                },
                legend: {
                    position: 'bottom',
                    labels: { usePointStyle: true }
                }
            }
        }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
