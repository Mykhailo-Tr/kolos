{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <h3 class="mb-3">
        {% if view.object %}
            ‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è: {{ view.object }}
        {% else %}
            {% if action_type == 'utilization' %}
                ‚ôªÔ∏è –£—Ç–∏–ª—ñ–∑–∞—Ü—ñ—è –≤—ñ–¥—Ö–æ–¥—ñ–≤ –∑ <span class="text-primary">{{ balance.place.name }}</span>
            {% else %}
                ‚ôªÔ∏è –ü–µ—Ä–µ—Ä–æ–±–∫–∞ –≤—ñ–¥—Ö–æ–¥—ñ–≤ –∑ <span class="text-primary">{{ balance.place.name }}</span>
            {% endif %}
        {% endif %}
    </h3>

<div class="alert alert-info shadow-sm p-3" style="font-size: 1.05rem;">
    <h5 class="fw-bold mb-3" style="font-size: 1.2rem;">
        üì¶ –î–æ—Å—Ç—É–ø–Ω—ñ –∑–∞–ª–∏—à–∫–∏
    </h5>

    <div class="mb-2">
        <strong class="fw-semibold">–ú—ñ—Å—Ü–µ:</strong>
        <span class="ms-1">{{ balance.place.name }}</span>
    </div>

    <div class="mb-2">
        <strong class="fw-semibold">–ö—É–ª—å—Ç—É—Ä–∞:</strong>
        <span class="ms-1">{{ balance.culture.name }}</span>
    </div>

    <div class="mb-2">
        <strong class="fw-semibold">–î–æ—Å—Ç—É–ø–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å:</strong>
        <span class="ms-2 text-primary fw-bold" style="font-size: 1.25rem;">
            {{ balance.quantity }} —Ç
        </span>
    </div>

    {% if action_type == "recycling" %}
        <hr>
        <div class="mt-2 text-muted" style="font-size: 0.95rem;">
            –ü—ñ—Å–ª—è –ø–µ—Ä–µ—Ä–æ–±–∫–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≤—ñ–¥—Ö–æ–¥—ñ–≤ –±—É–¥–µ —Å–ø–∏—Å–∞–Ω–æ,
            –∞ —Å–∫–ª–∞–¥ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –æ—Ç—Ä–∏–º–∞—î –≤–∏—Ö—ñ–¥–Ω–∏–π –ø—Ä–æ–¥—É–∫—Ç.
        </div>
    {% endif %}
</div>

    <form method="post" novalidate>
        {% csrf_token %}

        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                    <div>{{ error }}</div>
                {% endfor %}
            </div>
        {% endif %}

        <div class="row g-3">
            {% for field in form.visible_fields %}
                
                {% if field.name == 'quantity' %}
                    {% with quantity_field=field unit_field=form.input_unit %}
                        <div class="col-md-6">
                            <div class="mb-3" id="field-group-quantity">
                                <label for="{{ quantity_field.id_for_label }}" class="form-label fw-semibold">
                                    {{ quantity_field.label }}
                                    <span class="unit-label-span" data-field-name="quantity">({{ unit_field.value|default:'—Ç' }})</span>
                                    {% if quantity_field.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                
                                <div class="input-group">
                                    {{ quantity_field }}
                                    <span class="input-group-text p-0">
                                        {{ form.input_unit }}
                                    </span>
                                </div>
                                
                                <div class="form-text mt-1 conversion-display" data-field-name="quantity"></div>
                                
                                {% if quantity_field.help_text %}
                                    <div class="form-text">{{ quantity_field.help_text }}</div>
                                {% endif %}
                                {% for error in quantity_field.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endwith %}
                
                {% elif field.name == 'input_quantity' %}
                    {% with quantity_field=field unit_field=form.input_unit %}
                        <div class="col-md-6">
                            <div class="mb-3" id="field-group-input_quantity">
                                <label for="{{ quantity_field.id_for_label }}" class="form-label fw-semibold">
                                    {{ quantity_field.label }}
                                    <span class="unit-label-span" data-field-name="input_quantity">({{ unit_field.value|default:'—Ç' }})</span>
                                    {% if quantity_field.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                
                                <div class="input-group">
                                    {{ quantity_field }}
                                    <span class="input-group-text p-0">
                                        {{ form.input_unit }}
                                    </span>
                                </div>
                                
                                <div class="form-text mt-1 conversion-display" data-field-name="input_quantity"></div>
                                
                                {% if quantity_field.help_text %}
                                    <div class="form-text">{{ quantity_field.help_text }}</div>
                                {% endif %}
                                {% for error in quantity_field.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endwith %}
                
                {% elif field.name == 'output_quantity' %}
                    {% with quantity_field=field unit_field=form.output_unit %}
                        <div class="col-md-6">
                            <div class="mb-3" id="field-group-output_quantity">
                                <label for="{{ quantity_field.id_for_label }}" class="form-label fw-semibold">
                                    {{ quantity_field.label }}
                                    <span class="unit-label-span" data-field-name="output_quantity">({{ unit_field.value|default:'—Ç' }})</span>
                                    {% if quantity_field.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                
                                <div class="input-group">
                                    {{ quantity_field }}
                                    <span class="input-group-text p-0">
                                        {{ form.output_unit }}
                                    </span>
                                </div>
                                
                                <div class="form-text mt-1 conversion-display" data-field-name="output_quantity"></div>
                                
                                {% if quantity_field.help_text %}
                                    <div class="form-text">{{ quantity_field.help_text }}</div>
                                {% endif %}
                                {% for error in quantity_field.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endwith %}

                {% elif field.name != 'input_unit' and field.name != 'output_unit' %}
                    <div class="col-md-6 {% if field.name == 'note'%}col-md-12{% endif %}">
                        <div class="mb-3">
                            <label for="{{ field.id_for_label }}" class="form-label fw-semibold">
                                {{ field.label }}{% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                            </label>
                            {{ field }}
                            {% if field.help_text %}
                                <div class="form-text">{{ field.help_text }}</div>
                            {% endif %}
                            {% for error in field.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>

        <div class="mt-4 d-flex gap-2">
            <button type="submit" class="btn btn-primary">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
            <a href="{% url 'waste_list' %}" class="btn btn-secondary">‚¨Ö –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ —Å–ø–∏—Å–∫—É</a>
        </div>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è —á–∏—Å–ª–∞
            const formatNumber = (num) => {
                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —î —á–∏—Å–ª–æ —Ü—ñ–ª–∏–º (—ñ–≥–Ω–æ—Ä—É—é—á–∏ –Ω–µ–∑–Ω–∞—á–Ω—ñ –ø–æ–º–∏–ª–∫–∏ –ø–ª–∞–≤–∞—é—á–æ—ó —Ç–æ—á–∫–∏)
                if (Math.abs(num - Math.floor(num)) < 1e-9) { // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –¥–æ–ø—É—Å–∫ –¥–ª—è —Ü—ñ–ª–∏—Ö —á–∏—Å–µ–ª
                    // –Ø–∫—â–æ —Ü—ñ–ª–µ: –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ 0 –¥—Ä–æ–±—ñ–≤, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ 0 –¥—Ä–æ–±—ñ–≤
                    return num.toLocaleString('uk-UA', { 
                        minimumFractionDigits: 0, 
                        maximumFractionDigits: 0 
                    });
                } else {
                    // –Ø–∫—â–æ –¥—Ä–æ–±–æ–≤–µ: –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ 3 –¥—Ä–æ–±–∏, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ 3 –¥—Ä–æ–±–∏
                    return num.toLocaleString('uk-UA', { 
                        minimumFractionDigits: 3, 
                        maximumFractionDigits: 3 
                    });
                }
            };

            // –§—É–Ω–∫—Ü—ñ—è, —è–∫–∞ –æ–±—Ä–æ–±–ª—è—î –∫–æ–Ω–∫—Ä–µ—Ç–Ω–µ –ø–æ–ª–µ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —Ç–∞ –π–æ–≥–æ –ø–µ—Ä–µ–º–∏–∫–∞—á
            const setupUnitSwitcher = (quantityFieldSelector, unitFieldSelector) => {
                
                const quantityInput = document.querySelector(quantityFieldSelector);
                const unitSwitcher = document.querySelector(unitFieldSelector);
                
                if (!quantityInput || !unitSwitcher) return; 

                // –í–∏–∑–Ω–∞—á–∞—î–º–æ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –ø–æ–ª—è, —â–æ–± –∑–Ω–∞–π—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ –µ–ª–µ–º–µ–Ω—Ç–∏
                const fieldName = quantityInput.name; 

                const convertedValueDisplay = document.querySelector(`.conversion-display[data-field-name="${fieldName}"]`);
                const unitLabelSpan = document.querySelector(`.unit-label-span[data-field-name="${fieldName}"]`);

                const updateDisplay = () => {
                    // –ó–∞–º—ñ–Ω—é—î–º–æ –∫–æ–º—É –Ω–∞ –∫—Ä–∞–ø–∫—É –¥–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥—É
                    const value = parseFloat(quantityInput.value.replace(/,/g, '.')); 
                    const unit = unitSwitcher.value;
                    let displayHTML = '';

                    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–ø–∏—Å—É –æ–¥–∏–Ω–∏—Ü—ñ –≤ –¥—É–∂–∫–∞—Ö
                    unitLabelSpan.textContent = `(${unit})`;

                    if (!isNaN(value)) {
                        if (unit === 't') {
                            // –Ø–∫—â–æ –≤–≤–µ–¥–µ–Ω–æ —Ç–æ–Ω–Ω–∏, –ø–æ–∫–∞–∑—É—î–º–æ —Å–∫—ñ–ª—å–∫–∏ —Ü–µ –∫—ñ–ª–æ–≥—Ä–∞–º—ñ–≤ (t -> kg)
                            const kgValue = value * 1000;
                            displayHTML = `–¶–µ –ø—Ä–∏–±–ª–∏–∑–Ω–æ <strong>${formatNumber(kgValue)} –∫–≥</strong>.`;
                        } else if (unit === 'kg') {
                            // –Ø–∫—â–æ –≤–≤–µ–¥–µ–Ω–æ –∫—ñ–ª–æ–≥—Ä–∞–º–∏, –ø–æ–∫–∞–∑—É—î–º–æ —Å–∫—ñ–ª—å–∫–∏ —Ü–µ —Ç–æ–Ω–Ω (kg -> t)
                            const tValue = value / 1000;
                            displayHTML = `–¶–µ –ø—Ä–∏–±–ª–∏–∑–Ω–æ <strong>${formatNumber(tValue)} —Ç</strong>.`;
                        }
                    } else {
                        convertedValueDisplay.innerHTML = '';
                        return;
                    }

                    convertedValueDisplay.innerHTML = displayHTML;
                };

                updateDisplay(); 
                quantityInput.addEventListener('input', updateDisplay);
                unitSwitcher.addEventListener('change', updateDisplay);
            };

            // 1. –û–±—Ä–æ–±–∫–∞ –ø–æ–ª—ñ–≤ –¥–ª—è RecyclingForm
            setupUnitSwitcher('[name="input_quantity"]', '[name="input_unit"]');
            setupUnitSwitcher('[name="output_quantity"]', '[name="output_unit"]');
            
            // 2. –û–±—Ä–æ–±–∫–∞ –ø–æ–ª—è –¥–ª—è UtilizationForm
            setupUnitSwitcher('[name="quantity"]', '[name="input_unit"]');
        });
    </script>
</div>
{% endblock %}