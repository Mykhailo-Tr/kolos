<div class="journal-container mt-4">
    {# –ù–æ–≤–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–æ–∑–º—ñ—â–µ–Ω–Ω—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Ç–∞ –ø–µ—Ä–µ–º–∏–∫–∞—á–∞ –ø–æ—Ä—É—á #}
    <div class="d-flex justify-content-between align-items-center mb-3">
        
        <div class="page-header">
            <h3 class="page-title">üì¶ {{ model_name }}</h3>
        </div>

        {# –°–ï–ì–ú–ï–ù–¢–û–í–ê–ù–ò–ô –ü–ï–†–ï–ú–ò–ö–ê–ß –û–î–ò–ù–ò–¶–¨ #}
        <div class="unit-switch" id="unitSwitchContainer">
            <div class="segmented-control">
                <input type="checkbox" id="unitToggle" class="toggle-input">
                
                <label for="unitToggle" class="control-item active" data-unit="t" id="labelT">—Ç</label>
                <label for="unitToggle" class="control-item" data-unit="kg" id="labelKG">–∫–≥</label>

                <span class="toggle-slider"></span>
            </div>
        </div>
        {# –ö–Ü–ù–ï–¶–¨ –ü–ï–†–ï–ú–ò–ö–ê–ß–ê #}

    </div>

    {% if journals %}
    <div class="table-wrapper">
        <table class="journal-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>–î–∞—Ç–∞</th>
                    <th>–ö—É–ª—å—Ç—É—Ä–∞</th>
                    <th>–ú—ñ—Å—Ü–µ –∑</th>
                    <th>–ú—ñ—Å—Ü–µ –¥–æ</th>
                    <th colspan="2" id="header-weight">–í–ê–ì–ê (—Ç)</th>
                    <th>–î—ñ—è</th>
                    <th>–î—ñ—ó</th>
                </tr>
                <tr style="background-color:#e0e7ff; font-weight:600; text-transform:uppercase; font-size:0.78rem; letter-spacing:0.04em;">
                    <th colspan="5" class="border-0"></th>
                    <th class="text-start border-end-0" style="color:#1e40af;">–í—Ö—ñ–¥</th>
                    <th class="text-end border-start-0" style="color:#059669;">–í–∏—Ö—ñ–¥</th>
                    <th colspan="2" class="border-0"></th>
                </tr>
            </thead>
            <tbody>
                {% for journal in journals %}
                <tr>
                    <td class="text-center">{{ forloop.counter }}</td>
                    <td>{{ journal.date_time|date:"d.m.Y H:i" }}</td>
                    <td>–í—ñ–¥—Ö–æ–¥–∏ - {{ journal.culture }}</td>
                    <td>{{ journal.place_from }}</td>
                    <td>
                        {% if journal.place_to %}
                            {{ journal.place_to }}
                        {% else %}
                            <span class="text-muted">‚Äî</span>
                        {% endif %}
                    </td>

                    {% if journal.action == 'recycling' %}
                    <td class="text-start quantity-value text-primary" data-t="{{ journal.input_quantity|default:0 }}">
                        {{ journal.input_quantity|default:0|floatformat:3 }}
                    </td>
                    <td class="text-end quantity-value text-success" data-t="{{ journal.output_quantity|default:0 }}">
                        {{ journal.output_quantity|default:0|floatformat:3 }}
                    </td>
                    {% else %}
                    <td colspan="2" class="text-center quantity-value text-danger" data-t="{{ journal.quantity|default:0 }}">
                        {{ journal.quantity|default:0|floatformat:3 }}
                    </td>
                    {% endif %}

                    <td class="text-center">
                        {% if journal.action == 'utilization' %}
                        <span class="badge bg-danger">–£—Ç–∏–ª—ñ–∑–∞—Ü—ñ—è</span>
                        {% else %}
                        <span class="badge bg-success">–ü–µ—Ä–µ—Ä–æ–±–∫–∞</span>
                        {% endif %}
                    </td>

                    <td class="actions-cell">
                        {% if journal.action == 'utilization' %}
                        <a href="{% url 'utilization_edit' journal.id %}" class="btn-action btn-edit" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">‚úèÔ∏è</a>
                        <a href="{% url 'utilization_delete' journal.id %}" class="btn-action btn-delete" title="–í–∏–¥–∞–ª–∏—Ç–∏">üóëÔ∏è</a>
                        {% else %}
                        <a href="{% url 'recycling_edit' journal.id %}" class="btn-action btn-edit" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">‚úèÔ∏è</a>
                        <a href="{% url 'recycling_delete' journal.id %}" class="btn-action btn-delete" title="–í–∏–¥–∞–ª–∏—Ç–∏">üóëÔ∏è</a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if is_paginated %}
    <nav aria-label="–ù–∞–≤—ñ–≥–∞—Ü—ñ—è —Å—Ç–æ—Ä—ñ–Ω–∫–∞–º–∏" class="mt-3">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}">¬´</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">¬´</span></li>
            {% endif %}

            {% for i in paginator.page_range %}
            {% if page_obj.number == i %}
            <li class="page-item active"><span class="page-link">{{ i }}</span></li>
            {% else %}
            <li class="page-item"><a class="page-link" href="?page={{ i }}">{{ i }}</a></li>
            {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}">¬ª</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">¬ª</span></li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

    {% else %}
    <div class="alert-info">–ù–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤ —É –∂—É—Ä–Ω–∞–ª—ñ.</div>
    {% endif %}
</div>

<style>
/* --- –°–¢–ò–õ–Ü –°–ï–ì–ú–ï–ù–¢–û–í–ê–ù–û–ì–û –ü–ï–†–ï–ú–ò–ö–ê–ß–ê –û–î–ò–ù–ò–¶–¨ --- */
.unit-switch {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    font-family: "Inter", sans-serif;
    user-select: none;
}

.segmented-control {
    display: flex;
    background-color: #e2e8f0;
    border-radius: 10px;
    padding: 3px;
    position: relative;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
}

.control-item {
    padding: 7px 16px; 
    font-size: 0.95rem;
    font-weight: 700;
    color: #475569;
    cursor: pointer;
    z-index: 1;
    transition: color 0.3s ease;
    min-width: 45px;
    text-align: center;
    line-height: 1.2;
}

.control-item.active {
    color: #1e293b;
}

/* –ü—Ä–∏—Ö–æ–≤–∞–Ω–∏–π —á–µ–∫–±–æ–∫—Å */
.toggle-input {
    display: none;
}

/* –ü–æ–≤–∑—É–Ω–æ–∫ (—ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å—Ç–∞–Ω—É) */
.toggle-slider {
    position: absolute;
    top: 3px;
    left: 3px;
    height: calc(100% - 6px);
    width: calc(50% - 3px);
    background: #ffffff;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08); 
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 0;
}

/* –ü–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è –ø–æ–≤–∑—É–Ω–∫–∞ –Ω–∞ "–∫–≥" (–ø—Ä–∏ checked=true) */
.toggle-input:checked ~ .toggle-slider {
    transform: translateX(100%);
}

/* –î–æ–¥–∞—Ç–∫–æ–≤–∏–π –µ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ –Ω–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏–π –µ–ª–µ–º–µ–Ω—Ç */
.control-item:hover {
    color: #0f172a; 
}
.control-item.active:hover {
    color: #1e293b;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const toggle = document.getElementById("unitToggle");
    const values = document.querySelectorAll(".quantity-value"); 
    const tLabel = document.getElementById('labelT');
    const kgLabel = document.getElementById('labelKG');
    const weightHeader = document.getElementById("header-weight");
    const storageKey = 'wasteJournalUnit'; 

    /**
     * –§–æ—Ä–º–∞—Ç—É—î —á–∏—Å–ª–æ. –î–ª—è –∫–≥ –æ–∫—Ä—É–≥–ª—é—î –¥–æ —Ü—ñ–ª–æ–≥–æ —Ç–∞ –¥–æ–¥–∞—î —Ä–æ–∑–¥—ñ–ª—å–Ω–∏–∫ —Ç–∏—Å—è—á.
     */
    function formatValue(value, isTons) {
        if (value === null || value === undefined || isNaN(value)) return '‚Äî';

        if (isTons) {
            // –î–ª—è —Ç–æ–Ω–Ω: 3 –∑–Ω–∞–∫–∏ –ø—ñ—Å–ª—è –∫–æ–º–∏
            return parseFloat(value).toFixed(3);
        } else {
            // –î–ª—è –∫–≥: –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è –¥–æ —Ü—ñ–ª–æ–≥–æ, —Ä–æ–∑–¥—ñ–ª—å–Ω–∏–∫ —Ç–∏—Å—è—á (–Ω–µ—Ä–æ–∑—Ä–∏–≤–Ω–∏–π –ø—Ä–æ–±—ñ–ª)
            const kgValue = Math.round(parseFloat(value) * 1000); 
            return kgValue.toLocaleString('uk-UA', { 
                maximumFractionDigits: 0,
                minimumFractionDigits: 0
            }).replace(/\s/g, '\u00A0'); 
        }
    }

    function updateUnits() {
        const modeKG = toggle.checked; 
        const unitText = modeKG ? " (–∫–≥)" : " (—Ç)";

        // 1. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Å—Ç–æ–≤–ø—Ü—è
        if (weightHeader) {
            weightHeader.textContent = `–í–ê–ì–ê${unitText}`;
        }

        // 2. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–Ω–∞—á–µ–Ω—å
        values.forEach(v => {
            let tons = parseFloat(v.dataset.t);
            if (isNaN(tons)) tons = 0;

            v.textContent = formatValue(tons, !modeKG);
        });

        // 3. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–æ—ó –æ–¥–∏–Ω–∏—Ü—ñ (–≤—ñ–∑—É–∞–ª)
        if (modeKG) {
            tLabel.classList.remove('active');
            kgLabel.classList.add('active');
        } else {
            tLabel.classList.add('active');
            kgLabel.classList.remove('active');
        }

        // –ó–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Å—Ç–∞–Ω—É
        localStorage.setItem(storageKey, modeKG ? 'kg' : 't');
    }

    // –í–ò–ü–†–ê–í–õ–ï–ù–û: –°–ª—É—Ö–∞—î–º–æ –ø–æ–¥—ñ—é 'change' –Ω–∞ –ø—Ä–∏—Ö–æ–≤–∞–Ω–æ–º—É —á–µ–∫–±–æ–∫—Å—ñ.
    // –ö–ª—ñ–∫ –Ω–∞ –±—É–¥—å-—è–∫—É –º—ñ—Ç–∫—É (<label for="unitToggle">) –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–º—ñ–Ω—é—î —Å—Ç–∞–Ω —á–µ–∫–±–æ–∫—Å–∞,
    // —â–æ –≤–∏–∫–ª–∏–∫–∞—î —Ü—é —Ñ—É–Ω–∫—Ü—ñ—é.
    toggle.addEventListener('change', updateUnits);


    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∑ Local Storage
    const savedUnit = localStorage.getItem(storageKey);
    const initialModeKG = savedUnit === 'kg';
    
    toggle.checked = initialModeKG;
    // –û–Ω–æ–≤–ª—é—î–º–æ –æ–¥–∏–Ω–∏—Ü—ñ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ, —â–æ–± –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π —Å—Ç–∞–Ω
    updateUnits(); 
});
</script>
