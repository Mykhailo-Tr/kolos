{% extends "base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/journal.css' %}">

<style>
/* --- –°–¢–ò–õ–Ü –°–ï–ì–ú–ï–ù–¢–û–í–ê–ù–û–ì–û –ü–ï–†–ï–ú–ò–ö–ê–ß–ê –û–î–ò–ù–ò–¶–¨ (–î—É–±–ª—å–æ–≤–∞–Ω–æ –¥–ª—è —Ü—å–æ–≥–æ —Ñ–∞–π–ª—É) --- */
.unit-switch {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    font-family: "Inter", sans-serif;
    user-select: none;
}

.segmented-control {
    display: flex;
    background-color: #e2e8f0;
    border-radius: 10px;
    padding: 3px;
    position: relative;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
}

.control-item {
    padding: 7px 16px; 
    font-size: 0.95rem;
    font-weight: 700;
    color: #475569;
    cursor: pointer;
    z-index: 1;
    transition: color 0.3s ease;
    min-width: 45px;
    text-align: center;
    line-height: 1.2;
}

.control-item.active {
    color: #1e293b;
}

/* –ü—Ä–∏—Ö–æ–≤–∞–Ω–∏–π —á–µ–∫–±–æ–∫—Å */
.toggle-input {
    display: none;
}

/* –ü–æ–≤–∑—É–Ω–æ–∫ (—ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å—Ç–∞–Ω—É) */
.toggle-slider {
    position: absolute;
    top: 3px;
    left: 3px;
    height: calc(100% - 6px);
    width: calc(50% - 3px);
    background: #ffffff;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08); 
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 0;
}

/* –ü–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è –ø–æ–≤–∑—É–Ω–∫–∞ –Ω–∞ "–∫–≥" (–ø—Ä–∏ checked=true) */
.toggle-input:checked ~ .toggle-slider {
    transform: translateX(100%);
}

/* –î–æ–¥–∞—Ç–∫–æ–≤–∏–π –µ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ –Ω–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏–π –µ–ª–µ–º–µ–Ω—Ç */
.control-item:hover {
    color: #0f172a; 
}
.control-item.active:hover {
    color: #1e293b;
}
</style>

<div class="journal-container">
    {# –ù–æ–≤–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–æ–∑–º—ñ—â–µ–Ω–Ω—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Ç–∞ –ø–µ—Ä–µ–º–∏–∫–∞—á–∞ –ø–æ—Ä—É—á #}
    <div class="d-flex justify-content-between align-items-center mb-3">
        
        <div class="page-header">
            <h3 class="page-title">‚ôªÔ∏è –ó–∞–ª–∏—à–∫–∏ –≤—ñ–¥—Ö–æ–¥—ñ–≤</h3>
        </div>

        {# –°–ï–ì–ú–ï–ù–¢–û–í–ê–ù–ò–ô –ü–ï–†–ï–ú–ò–ö–ê–ß –û–î–ò–ù–ò–¶–¨ #}
        <div class="unit-switch" id="unitSwitchContainerWastes">
            <div class="segmented-control">
                {# –£–Ω—ñ–∫–∞–ª—å–Ω—ñ ID –¥–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–æ—ó —Ä–æ–±–æ—Ç–∏ —É —Ü—å–æ–º—É —à–∞–±–ª–æ–Ω—ñ #}
                <input type="checkbox" id="unitToggleWastes" class="toggle-input">
                
                <label for="unitToggleWastes" class="control-item active" data-unit="t" id="labelTWastes">—Ç</label>
                <label for="unitToggleWastes" class="control-item" data-unit="kg" id="labelKGWastes">–∫–≥</label>

                <span class="toggle-slider"></span>
            </div>
        </div>
        {# –ö–Ü–ù–ï–¶–¨ –ü–ï–†–ï–ú–ò–ö–ê–ß–ê #}

    </div>

    {% if waste_balances %}
    <div class="table-wrapper">
        <table class="journal-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>–ú—ñ—Å—Ü–µ</th>
                    <th>–ö—É–ª—å—Ç—É—Ä–∞</th>
                    <th id="header-quantity">–ö—ñ–ª—å–∫—ñ—Å—Ç—å (—Ç–æ–Ω–Ω)</th>
                    <th>–î—ñ—ó</th>
                </tr>
            </thead>
            <tbody>
                {% for item in waste_balances %}
                <tr>
                    <td class="text-center">{{ forloop.counter }}</td>
                    <td>{{ item.place.name }}</td>
                    <td>–í—ñ–¥—Ö–æ–¥–∏ - {{ item.culture.name }}</td>
                    <td class="quantity-value-wastes text-center" data-t="{{ item.quantity|default:0 }}">
                        {{ item.quantity|default:0|floatformat:3 }}
                    </td>
                    <td class="actions-cell">
                        <a href="{% url 'recycling_add' item.pk %}" class="btn-add" 
                        style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                                color: white;
                                padding: 0.4rem 0.8rem; 
                                font-size: 0.85rem;">
                            ‚ôªÔ∏è –ü–µ—Ä–µ—Ä–æ–±–∫–∞
                        </a>
                        <a href="{% url 'utilization_add' item.pk %}" class="btn-add" 
                        style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                                color: white;
                                padding: 0.4rem 0.8rem; 
                                font-size: 0.85rem;">
                            üóëÔ∏è –£—Ç–∏–ª—ñ–∑–∞—Ü—ñ—è
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center text-muted py-3">–ù–µ–º–∞—î –≤—ñ–¥—Ö–æ–¥—ñ–≤</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="alert-info">–ù–µ–º–∞—î –≤—ñ–¥—Ö–æ–¥—ñ–≤</div>
    {% endif %}

    <hr class="my-4">

    {% include "waste/list.html" %}
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // –£–Ω—ñ–∫–∞–ª—å–Ω—ñ ID –¥–ª—è —à–∞–±–ª–æ–Ω—É wastes.html
    const toggle = document.getElementById("unitToggleWastes");
    const values = document.querySelectorAll(".quantity-value-wastes");
    const tLabel = document.getElementById('labelTWastes');
    const kgLabel = document.getElementById('labelKGWastes');
    const quantityHeader = document.getElementById("header-quantity");
    const storageKey = 'wastesBalanceUnit'; 

    /**
     * –§–æ—Ä–º–∞—Ç—É—î —á–∏—Å–ª–æ. –î–ª—è –∫–≥ –æ–∫—Ä—É–≥–ª—é—î –¥–æ —Ü—ñ–ª–æ–≥–æ —Ç–∞ –¥–æ–¥–∞—î —Ä–æ–∑–¥—ñ–ª—å–Ω–∏–∫ —Ç–∏—Å—è—á.
     */
    function formatValue(value, isTons) {
        if (value === null || value === undefined || isNaN(value)) return '‚Äî';

        if (isTons) {
            // –î–ª—è —Ç–æ–Ω–Ω: 3 –∑–Ω–∞–∫–∏ –ø—ñ—Å–ª—è –∫–æ–º–∏
            return parseFloat(value).toFixed(3);
        } else {
            // –î–ª—è –∫–≥: –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è –¥–æ —Ü—ñ–ª–æ–≥–æ, —Ä–æ–∑–¥—ñ–ª—å–Ω–∏–∫ —Ç–∏—Å—è—á (–Ω–µ—Ä–æ–∑—Ä–∏–≤–Ω–∏–π –ø—Ä–æ–±—ñ–ª)
            const kgValue = Math.round(parseFloat(value) * 1000); 
            return kgValue.toLocaleString('uk-UA', { 
                maximumFractionDigits: 0,
                minimumFractionDigits: 0
            }).replace(/\s/g, '\u00A0'); 
        }
    }

    function updateUnits() {
        const modeKG = toggle.checked; 
        const unitText = modeKG ? "(–∫–≥)" : "(—Ç–æ–Ω–Ω)";

        // 1. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Å—Ç–æ–≤–ø—Ü—è
        if (quantityHeader) {
            quantityHeader.textContent = `–ö—ñ–ª—å–∫—ñ—Å—Ç—å ${unitText}`;
        }

        // 2. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–Ω–∞—á–µ–Ω—å
        values.forEach(v => {
            let tons = parseFloat(v.dataset.t);
            if (isNaN(tons)) tons = 0;

            v.textContent = formatValue(tons, !modeKG);
        });

        // 3. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–æ—ó –æ–¥–∏–Ω–∏—Ü—ñ (–≤—ñ–∑—É–∞–ª)
        if (modeKG) {
            tLabel.classList.remove('active');
            kgLabel.classList.add('active');
        } else {
            tLabel.classList.add('active');
            kgLabel.classList.remove('active');
        }

        // –ó–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Å—Ç–∞–Ω—É
        localStorage.setItem(storageKey, modeKG ? 'kg' : 't');
    }

    // –í–ò–ü–†–ê–í–õ–ï–ù–û: –°–ª—É—Ö–∞—î–º–æ –ø–æ–¥—ñ—é 'change' –Ω–∞ –ø—Ä–∏—Ö–æ–≤–∞–Ω–æ–º—É —á–µ–∫–±–æ–∫—Å—ñ.
    // –ö–ª—ñ–∫ –Ω–∞ –±—É–¥—å-—è–∫—É –º—ñ—Ç–∫—É (<label for="unitToggleWastes">) –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–º—ñ–Ω—é—î —Å—Ç–∞–Ω —á–µ–∫–±–æ–∫—Å–∞,
    // —â–æ –≤–∏–∫–ª–∏–∫–∞—î —Ü—é —Ñ—É–Ω–∫—Ü—ñ—é.
    toggle.addEventListener('change', updateUnits);

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∑ Local Storage
    const savedUnit = localStorage.getItem(storageKey);
    const initialModeKG = savedUnit === 'kg';
    
    toggle.checked = initialModeKG;
    // –û–Ω–æ–≤–ª—é—î–º–æ –æ–¥–∏–Ω–∏—Ü—ñ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ, —â–æ–± –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π —Å—Ç–∞–Ω
    updateUnits();
});
</script>
{% endblock %}